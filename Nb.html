<!D<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AddMint - Ultra Professional</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        /* CSS start here */

        /* General Body and Container Styles */
        body {
            font-family: 'Montserrat', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color-main);
            color: var(--text-color-main);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
            line-height: 1.6;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Dark Mode Variables (Default) */
        body.dark-mode {
            --bg-color-main: #1a1a2e;
            --bg-color-lighter: #16213e;
            --bg-color-darker: #0d2a4a;
            --text-color-main: #e0e0e0;
            --text-color-light: #bbb;
            --text-color-accent: #00ffff;
            --border-color-main: #0f3460;
            --shadow-color-main: rgba(0, 255, 255, 0.2);
            --shadow-color-strong: rgba(0, 255, 255, 0.4);
            --highlight-color-main: #00ffff;
            --highlight-color-secondary: #ff00ff;
            --button-primary-bg: #00ffff;
            --button-primary-text: #1a1a2e;
            --button-secondary-bg: #334e68;
            --button-secondary-text: #e0e0e0;
            --input-bg: #1a1a2e;
            --input-border: #00ffff;
            --post-card-bg: #0f3460;
            --chat-bubble-left-bg: #334e68;
            --chat-bubble-right-bg: #00ffff;
            --chat-bubble-right-text: #1a1a2e;
        }

        /* Light Mode Variables */
        body.light-mode {
            --bg-color-main: #f0f2f5;
            --bg-color-lighter: #ffffff;
            --bg-color-darker: #e0e0e0;
            --text-color-main: #333333;
            --text-color-light: #666666;
            --text-color-accent: #007bff;
            --border-color-main: #cccccc;
            --shadow-color-main: rgba(0, 0, 0, 0.1);
            --shadow-color-strong: rgba(0, 0, 0, 0.2);
            --highlight-color-main: #007bff;
            --highlight-color-secondary: #6f42c1;
            --button-primary-bg: #007bff;
            --button-primary-text: #ffffff;
            --button-secondary-bg: #e9ecef;
            --button-secondary-text: #333333;
            --input-bg: #ffffff;
            --input-border: #ced4da;
            --post-card-bg: #ffffff;
            --chat-bubble-left-bg: #e9ecef;
            --chat-bubble-right-bg: #007bff;
            --chat-bubble-right-text: #ffffff;
        }


        .app-container {
            width: 100%;
            max-width: 420px;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: var(--bg-color-lighter);
            box-shadow: 0 0 30px var(--shadow-color-main);
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            border: 1px solid var(--border-color-main);
        }

        .hidden {
            display: none !important;
        }

        #load-status {
            position:fixed; 
            top:50%; 
            left:50%; 
            transform:translate(-50%, -50%); 
            color:white; 
            background:black; 
            padding:10px; 
            z-index:9999;
            display: none;
            text-align: center;
        }

        .auth-container {
            width: 100%;
            max-width: 420px;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: var(--bg-color-lighter);
            box-shadow: 0 0 30px var(--shadow-color-main);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--border-color-main);
            padding: 20px;
            box-sizing: border-box;
            flex-direction: column;
            text-align: center;
        }
        .auth-content {
            width: 100%;
            background-color: var(--bg-color-main);
            padding: 30px 20px;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.1);
            border: 1px solid var(--border-color-main);
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .app-logo-splash {
            width: 100px;
            height: 100px;
            background: linear-gradient(45deg, var(--highlight-color-main), var(--highlight-color-secondary)); 
            border-radius: 50%;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 20px var(--shadow-color-strong), 0 0 40px rgba(255, 0, 255, 0.4);
            animation: pulse 2s infinite alternate;
        }
        .app-logo-splash::before {
            content: 'A'; 
            font-family: 'Montserrat', sans-serif;
            font-size: 60px;
            font-weight: bold;
            color: var(--button-primary-text);
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }


        .auth-screen { 
            display: none;
            width: 100%; 
            flex-direction: column; 
            align-items: center; 
        }
        .auth-screen.active {
            display: flex;
        }
        .auth-text { 
            font-size: 0.9em;
            margin-top: 15px;
            color: var(--text-color-light);
        }
        .auth-text a { 
            color: var(--highlight-color-main);
            text-decoration: none;
            font-weight: bold;
        }
        .auth-text a:hover {
            text-decoration: underline;
        }
        .status-message { 
            margin-top: 15px;
            padding: 8px 10px;
            border-radius: 5px;
            font-size: 0.9em;
            display: none;
        }
        .status-message.error { 
            background-color: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
            border: 1px solid #e74c3c;
            display: block;
        }
        .status-message.success { 
            background-color: rgba(51, 255, 87, 0.2);
            color: #33ff57;
            border: 1px solid #33ff57;
            display: block;
        }
        .status-message.info { 
            background-color: rgba(0, 255, 255, 0.1);
            color: var(--highlight-color-main);
            border: 1px solid var(--highlight-color-main);
            display: block;
        }


        /* Header */
        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background-color: var(--border-color-main);
            color: var(--text-color-main);
            border-bottom: 1px solid var(--bg-color-darker);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            z-index: 10;
        }

        .header-left, .header-right {
            display: flex;
            align-items: center;
        }

        .app-title {
            font-size: 1.5em;
            font-weight: bold;
            margin-left: 15px;
            color: var(--highlight-color-main);
            text-shadow: 0 0 5px var(--highlight-color-main);
        }

        .icon-button {
            background: none;
            border: none;
            color: var(--text-color-main);
            font-size: 1.2em;
            cursor: pointer;
            margin-left: 15px;
            transition: color 0.3s ease, transform 0.2s ease;
        }

        .icon-button:hover {
            color: var(--highlight-color-main);
            transform: scale(1.1);
        }

        .loader { 
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid var(--highlight-color-main);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        .menu-icon {
            width: 30px;
            height: 20px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            cursor: pointer;
        }

        .menu-icon .bar {
            width: 100%;
            height: 3px;
            background-color: var(--text-color-main);
            border-radius: 2px;
        }

        /* Sidebar Navigation */
        .sidebar {
            position: fixed;
            top: 0;
            left: -300px;
            width: 280px;
            height: 100%;
            background-color: var(--border-color-main);
            box-shadow: 5px 0 15px rgba(0, 0, 0, 0.5);
            z-index: 20;
            transition: left 0.3s ease-in-out;
            padding-top: 20px;
            display: flex;
            flex-direction: column;
        }

        .sidebar.open {
            left: 0;
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid var(--bg-color-darker);
            margin-bottom: 20px;
            position: relative;
        }

        .sidebar-header h3 {
            margin: 0 0 0 15px;
            color: var(--highlight-color-main);
            font-size: 1.4em;
            max-width: 150px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .sidebar-header .close-sidebar {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 2em;
            color: var(--text-color-main);
            cursor: pointer;
            line-height: 1;
        }

        .profile-avatar-small {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: var(--highlight-color-main);
            overflow: hidden;
            position: relative;
            border: 2px solid var(--highlight-color-main);
            flex-shrink: 0;
            background-size: cover;
            background-position: center;
        }
        .profile-avatar-small::before {
            content: '👤';
            font-family: 'Font Awesome 6 Free'; font-weight: 900;
            font-size: 30px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--button-primary-text);
        }
        .profile-avatar-small[style*="background-image"]::before {
            content: none;
        }

        .sidebar ul {
            list-style: none;
            padding: 0;
            margin: 0;
            flex-grow: 1;
            overflow-y: auto;
        }

        .sidebar ul li a {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: var(--text-color-main);
            text-decoration: none;
            font-size: 1.1em;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .sidebar ul li a:hover {
            background-color: var(--bg-color-main);
            color: var(--highlight-color-main);
        }
        .sidebar-footer {
            padding: 20px;
            border-top: 1px solid var(--bg-color-darker);
        }


        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
            margin-left: auto;
            flex-shrink: 0;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-switch label {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .toggle-switch label:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        .toggle-switch input:checked + label {
            background-color: var(--highlight-color-main);
        }

        .toggle-switch input:checked + label:before {
            transform: translateX(20px);
        }


        /* Main Content */
        .main-content {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
            padding-bottom: 80px;
        }

        .app-screen {
            display: none;
        }

        .app-screen.active {
            display: block;
        }

        section {
            background-color: var(--bg-color-main);
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 0 15px var(--shadow-color-main);
            border: 1px solid var(--border-color-main);
        }

        h2 {
            color: var(--highlight-color-main);
            text-shadow: 0 0 5px var(--highlight-color-main);
            border-bottom: 2px solid var(--border-color-main);
            padding-bottom: 10px;
            margin-top: 0;
            margin-bottom: 20px;
        }

        /* Category Filter */
        .category-filter {
            margin-bottom: 20px;
        }
        .category-filter select {
            width: 100%;
            padding: 10px;
            border-radius: 5px;
            background-color: var(--input-bg);
            color: var(--text-color-main);
            border: 1px solid var(--input-border);
        }

        /* Post Feed Styles */
        .posts-feed {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .post-card {
            background-color: var(--post-card-bg);
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.08);
            border: 1px solid var(--bg-color-darker);
            transition: box-shadow 0.3s ease-in-out, border-color 0.3s ease-in-out;
            position: relative;
        }

        .post-card.neon-glow {
            box-shadow: 0 0 5px var(--highlight-color-main), 0 0 15px var(--highlight-color-main), 0 0 25px var(--highlight-color-main), 0 0 35px var(--highlight-color-main);
            border-color: var(--highlight-color-main);
        }
        
        .post-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .profile-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #00ffff;
            margin-right: 10px;
            overflow: hidden;
            position: relative;
            border: 2px solid var(--highlight-color-main);
            flex-shrink: 0;
            cursor: pointer;
        }
        
        .profile-avatar.user-logo-default::before {
            content: '👤';
            font-family: 'Font Awesome 6 Free'; 
            font-weight: 900;
            font-size: 24px;
            position: absolute; 
            top: 50%; left: 50%; 
            transform: translate(-50%, -50%);
            color: var(--button-primary-text);
        }

        .profile-avatar[style*="background-image"]::before {
            content: none !important;
        }
        
        .profile-avatar.small {
            width: 30px;
            height: 30px;
            border-width: 1px;
        }

        .username {
            font-weight: bold;
            color: #fff;
            flex-grow: 1;
            cursor: pointer;
        }

        .post-options {
            position: relative;
        }

        .post-options .fa-ellipsis-v {
            cursor: pointer;
            font-size: 1.2em;
            color: #888;
        }

        .options-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background-color: var(--bg-color-lighter);
            border: 1px solid var(--border-color-main);
            border-radius: 5px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
            z-index: 5;
            min-width: 120px;
            overflow: hidden;
            display: none;
        }

        .options-dropdown span {
            display: block;
            padding: 10px 15px;
            cursor: pointer;
            color: var(--text-color-main);
            transition: background-color 0.2s ease, color 0.2s ease;
        }

        .options-dropdown span:hover {
            background-color: var(--bg-color-main);
            color: var(--highlight-color-main);
        }

        .post-content {
            margin-bottom: 10px;
            color: var(--text-color-main);
            word-wrap: break-word;
        }

        .post-content p {
            margin: 0 0 10px 0;
        }

        .post-content img, .post-content iframe {
            max-width: 100%;
            border-radius: 8px;
            margin-top: 10px;
            border: 1px solid var(--border-color-main);
        }

        .post-content a {
            color: var(--highlight-color-main);
            text-decoration: underline;
            word-break: break-all;
        }

        .post-footer {
            display: flex;
            flex-direction: column;
            gap: 10px;
            border-top: 1px solid var(--border-color-main);
            padding-top: 10px;
        }

        .post-actions {
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .action-button {
            cursor: pointer;
            display: flex;
            align-items: center;
            color: var(--text-color-light);
            transition: color 0.2s ease, transform 0.2s ease;
        }
        .action-button:hover {
            color: var(--highlight-color-main);
            transform: scale(1.1);
        }

        .action-button i {
            margin-right: 5px;
        }

        .like-button .fas.fa-heart {
            color: #ff007f;
            animation: bounceIn 0.3s ease-out;
        }
        .speak-button.active i {
            color: var(--highlight-color-main);
        }

        .post-reactions {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9em;
            color: #aaa;
        }

        .emoji-reaction-display {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .emoji-reaction-display .emoji {
            font-size: 1.2em;
            display: flex;
            align-items: center;
        }

        .emoji-reaction-display .count {
            font-size: 0.8em;
            margin-left: 2px;
            color: var(--text-color-main);
        }

        .emoji-picker {
            position: absolute;
            bottom: 45px;
            left: 10px;
            background-color: var(--bg-color-lighter);
            border: 1px solid var(--border-color-main);
            border-radius: 8px;
            padding: 8px;
            display: flex;
            gap: 10px;
            box-shadow: 0 -5px 20px var(--shadow-color-main);
            z-index: 10;
            display: none;
        }

        .emoji-option {
            font-size: 1.5em;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .emoji-option:hover {
            transform: scale(1.2);
        }
        
        /* Immersive Feed */
        #immersive-feed {
            height: calc(100vh - 160px); /* Adjust based on header/footer */
            overflow-y: scroll;
            scroll-snap-type: y mandatory;
            scroll-behavior: smooth;
        }
        #immersive-feed .post-card {
            height: 100%;
            scroll-snap-align: start;
            display: flex;
            flex-direction: column;
        }

        /* Form & Button Styles */
        .form-group {
            margin-bottom: 15px;
            width: 100%;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--text-color-main);
            text-align: left;
        }

        input[type="text"],
        input[type="email"],
        input[type="password"],
        textarea,
        select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--input-border);
            border-radius: 6px;
            background-color: var(--input-bg);
            color: var(--text-color-main);
            box-sizing: border-box;
            font-size: 1em;
            box-shadow: 0 0 8px var(--shadow-color-main);
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        input[type="text"]:focus,
        input[type="email"]:focus,
        input[type="password"]:focus,
        textarea:focus,
        select:focus {
            border-color: var(--highlight-color-secondary);
            box-shadow: 0 0 15px var(--shadow-color-strong);
            outline: none;
        }

        textarea {
            resize: vertical;
            min-height: 120px;
        }

        .btn {
            display: inline-block;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            transition: all 0.3s ease;
            text-align: center;
            text-decoration: none;
        }

        .btn.primary-btn {
            background-color: var(--button-primary-bg);
            color: var(--button-primary-text);
            box-shadow: 0 0 10px var(--shadow-color-main);
        }

        .btn.primary-btn:hover {
            background-color: #00e0e0;
            transform: translateY(-2px);
            box-shadow: 0 0 15px var(--shadow-color-strong);
        }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: translateY(0);
            box-shadow: none;
        }
        
        .btn.secondary-btn {
            background-color: var(--button-secondary-bg);
            color: var(--button-secondary-text);
            border: 1px solid var(--highlight-color-main);
        }

        .btn.secondary-btn:hover {
            background-color: #4a6684;
        }

        .btn.danger-btn {
            background-color: #e74c3c;
            color: white;
        }

        .btn.danger-btn:hover {
            background-color: #c0392b;
        }


        /* Profile Screen */
        .profile-header-area {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background-color: var(--bg-color-darker);
            border-radius: 10px;
        }

        .profile-avatar-large {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background-color: var(--highlight-color-main);
            margin: 0 auto 20px auto;
            overflow: hidden;
            position: relative;
            border: 4px solid var(--highlight-color-main);
            box-shadow: 0 0 15px var(--shadow-color-strong);
            background-size: cover;
            background-position: center;
        }
        .profile-avatar-large[style*="background-image"]::before {
            content: none !important; 
        }

        .profile-name {
            font-size: 1.2em;
            font-weight: bold;
        }
        .profile-bio {
            font-size: 0.95em;
            color: var(--text-color-light);
        }
        .profile-stats {
            display: flex;
            justify-content: center;
            gap: 25px;
            margin-top: 15px;
        }

        .profile-stats div {
            text-align: center;
        }

        .profile-stats span {
            display: block;
            font-weight: bold;
            font-size: 1.2em;
            color: var(--highlight-color-main);
        }

        .clickable-stat {
            cursor: pointer;
        }

        .profile-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
            justify-content: center;
        }

        .profile-post-tabs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        .tab-btn {
            background: none;
            border: 1px solid var(--border-color-main);
            color: var(--text-color-light);
        }
        .tab-btn.active {
            background-color: var(--highlight-color-main);
            color: var(--button-primary-text);
            border-color: var(--highlight-color-main);
        }
        
        /* Modals */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .modal-content {
            background-color: var(--bg-color-lighter);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 0 25px var(--shadow-color-strong);
            border: 1px solid var(--highlight-color-main);
            width: 90%;
            max-width: 500px;
            position: relative;
            animation: fadeInScale 0.3s ease-out;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-content h3 {
            color: var(--highlight-color-main);
            margin-top: 0;
            margin-bottom: 20px;
        }

        /* Messaging */
        .chat-item {
            display: flex;
            align-items: center;
            padding: 12px 10px;
            border-bottom: 1px solid var(--border-color-main);
            cursor: pointer;
        }
        .chat-info {
            margin-left: 10px;
            flex-grow: 1;
        }
        .chat-username {
            font-weight: bold;
        }
        .last-message {
            font-size: 0.9em;
            color: var(--text-color-light);
        }
        .chat-window-container {
            height: calc(100vh - 160px);
            display: flex;
            flex-direction: column;
        }
        .chat-header {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            background-color: var(--bg-color-darker);
        }
        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .message-bubble {
            padding: 10px 15px;
            border-radius: 18px;
            max-width: 80%;
        }
        .message-bubble.right {
            align-self: flex-end;
            background-color: var(--chat-bubble-right-bg);
            color: var(--chat-bubble-right-text);
        }
        .message-bubble.left {
            align-self: flex-start;
            background-color: var(--chat-bubble-left-bg);
            color: var(--text-color-main);
        }
        .chat-input-area {
            display: flex;
            padding: 10px 15px;
            border-top: 1px solid var(--border-color-main);
        }

        /* Search */
        .search-user-item {
             display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid var(--border-color-main);
            cursor: pointer;
        }
        .search-username {
            margin-left: 10px;
            flex-grow: 1;
        }


        /* Bottom Navigation */
        .app-bottom-nav {
            display: flex;
            justify-content: space-around;
            align-items: center;
            background-color: var(--bg-color-darker);
            border-top: 1px solid var(--border-color-main);
            padding: 10px 0;
            position: absolute;
            bottom: 0;
            width: 100%;
            z-index: 10;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: var(--text-color-light);
            font-size: 0.8em;
            transition: all 0.3s ease;
        }

        .nav-item .icon-wrapper {
            font-size: 1.4em;
            margin-bottom: 5px;
        }
        .nav-item.active {
            color: var(--highlight-color-main);
            transform: translateY(-3px);
        }

        /* Toast Notification */
        .toast-notification {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            z-index: 200;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .toast-notification.show {
            opacity: 1;
            visibility: visible;
        }
        .toast-notification.error { background-color: #e74c3c; }
        .toast-notification.success { background-color: #27ae60; }
        .toast-notification.info { background-color: #3498db; }
        
        /* Rich Text Editor Toolbar */
        .editor-toolbar {
            border: 1px solid var(--border-color-main);
            padding: 5px;
            border-bottom: none;
            border-radius: 6px 6px 0 0;
            background-color: var(--bg-color-darker);
        }
        .editor-toolbar button {
            background: none;
            border: none;
            color: var(--text-color-light);
            font-size: 1em;
            cursor: pointer;
            padding: 5px 8px;
            margin-right: 5px;
        }
        .editor-toolbar button:hover {
            color: var(--highlight-color-main);
        }
        #post-content {
            border-top-left-radius: 0;
            border-top-right-radius: 0;
        }
        
        /* Animations */
        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        @keyframes bounceIn {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.1); opacity: 1; }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); }
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            100% { transform: scale(1.05); }
        }


        /* Responsive adjustments */
        @media (max-width: 600px) {
            .app-container {
                border-radius: 0;
                box-shadow: none;
            }
            .main-content {
                padding: 10px;
            }
        }
    </style>
</head>
<body class="dark-mode"> 
    
    <p id="load-status">Loading Application...</p>

    <!-- Auth Container for Login/Register -->
    <div id="auth-container" class="auth-container hidden">
        <div class="auth-content">
            <div class="app-logo-splash"></div>
            <h1>AddMint</h1>
            <div id="login-screen" class="auth-screen active">
                <h2>Login</h2>
                <div class="form-group">
                    <input type="email" id="login-email" placeholder="Email">
                </div>
                <div class="form-group">
                    <input type="password" id="login-password" placeholder="Password">
                </div>
                <button class="btn primary-btn" id="login-btn">Login</button>
                <p class="auth-text"><a href="#" id="forgot-password-link">Forgot Password?</a></p>
                <p class="auth-text">Don't have an account? <a href="#" id="show-signup">Register</a></p>
                <p id="login-status" class="status-message"></p>
            </div>

            <div id="signup-screen" class="auth-screen">
                <h2>Register</h2>
                <div class="form-group">
                    <input type="email" id="signup-email" placeholder="Email">
                </div>
                <div class="form-group">
                    <input type="password" id="signup-password" placeholder="Password (min. 6 characters)">
                </div>
                <div class="form-group">
                    <input type="password" id="signup-confirm-password" placeholder="Confirm Password">
                </div>
                <button class="btn primary-btn" id="signup-btn">Register</button>
                <p class="auth-text">Already have an account? <a href="#" id="show-login">Login</a></p>
                <p id="signup-status" class="status-message"></p>
            </div>
        </div>
    </div>


    <!-- Password Reset Modal -->
    <div id="forgot-password-modal" class="modal hidden">
        <div class="modal-content">
            <h3>Reset Password</h3>
            <p>Enter your email to receive a password reset link.</p>
            <div class="form-group">
                <input type="email" id="reset-email" placeholder="Your email address">
            </div>
            <button class="btn primary-btn" id="send-reset-email-btn">Send Link</button>
            <p id="reset-status" class="status-message"></p>
            <button class="btn secondary-btn" id="close-reset-modal">Cancel</button>
        </div>
    </div>


    <!-- Main Application Container -->
    <div id="app-container" class="app-container hidden">

        <header class="app-header">
            <div class="header-left">
                <div class="menu-icon" id="menu-toggle">
                    <div class="bar"></div><div class="bar"></div><div class="bar"></div>
                </div>
                <div class="app-title">AddMint</div>
            </div>
            <div class="header-right">
                <div class="icon-button" id="refresh-posts-btn" title="Refresh Feed">
                    <i class="fas fa-sync-alt"></i>
                </div>
            </div>
        </header>

        <nav id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <div class="profile-avatar-small" id="sidebar-profile-avatar"></div>
                <h3 id="sidebar-username">My User</h3> 
                <div class="close-sidebar" id="close-sidebar">&times;</div>
            </div>
            <ul>
                <li><a href="#" data-screen="home"><i class="fas fa-home fa-fw"></i> Home Feed</a></li>
                <li><a href="#" data-screen="feed"><i class="fas fa-stream fa-fw"></i> Immersive Feed</a></li>
                <li><a href="#" data-screen="profile"><i class="fas fa-user-circle fa-fw"></i> My Profile</a></li>
                <li><a href="#" data-screen="upload"><i class="fas fa-plus-circle fa-fw"></i> Upload Post</a></li>
                <li><a href="#" data-screen="messages"><i class="fas fa-comments fa-fw"></i> Messages</a></li>
                <li><a href="#" data-screen="search"><i class="fas fa-search fa-fw"></i> Search</a></li>
                <li><a href="#" data-screen="monetization"><i class="fas fa-dollar-sign fa-fw"></i> Earnings</a></li>
                <li><a href="#"><i class="fas fa-wifi fa-fw"></i> Data Saver <span class="toggle-switch"><input type="checkbox" id="data-saver-checkbox"><label for="data-saver-checkbox"></label></span></a></li>
                <li><a href="#"><i class="fas fa-moon fa-fw"></i> Dark Mode <span class="toggle-switch"><input type="checkbox" id="dark-mode-checkbox" checked><label for="dark-mode-checkbox"></label></span></a></li>
                <li><a href="#" data-screen="about"><i class="fas fa-info-circle fa-fw"></i> About Us</a></li>
                <li><a href="#" data-screen="privacy"><i class="fas fa-shield-alt fa-fw"></i> Privacy Policy</a></li>
            </ul>
             <div class="sidebar-footer">
                <a href="#" id="logout-btn" class="btn danger-btn" style="width: 100%;"><i class="fas fa-sign-out-alt"></i> Logout</a>
            </div>
        </nav>

        <main class="main-content">
            <section id="home-screen" class="app-screen active">
                <h2>Recent Posts</h2>
                 <div class="category-filter">
                    <select id="post-category-filter">
                        <option value="all">All Categories</option>
                        <option value="Breaking News">Breaking News</option>
                        <option value="Trending">Trending</option>
                        <option value="Technology">Technology</option>
                        <option value="Entertainment">Entertainment</option>
                        <option value="Sports">Sports</option>
                        <option value="Lifestyle">Lifestyle</option>
                    </select>
                </div>
                <div id="posts-feed" class="posts-feed"></div>
                <div id="loading-spinner" class="loader hidden"></div>
            </section>

            <section id="feed-screen" class="app-screen">
                <h2>Immersive Feed</h2>
                <div id="immersive-feed"></div>
                <div id="feed-loading-spinner" class="loader hidden"></div>
            </section>

            <section id="profile-screen" class="app-screen">
                <div id="user-profile-display">
                    <div class="profile-header-area">
                        <div class="profile-avatar-large" id="my-profile-avatar"></div>
                        <h2 id="my-profile-username">@username</h2>
                        <p id="my-profile-name" class="profile-name"></p>
                        <p id="my-profile-bio" class="profile-bio"></p>
                        <div class="profile-stats">
                            <div><span id="my-posts-count">0</span> Posts</div>
                            <div class="clickable-stat" data-stat="followers"><span id="my-followers-count">0</span> Followers</div>
                            <div class="clickable-stat" data-stat="following"><span id="my-following-count">0</span> Following</div>
                        </div>
                        <div class="profile-actions">
                            <button class="btn primary-btn" id="edit-profile-btn"><i class="fas fa-edit"></i> Edit Profile</button>
                            <button class="btn secondary-btn hidden" id="follow-user-btn"><i class="fas fa-user-plus"></i> Follow</button>
                            <button class="btn danger-btn hidden" id="unfollow-user-btn"><i class="fas fa-user-minus"></i> Unfollow</button>
                            <button class="btn primary-btn hidden" id="message-user-btn"><i class="fas fa-paper-plane"></i> Message</button>
                        </div>
                    </div>

                    <div class="profile-posts-area">
                        <div class="profile-post-tabs">
                            <button class="btn tab-btn active" data-tab="posts">My Posts</button>
                            <button class="btn tab-btn" data-tab="reposts">My Reposts</button>
                        </div>
                        <div id="profile-posts-feed" class="posts-feed"></div>
                        <div id="profile-reposts-feed" class="posts-feed hidden"></div>
                    </div>
                </div>
            </section>

            <section id="upload-screen" class="app-screen">
                <h2>Create New Post</h2>
                <div class="form-group">
                    <label for="post-category">Category</label>
                    <select id="post-category">
                        <option value="General">General</option>
                        <option value="Breaking News">Breaking News</option>
                        <option value="Trending">Trending</option>
                        <option value="Technology">Technology</option>
                        <option value="Entertainment">Entertainment</option>
                        <option value="Sports">Sports</option>
                        <option value="Lifestyle">Lifestyle</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="post-content">Content</label>
                    <div class="editor-toolbar">
                        <button type="button" class="tool-btn" data-command="bold" title="Bold"><i class="fas fa-bold"></i></button>
                        <button type="button" class="tool-btn" data-command="italic" title="Italic"><i class="fas fa-italic"></i></button>
                        <button type="button" class="tool-btn" data-command="createLink" title="Insert Link"><i class="fas fa-link"></i></button>
                        <button type="button" class="tool-btn" data-command="insertImage" title="Insert Image"><i class="fas fa-image"></i></button>
                        <button type="button" class="tool-btn" data-command="insertYoutube" title="Insert YouTube Video"><i class="fab fa-youtube"></i></button>
                    </div>
                    <textarea id="post-content" placeholder="Share what's new... (60-10000 characters)"></textarea>
                    <small>Use toolbar or type markdown: **bold**, *italic*, [text](url), ![alt](img-url), ![youtube](yt-url)</small>
                </div>
                <div class="form-group">
                    <label>Post active for 24 hours (Free)</label>
                </div>
                <div class="form-group" style="display: flex; align-items: center;">
                    <label for="monetize-post-checkbox" style="margin-bottom: 0; margin-right: 10px;">Monetize this post?</label>
                    <div class="toggle-switch">
                        <input type="checkbox" id="monetize-post-checkbox">
                        <label for="monetize-post-checkbox"></label>
                    </div>
                </div>
                <button class="btn primary-btn" id="publish-post-btn">Publish</button>
                <p id="upload-status" class="status-message"></p>
            </section>

            <section id="messages-screen" class="app-screen">
                 <div id="message-list-container">
                    <h2>Messages</h2>
                    <ul id="recent-chats-list" class="posts-feed"></ul>
                </div>

                <div id="chat-window-container" class="chat-window-container hidden">
                    <div class="chat-header">
                        <button id="back-to-chats-btn" class="icon-button"><i class="fas fa-arrow-left"></i></button>
                        <div class="profile-avatar small" id="chat-partner-avatar"></div>
                        <span id="chat-partner-username" class="username"></span>
                    </div>
                    <div id="chat-messages" class="chat-messages"></div>
                    <div class="chat-input-area">
                        <textarea id="message-input" placeholder="Type a message..."></textarea>
                        <button id="send-message-btn" class="btn primary-btn"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
            </section>

            <section id="search-screen" class="app-screen">
                <h2>Search</h2>
                <div class="form-group" style="display:flex;">
                    <input type="text" id="search-query" placeholder="Search users or posts...">
                    <button class="btn primary-btn" id="search-btn" style="margin-left: 10px;"><i class="fas fa-search"></i></button>
                </div>
                <div id="search-results">
                    <h3>Users</h3>
                    <ul id="search-user-list"></ul>
                    <h3>Posts</h3>
                    <div id="search-post-list" class="posts-feed"></div>
                    <p id="no-search-results" class="hidden">No results found.</p>
                </div>
            </section>

            <section id="monetization-screen" class="app-screen">
                <h2>My Earnings</h2>
                <div class="info-card">
                    <h4><i class="fas fa-eye"></i> Monetized Views</h4>
                    <p>Total views from your monetized posts.</p>
                    <p style="font-size: 1.5em; font-weight: bold; color: var(--highlight-color-main);" id="total-monetized-views">0</p>
                </div>
                <div class="info-card">
                    <h4><i class="fas fa-wallet"></i> Withdraw</h4>
                    <p>You can request a withdrawal once you reach 100,000 monetized views.</p>
                    <button class="btn primary-btn" id="withdraw-btn" disabled>Request Withdrawal</button>
                </div>
            </section>

            <section id="about-screen" class="app-screen">
                <h2>About AddMint</h2>
                <p>AddMint is a revolutionary social media platform designed to connect people through shared interests and engaging content.</p>
            </section>

            <section id="privacy-screen" class="app-screen">
                <h2>Privacy Policy</h2>
                <p>Your privacy is important to us. We collect data to improve your experience...</p>
            </section>
        </main>

        <footer class="app-bottom-nav">
            <a href="#" class="nav-item active" data-screen="home"><div class="icon-wrapper"><i class="fas fa-home"></i></div><span>Home</span></a>
            <a href="#" class="nav-item" data-screen="search"><div class="icon-wrapper"><i class="fas fa-search"></i></div><span>Search</span></a>
            <a href="#" class="nav-item" data-screen="upload"><div class="icon-wrapper"><i class="fas fa-plus-circle"></i></div><span>Upload</span></a>
            <a href="#" class="nav-item" data-screen="messages"><div class="icon-wrapper"><i class="fas fa-comments"></i></div><span>Messages</span></a>
            <a href="#" class="nav-item" data-screen="profile"><div class="icon-wrapper"><i class="fas fa-user-circle"></i></div><span>Profile</span></a>
        </footer>

        <!-- Edit Profile Modal -->
        <div id="edit-profile-modal" class="modal hidden">
            <div class="modal-content">
                <h3>Edit Profile</h3>
                <div class="form-group">
                    <label for="edit-username">Username</label>
                    <input type="text" id="edit-username" placeholder="Unique username">
                    <small id="username-availability"></small>
                </div>
                <div class="form-group">
                    <label for="edit-name">Display Name</label>
                    <input type="text" id="edit-name" placeholder="Your name">
                </div>
                <div class="form-group">
                    <label for="edit-bio">Bio</label>
                    <textarea id="edit-bio" placeholder="About you..."></textarea>
                </div>
                <div class="form-group">
                    <label for="profile-pic-url-input">Profile Picture URL</label>
                    <input type="text" id="profile-pic-url-input" placeholder="https://example.com/mypic.jpg">
                    <small>Use a direct link from sites like imgbb.com</small>
                </div>
                <div class="form-group" style="display: flex; align-items: center;">
                    <label for="account-privacy-toggle" style="margin: 0 10px 0 0;">Private Account</label>
                    <div class="toggle-switch">
                        <input type="checkbox" id="account-privacy-toggle">
                        <label for="account-privacy-toggle"></label>
                    </div>
                </div>
                <p id="save-profile-status" class="status-message"></p>
                <button class="btn primary-btn" id="save-profile-btn">Save Changes</button>
                <button class="btn secondary-btn" id="cancel-edit-profile-btn">Cancel</button>
            </div>
        </div>
        
        <!-- Withdrawal Modal -->
        <div id="withdraw-modal" class="modal hidden">
            <div class="modal-content">
                <h3>Withdrawal Request</h3>
                <p>Your request will be sent to the admin for manual processing.</p>
                <div class="form-group">
                    <label>Total Monetized Views</label>
                    <input type="text" id="withdraw-views-display" readonly>
                </div>
                <div class="form-group">
                    <label for="withdraw-payment-id">PayPal Email or UPI ID</label>
                    <input type="text" id="withdraw-payment-id" placeholder="yourname@email.com or yourid@upi">
                </div>
                <p id="withdraw-status" class="status-message"></p>
                <button class="btn primary-btn" id="confirm-withdraw-btn">Send Request</button>
                <button class="btn secondary-btn" id="close-withdraw-modal">Cancel</button>
            </div>
        </div>
        
        <!-- Follower/Following List Modal -->
        <div id="follow-list-modal" class="modal hidden">
            <div class="modal-content">
                <h3 id="follow-list-title"></h3>
                <ul id="follow-list-content"></ul>
                <button class="btn secondary-btn" id="close-follow-list-modal">Close</button>
            </div>
        </div>


        <div id="toast-notification" class="toast-notification"></div>

    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script>
        /* JavaScript starts here */
        const firebaseConfig = {
            apiKey: "AIzaSyDlZA4grzF3fx95-11E4s7ASXwkIij1k1w",
            authDomain: "addmint-7ab6b.firebaseapp.com",
            databaseURL: "https://addmint-7ab6b-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "addmint-7ab6b",
            storageBucket: "addmint-7ab6b.firebasestorage.app",
            messagingSenderId: "504015450137",
            appId: "1:504015450137:web:694b176313582cce1e7a88",
            measurementId: "G-H7J7M23Z82"
        };

        // Initialize Firebase
        try {
            firebase.initializeApp(firebaseConfig);
        } catch (error) {
            console.error("Firebase initialization failed:", error);
            document.getElementById('load-status').textContent = "Critical Error: App failed to initialize.";
        }

        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- DOM Elements ---
        const loadStatusElement = document.getElementById('load-status');
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        const body = document.body;

        // Auth
        const loginScreen = document.getElementById('login-screen');
        const signupScreen = document.getElementById('signup-screen');
        const loginEmailInput = document.getElementById('login-email');
        const loginPasswordInput = document.getElementById('login-password');
        const loginBtn = document.getElementById('login-btn');
        const loginStatus = document.getElementById('login-status');
        const showSignupLink = document.getElementById('show-signup');
        const signupEmailInput = document.getElementById('signup-email');
        const signupPasswordInput = document.getElementById('signup-password');
        const signupConfirmPasswordInput = document.getElementById('signup-confirm-password');
        const signupBtn = document.getElementById('signup-btn');
        const signupStatus = document.getElementById('signup-status');
        const showLoginLink = document.getElementById('show-login');
        const forgotPasswordLink = document.getElementById('forgot-password-link');
        const forgotPasswordModal = document.getElementById('forgot-password-modal');
        const resetEmailInput = document.getElementById('reset-email');
        const sendResetEmailBtn = document.getElementById('send-reset-email-btn');
        const resetStatus = document.getElementById('reset-status');
        const closeResetModalBtn = document.getElementById('close-reset-modal');
        const logoutBtn = document.getElementById('logout-btn');

        // Main App
        const menuToggle = document.getElementById('menu-toggle');
        const sidebar = document.getElementById('sidebar');
        const closeSidebarBtn = document.getElementById('close-sidebar');
        const mainContent = document.querySelector('.main-content');
        const bottomNavItems = document.querySelectorAll('.app-bottom-nav .nav-item');
        const screenSections = document.querySelectorAll('.app-screen');
        const refreshPostsBtn = document.getElementById('refresh-posts-btn');
        const postsFeed = document.getElementById('posts-feed');
        const loadingSpinner = document.getElementById('loading-spinner');
        const postCategoryFilter = document.getElementById('post-category-filter');
        const toastNotification = document.getElementById('toast-notification');

        // Upload
        const uploadScreen = document.getElementById('upload-screen');
        const postCategorySelect = document.getElementById('post-category');
        const postContentInput = document.getElementById('post-content');
        const monetizePostCheckbox = document.getElementById('monetize-post-checkbox');
        const publishPostBtn = document.getElementById('publish-post-btn');
        const uploadStatus = document.getElementById('upload-status');
        const editorToolbar = document.querySelector('.editor-toolbar');

        // Profile
        const myProfileAvatar = document.getElementById('my-profile-avatar');
        const sidebarProfileAvatar = document.getElementById('sidebar-profile-avatar');
        const sidebarUsername = document.getElementById('sidebar-username');
        const myProfileUsername = document.getElementById('my-profile-username');
        const myProfileName = document.getElementById('my-profile-name');
        const myProfileBio = document.getElementById('my-profile-bio');
        const myPostsCount = document.getElementById('my-posts-count');
        const myFollowersCount = document.getElementById('my-followers-count');
        const myFollowingCount = document.getElementById('my-following-count');
        const editProfileBtn = document.getElementById('edit-profile-btn');
        const followUserBtn = document.getElementById('follow-user-btn');
        const unfollowUserBtn = document.getElementById('unfollow-user-btn');
        const messageUserBtn = document.getElementById('message-user-btn');
        const profilePostsFeed = document.getElementById('profile-posts-feed');
        const profileRepostsFeed = document.getElementById('profile-reposts-feed');
        const profilePostTabs = document.querySelectorAll('.profile-post-tabs .tab-btn');

        // Profile Edit Modal
        const editProfileModal = document.getElementById('edit-profile-modal');
        const editUsernameInput = document.getElementById('edit-username');
        const usernameAvailability = document.getElementById('username-availability');
        const editNameInput = document.getElementById('edit-name');
        const editBioInput = document.getElementById('edit-bio');
        const profilePicUrlInput = document.getElementById('profile-pic-url-input');
        const accountPrivacyToggle = document.getElementById('account-privacy-toggle');
        const saveProfileBtn = document.getElementById('save-profile-btn');
        const cancelEditProfileBtn = document.getElementById('cancel-edit-profile-btn');
        const saveProfileStatus = document.getElementById('save-profile-status');

        // Follow List Modal
        const followListModal = document.getElementById('follow-list-modal');
        const followListTitle = document.getElementById('follow-list-title');
        const followListContent = document.getElementById('follow-list-content');
        const closeFollowListModalBtn = document.getElementById('close-follow-list-modal');
        
        // Messaging
        const messageListContainer = document.getElementById('message-list-container');
        const recentChatsList = document.getElementById('recent-chats-list');
        const chatWindowContainer = document.getElementById('chat-window-container');
        const backToChatsBtn = document.getElementById('back-to-chats-btn');
        const chatPartnerAvatar = document.getElementById('chat-partner-avatar');
        const chatPartnerUsername = document.getElementById('chat-partner-username');
        const chatMessages = document.getElementById('chat-messages');
        const messageInput = document.getElementById('message-input');
        const sendMessageBtn = document.getElementById('send-message-btn');

        // Search
        const searchQueryInput = document.getElementById('search-query');
        const searchBtn = document.getElementById('search-btn');
        const searchUserList = document.getElementById('search-user-list');
        const searchPostList = document.getElementById('search-post-list');
        const noSearchResults = document.getElementById('no-search-results');

        // Monetization
        const totalMonetizedViewsSpan = document.getElementById('total-monetized-views');
        const withdrawBtn = document.getElementById('withdraw-btn');
        const withdrawModal = document.getElementById('withdraw-modal');
        const withdrawViewsDisplay = document.getElementById('withdraw-views-display');
        const withdrawPaymentIdInput = document.getElementById('withdraw-payment-id');
        const confirmWithdrawBtn = document.getElementById('confirm-withdraw-btn');
        const closeWithdrawModalBtn = document.getElementById('close-withdraw-modal');
        const withdrawStatus = document.getElementById('withdraw-status');

        // --- Global State ---
        let currentUser = null; 
        let currentProfileData = null;
        let currentProfileViewingId = null;
        let currentChatPartnerId = null;
        let lastVisiblePost = null; 
        let fetchingPosts = false; 
        let unsubscribeFromChat = null;
        let hasRunInitialAuthCheck = false;

        // --- Utility Functions ---

        function showToast(message, type = 'info', duration = 3000) {
            toastNotification.textContent = message;
            toastNotification.className = `toast-notification show ${type}`;
            setTimeout(() => {
                toastNotification.className = 'toast-notification';
            }, duration);
        }

        function updateStatusMessage(element, message, type) {
            element.textContent = message;
            element.className = `status-message ${type}`;
        }
        
        function formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1).replace(/\.0$/, '') + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1).replace(/\.0$/, '') + 'k';
            return num;
        }

        function showScreen(screenId) {
            screenSections.forEach(screen => screen.classList.remove('active'));
            const activeScreen = document.getElementById(`${screenId}-screen`);
            if(activeScreen) activeScreen.classList.add('active');

            bottomNavItems.forEach(item => {
                item.classList.toggle('active', item.dataset.screen === screenId);
            });
            sidebar.classList.remove('open');
            mainContent.scrollTop = 0;
        }
        
        function escapeHtml(text) {
            const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        // --- Core Auth Flow ---

        auth.onAuthStateChanged(async (user) => {
            if (hasRunInitialAuthCheck && user === auth.currentUser) return;
            hasRunInitialAuthCheck = true;
            
            loadStatusElement.style.display = 'none';

            if (user && user.emailVerified) {
                currentUser = user;
                const userDoc = await db.collection('users').doc(user.uid).get();

                if (!userDoc.exists || !userDoc.data().username) {
                    showAppContainerUI();
                    showScreen('profile');
                    editProfileModal.classList.remove('hidden');
                    updateStatusMessage(saveProfileStatus, "Welcome! Please set your username and name to continue.", 'info');
                } else {
                    currentProfileData = { uid: user.uid, ...userDoc.data() };
                    await loadAppData();
                    showAppContainerUI();
                    showScreen('home');
                }
            } else {
                currentUser = null;
                currentProfileData = null;
                showAuthContainerUI();
                if (user && !user.emailVerified) {
                    updateStatusMessage(loginStatus, "Please check your inbox to verify your email, then log in.", 'info');
                    auth.signOut();
                }
            }
        });

        async function loadAppData() {
            if (!currentProfileData) return;
            // Update sidebar
            sidebarUsername.textContent = currentProfileData.name || currentProfileData.username;
            if (currentProfileData.profilePicUrl) {
                sidebarProfileAvatar.style.backgroundImage = `url('${currentProfileData.profilePicUrl}')`;
                sidebarProfileAvatar.innerHTML = '';
            } else {
                sidebarProfileAvatar.style.backgroundImage = '';
                sidebarProfileAvatar.innerHTML = currentProfileData.username.charAt(0).toUpperCase();
            }
            // Load initial posts
            loadPosts();
        }

        function showAuthContainerUI() {
            authContainer.classList.remove('hidden');
            appContainer.classList.add('hidden');
        }

        function showAppContainerUI() {
            authContainer.classList.add('hidden');
            appContainer.classList.remove('hidden');
        }

        // --- Event Listeners (Auth) ---

        loginBtn.addEventListener('click', async () => {
            updateStatusMessage(loginStatus, "Logging in...", 'info');
            try {
                await auth.signInWithEmailAndPassword(loginEmailInput.value, loginPasswordInput.value);
                // onAuthStateChanged will handle the redirect
            } catch (error) {
                updateStatusMessage(loginStatus, error.message, 'error');
            }
        });

        signupBtn.addEventListener('click', async () => {
             if (signupPasswordInput.value !== signupConfirmPasswordInput.value) {
                updateStatusMessage(signupStatus, "Passwords do not match.", 'error');
                return;
            }
            updateStatusMessage(signupStatus, "Registering...", 'info');
            try {
                const userCredential = await auth.createUserWithEmailAndPassword(signupEmailInput.value, signupPasswordInput.value);
                await db.collection('users').doc(userCredential.user.uid).set({
                    email: userCredential.user.email,
                    uid: userCredential.user.uid,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    followers: [],
                    following: [],
                    followersCount: 0,
                    followingCount: 0,
                    postCount: 0,
                    totalMonetizedViews: 0,
                });
                await userCredential.user.sendEmailVerification();
                updateStatusMessage(signupStatus, "Registration successful! Please check your email to verify your account.", 'success');
                showLoginLink.click();
            } catch (error) {
                updateStatusMessage(signupStatus, error.message, 'error');
            }
        });

        logoutBtn.addEventListener('click', () => auth.signOut());
        
        // ... (password reset, UI toggles for login/signup)
        showSignupLink.addEventListener('click', (e) => { e.preventDefault(); loginScreen.classList.remove('active'); signupScreen.classList.add('active'); });
        showLoginLink.addEventListener('click', (e) => { e.preventDefault(); signupScreen.classList.remove('active'); loginScreen.classList.add('active'); });
        forgotPasswordLink.addEventListener('click', (e) => { e.preventDefault(); forgotPasswordModal.classList.remove('hidden'); });
        closeResetModalBtn.addEventListener('click', () => forgotPasswordModal.classList.add('hidden'));
        sendResetEmailBtn.addEventListener('click', async () => {
            try {
                await auth.sendPasswordResetEmail(resetEmailInput.value);
                updateStatusMessage(resetStatus, "Reset link sent!", "success");
            } catch(error) {
                updateStatusMessage(resetStatus, error.message, "error");
            }
        });


        // --- UI Listeners ---
        menuToggle.addEventListener('click', () => sidebar.classList.add('open'));
        closeSidebarBtn.addEventListener('click', () => sidebar.classList.remove('open'));
        
        bottomNavItems.forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                const screen = item.dataset.screen;
                if(screen) {
                     showScreen(screen);
                     if(screen === 'profile') loadUserProfile(currentUser.uid);
                     if(screen === 'home') loadPosts(true);
                     if(screen === 'messages') loadRecentChats();
                     if(screen === 'monetization') loadMonetizationPage();
                }
            });
        });
        
        sidebar.querySelectorAll('a[data-screen]').forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                const screen = item.dataset.screen;
                 if(screen) {
                     showScreen(screen);
                     if(screen === 'profile') loadUserProfile(currentUser.uid);
                     if(screen === 'home') loadPosts(true);
                     if(screen === 'messages') loadRecentChats();
                     if(screen === 'monetization') loadMonetizationPage();
                }
            });
        });

        // --- Post Loading & Rendering ---
        
        async function loadPosts(refresh = false) {
            if (fetchingPosts) return;
            fetchingPosts = true;
            loadingSpinner.classList.remove('hidden');

            if (refresh) {
                postsFeed.innerHTML = '';
                lastVisiblePost = null;
            }

            try {
                let query = db.collection('posts')
                              .orderBy('timestamp', 'desc');
                
                if (postCategoryFilter.value !== 'all') {
                    query = query.where('category', '==', postCategoryFilter.value);
                }
                
                if (lastVisiblePost) {
                    query = query.startAfter(lastVisiblePost);
                }
                
                const snapshot = await query.limit(10).get();

                if (snapshot.empty && postsFeed.innerHTML === '') {
                    postsFeed.innerHTML = '<p style="text-align:center; color: var(--text-color-light);">No posts found.</p>';
                }

                for (const doc of snapshot.docs) {
                    const postData = { id: doc.id, ...doc.data() };
                    const postElement = await createPostElement(postData);
                    postsFeed.appendChild(postElement);
                }

                if (!snapshot.empty) {
                    lastVisiblePost = snapshot.docs[snapshot.docs.length - 1];
                }

            } catch (error) {
                console.error("Error loading posts:", error);
                showToast("Failed to load posts.", 'error');
            } finally {
                fetchingPosts = false;
                loadingSpinner.classList.add('hidden');
            }
        }

        mainContent.addEventListener('scroll', () => {
            if (mainContent.scrollTop + mainContent.clientHeight >= mainContent.scrollHeight - 100) {
                if (document.getElementById('home-screen').classList.contains('active')) {
                    loadPosts();
                }
            }
        });

        refreshPostsBtn.addEventListener('click', () => loadPosts(true));
        postCategoryFilter.addEventListener('change', () => loadPosts(true));

        async function createPostElement(postData) {
            const postCard = document.createElement('div');
            postCard.className = 'post-card';
            postCard.dataset.postId = postData.id;

            const postUserDoc = await db.collection('users').doc(postData.userId).get();
            const postUserData = postUserDoc.exists ? postUserDoc.data() : { username: 'unknown', profilePicUrl: '' };

            const isOwner = currentUser && postData.userId === currentUser.uid;
            
            let avatarHtml;
            if (postUserData.profilePicUrl) {
                avatarHtml = `<div class="profile-avatar" style="background-image: url('${postUserData.profilePicUrl}')"></div>`;
            } else {
                avatarHtml = `<div class="profile-avatar">${postUserData.username.charAt(0).toUpperCase()}</div>`;
            }

            postCard.innerHTML = `
                <div class="post-header">
                    ${avatarHtml}
                    <span class="username">@${postUserData.username}</span>
                    <div class="post-options">
                        <i class="fas fa-ellipsis-v"></i>
                        <div class="options-dropdown">
                            ${isOwner ? '<span class="delete-btn">Delete</span>' : '<span class="report-btn">Report</span>'}
                            <span class="repost-btn">Repost</span>
                        </div>
                    </div>
                </div>
                <div class="post-content">
                    ${formatPostContentToHtml(postData.content)}
                </div>
                <div class="post-footer">
                    <div class="post-actions">
                        <span class="action-button like-button"><i class="far fa-heart"></i> <span class="count">${formatNumber(postData.likesCount || 0)}</span></span>
                        <span class="action-button comment-button"><i class="far fa-comment"></i> <span class="count">0</span></span>
                        <span class="action-button view-count"><i class="fas fa-eye"></i> <span class="count">${formatNumber(postData.views || 0)}</span></span>
                        <span class="action-button speak-button" title="Read Aloud"><i class="fas fa-volume-up"></i></span>
                        <span class="action-button translate-button" title="Translate"><i class="fas fa-language"></i></span>
                    </div>
                    <div class="post-reactions"></div>
                </div>
                <div class="emoji-picker">
                    <span class="emoji-option">👍</span><span class="emoji-option">❤️</span><span class="emoji-option">😂</span><span class="emoji-option">😮</span><span class="emoji-option">😢</span><span class="emoji-option">🔥</span>
                </div>
            `;
            
            // Add event listeners
            postCard.querySelector('.username').addEventListener('click', () => loadUserProfile(postData.userId));
            postCard.querySelector('.profile-avatar').addEventListener('click', () => loadUserProfile(postData.userId));
            // Add other listeners...
            
            return postCard;
        }
        
        function formatPostContentToHtml(markdown) {
            let html = escapeHtml(markdown);
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                       .replace(/\*(.*?)\*/g, '<em>$1</em>')
                       .replace(/!\[youtube\]\((https?:\/\/(?:www\.)?youtube\.com\/watch\?v=([a-zA-Z0-9_-]+))\)/g, '<iframe width="100%" height="200" src="https://www.youtube.com/embed/$2" frameborder="0" allowfullscreen></iframe>')
                       .replace(/!\[(.*?)\]\((https?:\/\/[^\s]+)\)/g, '<img src="$2" alt="$1" style="max-width:100%; border-radius:8px;">')
                       .replace(/\[(.*?)\]\((https?:\/\/[^\s]+)\)/g, '<a href="$2" target="_blank">$1</a>');
            return html;
        }

        // --- Post Upload ---
        publishPostBtn.addEventListener('click', async () => {
             if (postContentInput.value.length < 60 || postContentInput.value.length > 10000) {
                showToast("Content must be between 60 and 10,000 characters.", "error");
                return;
            }
            publishPostBtn.disabled = true;
            updateStatusMessage(uploadStatus, "Publishing...", "info");
            
            try {
                await db.collection('posts').add({
                    userId: currentUser.uid,
                    content: postContentInput.value,
                    category: postCategorySelect.value,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    likesCount: 0,
                    views: 0,
                    isMonetized: monetizePostCheckbox.checked,
                });
                await db.collection('users').doc(currentUser.uid).update({
                    postCount: firebase.firestore.FieldValue.increment(1)
                });
                
                updateStatusMessage(uploadStatus, "Post published successfully!", "success");
                postContentInput.value = '';
                monetizePostCheckbox.checked = false;
                setTimeout(() => showScreen('home'), 1000);

            } catch(error) {
                updateStatusMessage(uploadStatus, error.message, "error");
            } finally {
                publishPostBtn.disabled = false;
            }
        });
        
        // Rich Text Editor Toolbar Logic
        editorToolbar.querySelectorAll('.tool-btn').forEach(button => {
            button.addEventListener('click', () => {
                const command = button.dataset.command;
                let markdown = '';
                switch(command) {
                    case 'bold':
                        markdown = '****';
                        break;
                    case 'italic':
                        markdown = '**';
                        break;
                    case 'createLink':
                        const url = prompt("Enter the URL:");
                        if(url) markdown = `[link text](${url})`;
                        break;
                    case 'insertImage':
                        const imgUrl = prompt("Enter the direct image URL:");
                        if(imgUrl) markdown = `![alt text](${imgUrl})`;
                        break;
                    case 'insertYoutube':
                         const ytUrl = prompt("Enter the YouTube video URL:");
                        if(ytUrl) markdown = `![youtube](${ytUrl})`;
                        break;
                }
                const start = postContentInput.selectionStart;
                const end = postContentInput.selectionEnd;
                postContentInput.value = postContentInput.value.substring(0, start) + markdown + postContentInput.value.substring(end);
                postContentInput.focus();
            });
        });

        // --- Profile Management ---
        async function loadUserProfile(userId) {
            currentProfileViewingId = userId;
            showScreen('profile');
            try {
                const userDoc = await db.collection('users').doc(userId).get();
                if (!userDoc.exists) {
                    showToast("User not found", 'error');
                    return;
                }
                const userData = userDoc.data();
                
                myProfileUsername.textContent = `@${userData.username}`;
                myProfileName.textContent = userData.name || '';
                myProfileBio.textContent = userData.bio || 'No bio yet.';
                myPostsCount.textContent = formatNumber(userData.postCount || 0);
                myFollowersCount.textContent = formatNumber(userData.followersCount || 0);
                myFollowingCount.textContent = formatNumber(userData.followingCount || 0);

                if (userData.profilePicUrl) {
                    myProfileAvatar.style.backgroundImage = `url('${userData.profilePicUrl}')`;
                    myProfileAvatar.innerHTML = '';
                } else {
                    myProfileAvatar.style.backgroundImage = '';
                    myProfileAvatar.innerHTML = userData.username.charAt(0).toUpperCase();
                }

                if (userId === currentUser.uid) {
                    // It's my profile
                    editProfileBtn.classList.remove('hidden');
                    followUserBtn.classList.add('hidden');
                    unfollowUserBtn.classList.add('hidden');
                    messageUserBtn.classList.add('hidden');
                } else {
                    // Viewing someone else's profile
                    editProfileBtn.classList.add('hidden');
                    messageUserBtn.classList.remove('hidden');
                    // Check follow status
                    const isFollowing = currentProfileData.following.includes(userId);
                    followUserBtn.classList.toggle('hidden', isFollowing);
                    unfollowUserBtn.classList.toggle('hidden', !isFollowing);
                }
                
                loadProfilePosts(userId);

            } catch (error) {
                console.error("Error loading profile:", error);
            }
        }
        
        async function loadProfilePosts(userId) {
            profilePostsFeed.innerHTML = '<div class="loader"></div>';
            try {
                const snapshot = await db.collection('posts').where('userId', '==', userId).orderBy('timestamp', 'desc').get();
                profilePostsFeed.innerHTML = '';
                if(snapshot.empty) {
                    profilePostsFeed.innerHTML = '<p style="text-align:center;">No posts yet.</p>';
                    return;
                }
                for (const doc of snapshot.docs) {
                     const postElement = await createPostElement({ id: doc.id, ...doc.data() });
                     profilePostsFeed.appendChild(postElement);
                }
            } catch(error) {
                console.error("Error loading profile posts:", error);
                 profilePostsFeed.innerHTML = '<p style="text-align:center; color:red;">Could not load posts.</p>';
            }
        }
        
        editProfileBtn.addEventListener('click', () => {
            const user = currentProfileData;
            editUsernameInput.value = user.username || '';
            editNameInput.value = user.name || '';
            editBioInput.value = user.bio || '';
            profilePicUrlInput.value = user.profilePicUrl || '';
            accountPrivacyToggle.checked = user.isPrivate || false;
            editProfileModal.classList.remove('hidden');
        });

        cancelEditProfileBtn.addEventListener('click', () => editProfileModal.classList.add('hidden'));

        saveProfileBtn.addEventListener('click', async () => {
            saveProfileBtn.disabled = true;
            updateStatusMessage(saveProfileStatus, 'Saving...', 'info');
            
            const newUsername = editUsernameInput.value.trim();
            // Add username validation logic here...

            try {
                await db.collection('users').doc(currentUser.uid).update({
                    username: newUsername,
                    name: editNameInput.value.trim(),
                    bio: editBioInput.value.trim(),
                    profilePicUrl: profilePicUrlInput.value.trim(),
                    isPrivate: accountPrivacyToggle.checked,
                });
                updateStatusMessage(saveProfileStatus, 'Profile updated!', 'success');
                await loadUserProfile(currentUser.uid); // Reload profile
                setTimeout(() => editProfileModal.classList.add('hidden'), 1000);
            } catch (error) {
                updateStatusMessage(saveProfileStatus, error.message, 'error');
            } finally {
                saveProfileBtn.disabled = false;
            }
        });

        // --- Monetization and Withdrawal ---
        async function loadMonetizationPage() {
             try {
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                const totalViews = userDoc.data().totalMonetizedViews || 0;
                totalMonetizedViewsSpan.textContent = formatNumber(totalViews);
                withdrawBtn.disabled = totalViews < 100000;
             } catch(error) {
                console.error("Error loading monetization data:", error);
             }
        }
        
        withdrawBtn.addEventListener('click', () => {
            withdrawViewsDisplay.value = totalMonetizedViewsSpan.textContent;
            withdrawModal.classList.remove('hidden');
        });
        
        closeWithdrawModalBtn.addEventListener('click', () => withdrawModal.classList.add('hidden'));

        confirmWithdrawBtn.addEventListener('click', async () => {
            const paymentId = withdrawPaymentIdInput.value.trim();
            if(!paymentId) {
                updateStatusMessage(withdrawStatus, 'Payment ID cannot be empty.', 'error');
                return;
            }
            
            updateStatusMessage(withdrawStatus, 'Submitting request...', 'info');
            confirmWithdrawBtn.disabled = true;

            // SIMULATION: In a real app, this would call a Cloud Function
            // that securely handles the request and sends an email.
            console.log("--- WITHDRAWAL REQUEST (SIMULATED) ---");
            console.log("User:", currentUser.uid);
            console.log("Username:", currentProfileData.username);
            console.log("Views:", withdrawViewsDisplay.value);
            console.log("Payment ID:", paymentId);
            console.log("Email to Admin: apknixy@gmail.com");
            console.log("--------------------------------------");

            // Simulate backend processing
            setTimeout(async () => {
                try {
                    // Reset user's monetized views after successful request
                    await db.collection('users').doc(currentUser.uid).update({
                        totalMonetizedViews: 0
                    });
                    updateStatusMessage(withdrawStatus, 'Request sent! Payment will be processed in 1-20 business days.', 'success');
                    loadMonetizationPage(); // Refresh the page data
                    setTimeout(() => {
                        withdrawModal.classList.add('hidden');
                        updateStatusMessage(withdrawStatus, '', 'info'); // Clear status for next time
                    }, 2000);
                } catch (error) {
                    updateStatusMessage(withdrawStatus, 'Failed to reset views. Please contact support.', 'error');
                } finally {
                     confirmWithdrawBtn.disabled = false;
                }
            }, 1500);
        });

    </script>
</body>
</html>
