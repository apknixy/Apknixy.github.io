<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>AddMint ‚Äî mobile social (single file)</title>
<!-- Minimal favicon using CSS logo (you asked not to use image logos) -->
<style>
  :root{
    --bg-color-main:#1a1a2e;
    --bg-color-lighter:#16213e;
    --bg-color-darker:#0d2a4a;
    --text-color-main:#e0e0e0;
    --text-color-light:#bbb;
    --border-color-main:#0f3460;
    --highlight-color-main:#00ffff;
    --highlight-color-secondary:#ff00ff;
    --button-primary-bg:#00ffff;
    --button-primary-text:#1a1a2e;
    --max-width:420px;
  }
  html,body{
    margin:0;padding:0;height:100%;background:var(--bg-color-main);color:var(--text-color-main);
    font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
  }
  .app {
    max-width:var(--max-width);margin:0 auto;min-height:100vh;display:flex;flex-direction:column;
    border-left:1px solid rgba(255,255,255,0.02);border-right:1px solid rgba(255,255,255,0.02);
  }

  /* Header */
  header.app-header{
    position:fixed;left:0;right:0;top:0;height:60px;background:linear-gradient(180deg,var(--bg-color-darker),transparent);
    display:flex;align-items:center;justify-content:space-between;padding:10px 14px;z-index:50;border-bottom:1px solid rgba(255,255,255,0.03);
  }
  .logo {
    display:flex;align-items:center;gap:10px;
    font-weight:700;letter-spacing:0.6px;font-size:18px;
  }
  .logo .logo-mark{
    width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;
    background:conic-gradient(from 90deg,var(--highlight-color-main),var(--highlight-color-secondary));color:var(--button-primary-text);
    font-weight:800;font-size:16px;
  }
  .header-actions{display:flex;gap:10px;align-items:center;}
  .btn {
    background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px 10px;border-radius:10px;color:var(--text-color-main);font-size:14px;
  }
  .btn.primary{background:var(--button-primary-bg);color:var(--button-primary-text);border:none}
  /* Content container (space for header & footer) */
  main.app-main{padding-top:74px;padding-bottom:74px;flex:1;overflow:auto;}
  .center-wrap{max-width:420px;margin:0 auto;padding:0 12px;}

  /* Footer navigation */
  footer.app-footer{
    position:fixed;left:0;right:0;bottom:0;height:60px;background:linear-gradient(0deg,var(--bg-color-darker),transparent);
    display:flex;align-items:center;justify-content:space-around;padding:8px 12px;z-index:50;border-top:1px solid rgba(255,255,255,0.03);
  }
  .nav-item{display:flex;flex-direction:column;align-items:center;font-size:11px;color:var(--text-color-light)}
  .nav-item button{background:none;border:none;color:inherit;font:inherit}

  /* Auth container */
  #auth-container{display:none;padding:20px;}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:14px;padding:16px;margin-bottom:12px;border:1px solid rgba(255,255,255,0.03)}
  label{display:block;font-size:13px;margin-bottom:6px;color:var(--text-color-light)}
  input[type="text"],input[type="email"],input[type="password"],textarea{
    width:100%;box-sizing:border-box;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);
    background:transparent;color:var(--text-color-main);outline:none;font-size:14px;
  }
  .form-row{margin-bottom:12px}
  .muted{color:var(--text-color-light);font-size:13px}

  /* Post card */
  .post-card{background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.01));border-radius:12px;padding:12px;margin-bottom:12px;border:1px solid rgba(255,255,255,0.03)}
  .post-header{display:flex;align-items:center;gap:10px;margin-bottom:8px}
  .avatar{width:44px;height:44px;border-radius:10px;background:linear-gradient(180deg,var(--bg-color-lighter),var(--bg-color-darker));display:flex;align-items:center;justify-content:center;font-weight:700}
  .username{font-weight:700}
  .post-content{font-size:14px;color:var(--text-color-main);margin-bottom:8px;white-space:pre-wrap}
  .post-actions{display:flex;gap:14px;align-items:center;color:var(--text-color-light);font-size:13px}
  .icon-btn{border:none;background:none;display:flex;gap:8px;align-items:center;cursor:pointer;color:inherit}
  .count{font-size:12px;color:var(--text-color-light)}

  /* Modal full screen */
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:80}
  .modal{width:100%;max-width:420px;background:var(--bg-color-lighter);border-radius:12px;padding:14px;margin:12px;border:1px solid rgba(255,255,255,0.04)}
  .modal .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}

  /* Tiny loader */
  .loader{width:18px;height:18px;border-radius:50%;border:3px solid rgba(255,255,255,0.06);border-top-color:var(--highlight-color-main);animation:spin 0.9s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}

  /* Neon glow animation for double-click like */
  .neon-glow { box-shadow:0 0 10px 3px rgba(0,255,255,0.12),0 0 20px 6px rgba(255,0,255,0.04); animation:glow 700ms ease-out; }
  @keyframes glow { from {opacity:0.0; transform:scale(0.98)} to {opacity:1; transform:scale(1)} }

  /* Bounce in for like icon */
  .bounce { animation:bounceIn 420ms cubic-bezier(.2,.9,.3,1) }
  @keyframes bounceIn { 0%{transform:scale(.6)} 60%{transform:scale(1.15)} 100%{transform:scale(1)} }

  /* Responsive rules */
  @media (min-width:420px){
    .app{border-radius:10px;margin:10px auto;}
  }
  /* Loading overlay */
  #load-status{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg, rgba(0,0,0,0.6), rgba(0,0,0,0.6));z-index:200;backdrop-filter: blur(4px);display:none}
  #load-status .loader-large{width:60px;height:60px;border-radius:50%;border:6px solid rgba(255,255,255,0.02);border-top-color:var(--highlight-color-main);animation:spin 1s linear infinite}
  .muted-center{text-align:center;color:var(--text-color-light);font-size:13px;margin-top:8px}
</style>
</head>
<body>
<div class="app" id="app">
  <!-- Header -->
  <header class="app-header">
    <div class="logo">
      <div class="logo-mark">AM</div>
      <div>
        <div style="font-size:15px">AddMint</div>
        <div style="font-size:11px;color:var(--text-color-light)">Anonymous vibes ‚Ä¢ Real connections</div>
      </div>
    </div>
    <div class="header-actions">
      <button id="refresh-feed" class="btn" title="Refresh feed">‚ü≥</button>
      <button id="open-search" class="btn" title="Search">üîç</button>
    </div>
  </header>

  <!-- Main content -->
  <main class="app-main" id="main">
    <div class="center-wrap">
      <!-- AUTH UI -->
      <div id="auth-container" class="card">
        <div id="auth-forms">
          <div id="login-view">
            <h3>Login</h3>
            <div class="form-row">
              <label>Email</label><input id="login-email" type="email" placeholder="you@example.com">
            </div>
            <div class="form-row">
              <label>Password</label><input id="login-password" type="password" placeholder="6+ characters">
            </div>
            <div style="display:flex;gap:8px">
              <button id="btn-login" class="btn primary">Login</button>
              <button id="show-signup" class="btn">Sign up</button>
            </div>
            <div class="muted" style="margin-top:8px">You must verify your email to log in.</div>
          </div>

          <div id="signup-view" style="display:none">
            <h3>Sign up</h3>
            <div class="form-row">
              <label>Email</label><input id="signup-email" type="email" placeholder="you@example.com">
            </div>
            <div class="form-row">
              <label>Password</label><input id="signup-password" type="password" placeholder="6+ characters">
            </div>
            <div class="form-row">
              <label>Confirm Password</label><input id="signup-password2" type="password" placeholder="Confirm">
            </div>
            <div style="display:flex;gap:8px">
              <button id="btn-signup" class="btn primary">Create account</button>
              <button id="show-login" class="btn">Back to login</button>
            </div>
          </div>
        </div>
      </div>

      <!-- APP SCREEN: HOME FEED -->
      <div id="app-screen" style="display:none">
        <!-- Compose box -->
        <div class="card" id="compose-card">
          <div style="display:flex;gap:8px;align-items:flex-start">
            <div class="avatar" id="compose-avatar">A</div>
            <div style="flex:1">
              <textarea id="compose-text" placeholder="Share something..." rows="3" style="resize:none;border-radius:10px;padding:10px;width:100%"></textarea>
              <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
                <div><label style="font-size:12px" class="muted">Expiry: 24h ‚Ä¢ Monetize?<input type="checkbox" id="compose-monetize" style="margin-left:8px"></label></div>
                <div><button id="btn-post" class="btn primary">Post</button></div>
              </div>
            </div>
          </div>
        </div>

        <!-- feed list -->
        <div id="feed" style="margin-top:12px"></div>

        <!-- "load more" sentinel (for infinite scroll) -->
        <div id="feed-end" style="text-align:center;padding:12px;color:var(--text-color-light)"></div>
      </div>
    </div>
  </main>

  <!-- Footer nav -->
  <footer class="app-footer">
    <div class="nav-item"><button id="nav-home">üè†</button><div>Home</div></div>
    <div class="nav-item"><button id="nav-profile">üë§</button><div>Profile</div></div>
    <div class="nav-item"><button id="nav-monet">üí∞</button><div>Monetize</div></div>
    <div class="nav-item"><button id="nav-search">üîé</button><div>Search</div></div>
  </footer>
</div>

<!-- Modal backdrop -->
<div class="modal-backdrop" id="modal-backdrop">
  <div class="modal" id="modal-inner">
    <!-- content injected -->
  </div>
</div>

<!-- Loading overlay -->
<div id="load-status"><div style="text-align:center"><div class="loader-large"></div><div class="muted-center">Loading AddMint‚Ä¶</div></div></div>

<!-- Firebase SDKs (modular v9+) -->
<script type="module">
/* ==========================
   Firebase + App Logic
   ==========================
   NOTE: this is a single-file SPA. Replace firebaseConfig fields with your own if needed.
*/
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, sendEmailVerification, updateProfile } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, updateDoc, addDoc, collection, query, where, orderBy, limit, getDocs, serverTimestamp, onSnapshot, arrayUnion, arrayRemove, runTransaction, writeBatch } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDlZA4grzF3fx95-11E4s7ASXwkIij1k1w",
  authDomain: "addmint-7ab6b.firebaseapp.com",
  databaseURL: "https://addmint-7ab6b-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "addmint-7ab6b",
  storageBucket: "addmint-7ab6b.firebasestorage.app",
  messagingSenderId: "504015450137",
  appId: "1:504015450137:web:694b176313582cce1e7a88",
  measurementId: "G-H7J7M23Z82"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* ---------- UI helpers ---------- */
const $ = (id)=>document.getElementById(id);
const show = (el)=>el.style.display='';
const hide = (el)=>el.style.display='none';
const modal = {
  open(html){ $('modal-inner').innerHTML = html; show($('modal-backdrop')); },
  close(){ hide($('modal-backdrop')); $('modal-inner').innerHTML = ''; }
};
const setLoading = (v) => { if(v) show($('load-status')); else hide($('load-status')); };

/* ---------- App state ---------- */
let currentUser = null;
let userDoc = null;
let feedBatchSize = 6;
let feedLastVisible = null;
let feedAllShownOnce = false;
let feedCache = []; // local buffer for never-ending loop

/* ---------- DOM refs ---------- */
const authContainer = $('auth-container');
const appScreen = $('app-screen');
const feedEl = $('feed');
const composeAvatar = $('compose-avatar');
const composeText = $('compose-text');
const composeMonetize = $('compose-monetize');
const btnPost = $('btn-post');
const btnLogin = $('btn-login');
const btnSignup = $('btn-signup');
const showSignup = $('show-signup');
const showLogin = $('show-login');
const loginView = $('login-view');
const signupView = $('signup-view');
const refreshFeedBtn = $('refresh-feed');

/* ---------- Helpers: user doc management ---------- */
async function createUserDocument(uid, email){
  const uRef = doc(db, 'users', uid);
  const now = serverTimestamp();
  await setDoc(uRef, {
    uid,
    username: '',
    name: '',
    email,
    bio: '',
    profilePicUrl: '',
    createdAt: now,
    postCount: 0,
    totalMonetizedViews: 0,
    followers: [],
    following: [],
    followersCount: 0,
    followingCount: 0
  });
}

/* ---------- Auth flows ---------- */
showSignup.addEventListener('click', ()=>{ hide(loginView); show(signupView); });
showLogin.addEventListener('click', ()=>{ hide(signupView); show(loginView); });

btnSignup.addEventListener('click', async ()=>{
  try{
    const email = $('signup-email').value.trim();
    const pw = $('signup-password').value;
    const pw2 = $('signup-password2').value;
    if(!email || pw.length < 6){ alert('Provide valid email and password (6+ chars)'); return; }
    if(pw !== pw2){ alert('Passwords do not match'); return; }
    setLoading(true);
    const cred = await createUserWithEmailAndPassword(auth, email, pw);
    // create firestore user doc
    await createUserDocument(cred.user.uid, email);
    await sendEmailVerification(cred.user);
    alert('Account created. Verification email sent. Please verify your email then login.');
    hide(signupView); show(loginView);
  }catch(e){ console.error(e); alert('Signup error: '+e.message); }
  setLoading(false);
});

btnLogin.addEventListener('click', async ()=>{
  try{
    const email = $('login-email').value.trim();
    const pw = $('login-password').value;
    setLoading(true);
    const cred = await signInWithEmailAndPassword(auth, email, pw);
    if(!cred.user.emailVerified){
      await signOut(auth);
      alert('Email not verified. Please verify your email first.');
      setLoading(false);
      return;
    }
    // onAuthStateChanged will handle UI
  }catch(e){ console.error(e); alert('Login error: '+e.message); setLoading(false); }
});

/* ---------- onAuthStateChanged ---------- */
onAuthStateChanged(auth, async (u)=>{
  if(u){
    setLoading(true);
    currentUser = u;
    // load or create user doc
    const uRef = doc(db, 'users', u.uid);
    const snap = await getDoc(uRef);
    if(!snap.exists()){
      await createUserDocument(u.uid, u.email || '');
      userDoc = (await getDoc(uRef)).data();
    } else {
      userDoc = snap.data();
    }
    // If username empty => force edit profile (no cancel)
    if(!userDoc.username){
      // force edit profile modal
      openEditProfile(true);
    }
    // show app UI
    hide(authContainer);
    show(appScreen);
    renderComposeAvatar();
    await loadInitialFeed(true);
    setLoading(false);
  } else {
    currentUser = null;
    userDoc = null;
    // show auth UI
    show(authContainer);
    hide(appScreen);
    feedEl.innerHTML = '';
  }
});

/* ---------- Force Edit Profile (modal) ---------- */
function openEditProfile(isMandatory=false){
  const html = `
    <div class="modal-header"><strong>Edit profile</strong>${!isMandatory?'<button id="close-edit" class="btn">‚úï</button>':''}</div>
    <div>
      <label>Username (no spaces)</label>
      <input id="ep-username" type="text" placeholder="uniqueusername">
      <div id="username-check" class="muted" style="margin:6px 0"></div>
      <label>Display name</label>
      <input id="ep-name" type="text" placeholder="Your name">
      <label>Bio (max 150)</label>
      <textarea id="ep-bio" rows="3"></textarea>
      <label>Profile letter (single char shown in avatar)</label>
      <input id="ep-pic" type="text" maxlength="1" placeholder="A">
      <div style="display:flex;gap:8px;margin-top:10px">
        <button id="save-profile" class="btn primary">Save</button>
        ${isMandatory?'': '<button id="cancel-profile" class="btn">Cancel</button>'}
      </div>
    </div>
  `;
  modal.open(html);

  // prefill if exists
  setTimeout(()=> {
    $('ep-username').value = userDoc?.username || '';
    $('ep-name').value = userDoc?.name || '';
    $('ep-bio').value = userDoc?.bio || '';
    $('ep-pic').value = (userDoc?.profilePicUrl || '').slice(0,1) || '';
    // Live username check
    $('ep-username').addEventListener('input', async (e)=>{
      const v = e.target.value.trim().toLowerCase();
      if(!v) { $('username-check').textContent=''; return; }
      // check uniqueness
      const q = query(collection(db,'users'), where('username','==',v), limit(1));
      const snaps = await getDocs(q);
      if(!snaps.empty && snaps.docs[0].id !== currentUser.uid){
        $('username-check').textContent = 'Username taken';
      } else {
        $('username-check').textContent = 'Username available';
      }
    });

    $('save-profile').addEventListener('click', async ()=>{
      const username = $('ep-username').value.trim().toLowerCase();
      const name = $('ep-name').value.trim();
      const bio = $('ep-bio').value.trim().slice(0,150);
      const avatarChar = ($('ep-pic').value || name.charAt(0) || username.charAt(0) || 'A').toUpperCase();

      if(!username || username.includes(' ') || !name){
        alert('Provide a valid username (no spaces) and display name.');
        return;
      }
      setLoading(true);
      // ensure uniqueness
      const q = query(collection(db,'users'), where('username','==',username), limit(1));
      const snaps = await getDocs(q);
      if(!snaps.empty && snaps.docs[0].id !== currentUser.uid){
        setLoading(false);
        alert('Username already taken.');
        return;
      }
      // update user doc
      const uRef = doc(db,'users',currentUser.uid);
      await updateDoc(uRef, { username, name, bio, profilePicUrl: avatarChar });
      // reflect to userDoc
      userDoc = (await getDoc(uRef)).data();
      renderComposeAvatar();
      modal.close();
      setLoading(false);
    });

    if(!isMandatory){
      $('cancel-profile').addEventListener('click', ()=> modal.close());
      $('close-edit').addEventListener('click', ()=> modal.close());
    }
  },50);
}

/* ---------- Compose / Create Post ---------- */
btnPost.addEventListener('click', async ()=>{
  if(!currentUser) { alert('Login to post'); return; }
  const text = composeText.value.trim();
  if(!text) { alert('Write something'); return; }
  setLoading(true);
  try{
    // create post doc with expiry 24 hours
    const postsCol = collection(db,'posts');
    const now = serverTimestamp();
    const expiry = new Date(Date.now() + 24*60*60*1000);
    const docRef = await addDoc(postsCol, {
      userId: currentUser.uid,
      username: userDoc.username || '',
      authorAvatarUrl: userDoc.profilePicUrl || '',
      content: text,
      timestamp: now,
      isMonetized: !!composeMonetize.checked,
      expiryTime: expiry,
      likes: [],
      likesCount: 0,
      commentCount: 0,
      views: 0
    });
    // update user postCount
    const uRef = doc(db,'users',currentUser.uid);
    await updateDoc(uRef, { postCount: (userDoc.postCount||0) + 1 });
    // clear
    composeText.value='';
    // prepend to feed
    feedCache.unshift({ id: docRef.id, userId: currentUser.uid, username: userDoc.username, authorAvatarUrl:userDoc.profilePicUrl, content:text, timestamp:Date.now(), isMonetized: !!composeMonetize.checked, likesCount:0, commentCount:0, views:0});
    renderFeedItems([feedCache[0]], true);
    alert('Posted!');
  }catch(e){ console.error(e); alert('Post error: '+e.message); }
  setLoading(false);
});

/* ---------- Render composition avatar ---------- */
function renderComposeAvatar(){
  composeAvatar.textContent = (userDoc?.profilePicUrl || userDoc?.name?.charAt(0) || 'A').toUpperCase();
}

/* ---------- Feed loading & rendering ---------- */
async function loadInitialFeed(forceRefresh=false){
  // resets the feed state
  feedEl.innerHTML=''; feedCache=[]; feedLastVisible=null; feedAllShownOnce=false;
  await loadMoreFeed();
}

async function loadMoreFeed(){
  // fetch next batch; simple approach: get top recent posts
  setLoading(true);
  try{
    const q = query(collection(db,'posts'), orderBy('timestamp','desc'), limit(feedBatchSize));
    const snaps = await getDocs(q);
    const items = [];
    snaps.forEach(s => {
      items.push({ id:s.id, ...s.data() });
    });
    if(items.length === 0){
      $('feed-end').textContent = 'No posts yet';
    } else {
      feedCache.push(...items);
      renderFeedItems(items, false);
    }
  }catch(e){ console.error(e); alert('Feed load error: '+e.message) }
  setLoading(false);
}

function renderFeedItems(items, prepend=false){
  const frag = document.createDocumentFragment();
  for(const item of items){
    const node = document.createElement('div');
    node.className = 'post-card';
    node.dataset.postId = item.id;
    node.innerHTML = `
      <div class="post-header">
        <div class="avatar">${(item.authorAvatarUrl||'A').slice(0,1).toUpperCase()}</div>
        <div style="flex:1">
          <div class="username">@${(item.username||'unknown')}</div>
          <div class="muted" style="font-size:12px">${new Date(item.timestamp?.seconds?item.timestamp.seconds*1000:item.timestamp||Date.now()).toLocaleString()}</div>
        </div>
        <div>
          <button class="icon-btn post-options">‚ãØ</button>
        </div>
      </div>
      <div class="post-content">${renderContent(item.content || '')}</div>
      <div class="post-actions">
        <button class="icon-btn btn-like">‚ù§ <span class="count like-count">${item.likesCount||0}</span></button>
        <button class="icon-btn btn-comment">üí¨ <span class="count comment-count">${item.commentCount||0}</span></button>
        <button class="icon-btn btn-views">üëÅÔ∏è <span class="count view-count">${item.views||0}</span></button>
      </div>
    `;
    // double click handler for like with neon glow
    node.addEventListener('dblclick', async ()=>{
      node.classList.add('neon-glow');
      setTimeout(()=>node.classList.remove('neon-glow'),700);
      await toggleLike(item.id);
    });
    // like button
    node.querySelector('.btn-like').addEventListener('click', async (e)=>{
      e.stopPropagation();
      await toggleLike(item.id, node);
    });
    // comment button
    node.querySelector('.btn-comment').addEventListener('click', (e)=>{
      e.stopPropagation();
      openComments(item.id);
    });
    // options
    node.querySelector('.post-options').addEventListener('click', (e)=>{
      e.stopPropagation();
      openPostOptions(item);
    });

    if(prepend) feedEl.insertBefore(node, feedEl.firstChild);
    else frag.appendChild(node);
  }
  if(!prepend) feedEl.appendChild(frag);
}

function renderContent(text){
  // Very simple parser supporting **bold**, *italic*, image URLs, and youtube links
  let out = text.replace(/&/g, '&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  // bold **text**
  out = out.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
  // italics *text*
  out = out.replace(/\*(.*?)\*/g, '<em>$1</em>');
  // youtube: detect youtu.be or youtube.com/watch?v=
  out = out.replace(/https?:\/\/(www\.)?youtu\.be\/([A-Za-z0-9_-]{4,})/g, (m,p,id)=> `<div style="position:relative;padding-top:56.25%"><iframe src="https://www.youtube.com/embed/${id}" frameborder="0" allowfullscreen style="position:absolute;inset:0;width:100%;height:100%"></iframe></div>`);
  out = out.replace(/https?:\/\/(www\.)?youtube\.com\/watch\?v=([A-Za-z0-9_-]{4,})/g, (m,p,id)=> `<div style="position:relative;padding-top:56.25%"><iframe src="https://www.youtube.com/embed/${id}" frameborder="0" allowfullscreen style="position:absolute;inset:0;width:100%;height:100%"></iframe></div>`);
  // images (very naive): link ending with jpg|png|gif
  out = out.replace(/https?:\/\/\S+\.(png|jpg|jpeg|gif)/g, (m)=> `<img src="${m}" style="max-width:100%;border-radius:8px;margin-top:6px">`);
  // links
  out = out.replace(/(https?:\/\/[^\s]+)/g, (m)=> `<a href="${m}" target="_blank" rel="noopener" style="color:var(--highlight-color-main)">${m}</a>`);
  return out;
}

/* ---------- Like toggling: Firestore transaction ---------- */
async function toggleLike(postId, node){
  if(!currentUser){ alert('Login to like'); return; }
  try{
    const postRef = doc(db,'posts',postId);
    await runTransaction(db, async (t) => {
      const docSnap = await t.get(postRef);
      if(!docSnap.exists()) throw 'Post missing';
      const data = docSnap.data();
      let likes = data.likes || [];
      let likesCount = data.likesCount || 0;
      if(likes.includes(currentUser.uid)){
        // unlike
        likes = likes.filter(id=>id!==currentUser.uid);
        likesCount = Math.max(0, likesCount-1);
      } else {
        likes.push(currentUser.uid);
        likesCount = (likesCount||0)+1;
      }
      t.update(postRef, { likes, likesCount });
    });
    // update UI quickly
    if(node){
      const elCount = node.querySelector('.like-count');
      let c = parseInt(elCount.textContent||'0',10);
      // toggle visual (very naive)
      elCount.textContent = (c + (elCount.dataset.liked==='1' ? -1 : 1));
      node.querySelector('.btn-like').classList.toggle('bounce');
      setTimeout(()=>node.querySelector('.btn-like').classList.remove('bounce'),500);
    } else {
      // refresh feed
      // minimal: reload feed
      await loadInitialFeed(true);
    }
  }catch(e){ console.error(e); alert('Like error: '+e); }
}

/* ---------- Comments modal (simple) ---------- */
async function openComments(postId){
  // Show modal with comments list and textarea
  modal.open('<div class="modal-header"><strong>Comments</strong><button id="close-cmnt" class="btn">‚úï</button></div><div id="cmnt-list" style="max-height:50vh;overflow:auto"></div><div style="margin-top:8px"><textarea id="cmnt-text" rows="2" maxlength="100" placeholder="Write a comment..."></textarea><div style="display:flex;justify-content:flex-end;margin-top:6px"><button id="post-cmnt" class="btn primary">Post</button></div></div>');
  $('close-cmnt').addEventListener('click', ()=> modal.close());

  const listEl = $('cmnt-list');
  listEl.innerHTML = '<div style="text-align:center;padding:12px"><div class="loader"></div></div>';

  // load comments
  try{
    const cCol = collection(db,'posts',postId,'comments');
    const snaps = await getDocs(query(cCol, orderBy('timestamp','asc')));
    listEl.innerHTML = '';
    snaps.forEach(s=>{
      const d = s.data();
      const item = document.createElement('div');
      item.style.padding='8px';
      item.style.borderBottom='1px solid rgba(255,255,255,0.02)';
      item.innerHTML = `<div style="display:flex;gap:8px;align-items:center"><div class="avatar" style="width:36px;height:36px;border-radius:8px">${(d.userAvatarUrl||'U').slice(0,1)}</div><div><div style="font-weight:700">@${d.username}</div><div class="muted" style="font-size:12px">${new Date(d.timestamp?.seconds?d.timestamp.seconds*1000:Date.now()).toLocaleString()}</div></div></div><div style="margin-top:6px">${d.content}</div>`;
      listEl.appendChild(item);
    });
  }catch(e){ console.error(e); listEl.innerHTML = '<div class="muted">Error loading comments</div>'; }

  $('post-cmnt').addEventListener('click', async ()=>{
    const text = $('cmnt-text').value.trim();
    if(!text) return;
    if(!currentUser){ alert('Login to comment'); return; }
    setLoading(true);
    try{
      const cCol = collection(db,'posts',postId,'comments');
      await addDoc(cCol, { postId, userId: currentUser.uid, username: userDoc.username || '', userAvatarUrl: userDoc.profilePicUrl || '', content: text.slice(0,100), timestamp: serverTimestamp() });
      // update post commentCount
      const pRef = doc(db,'posts',postId);
      await updateDoc(pRef, { commentCount: ( (await (await getDoc(pRef)).data()?.commentCount) || 0 ) + 1 });
      // UI: append comment locally
      $('cmnt-text').value='';
      modal.close();
      alert('Comment posted');
    }catch(e){ console.error(e); alert('Comment error: '+e.message); }
    setLoading(false);
  });
}

/* ---------- Post options (report/delete) ---------- */
async function openPostOptions(item){
  // item: post full object
  const isOwner = currentUser && item.userId === currentUser.uid;
  const html = `<div class="modal-header"><strong>Options</strong><button id="close-opts" class="btn">‚úï</button></div>
    <div style="display:flex;flex-direction:column;gap:8px">
      ${isOwner?'<button id="delete-post" class="btn">Delete post</button>':'<button id="report-post" class="btn">Report post</button>'}
      <button id="repost" class="btn" disabled>Repost (coming soon)</button>
    </div>`;
  modal.open(html);
  $('close-opts').addEventListener('click', ()=> modal.close());
  if(isOwner){
    $('delete-post').addEventListener('click', async ()=>{
      if(!confirm('Delete this post? This removes all comments too.')) return;
      setLoading(true);
      try{
        // delete post doc and its comments (manual approach)
        const pRef = doc(db,'posts',item.id);
        // delete comments subcollection: naive approach (can't batch large sets easily here)
        const cCol = collection(db,'posts',item.id,'comments');
        const snaps = await getDocs(cCol);
        const batch = writeBatch(db);
        snaps.forEach(s=>batch.delete(s.ref));
        batch.delete(pRef);
        await batch.commit();
        // decrement user's postCount
        const uRef = doc(db,'users',currentUser.uid);
        await updateDoc(uRef, { postCount: Math.max(0,(userDoc.postCount||1)-1) });
        modal.close();
        // remove from UI
        const el = document.querySelector(`[data-post-id="${item.id}"]`);
        if(el) el.remove();
        alert('Post deleted');
      }catch(e){ console.error(e); alert('Delete error: '+e.message); }
      setLoading(false);
    });
  } else {
    $('report-post').addEventListener('click', async ()=>{
      setLoading(true);
      try{
        await addDoc(collection(db,'reports'), { postId: item.id, reportedBy: currentUser?currentUser.uid:'anonymous', timestamp: serverTimestamp() });
        alert('Reported ‚Äî thank you.');
        modal.close();
      }catch(e){ console.error(e); alert('Report error: '+e.message); }
      setLoading(false);
    });
  }
}

/* ---------- Profile screen ---------- */
$('nav-profile').addEventListener('click', async ()=>{
  if(!currentUser){ alert('Login first'); return; }
  setLoading(true);
  try{
    const uRef = doc(db,'users',currentUser.uid);
    const snap = await getDoc(uRef);
    const u = snap.data();
    const html = `<div class="modal-header"><strong>${u.name||'Profile'}</strong><button id="close-profile" class="btn">‚úï</button></div>
      <div style="display:flex;gap:10px;align-items:center">
        <div class="avatar" style="width:80px;height:80px;border-radius:12px;font-size:28px">${(u.profilePicUrl||u.name?.charAt(0)||'A').slice(0,1)}</div>
        <div>
          <div style="font-weight:800">@${u.username||'(not set)'}</div>
          <div class="muted" style="font-size:13px">${u.email}</div>
          <div style="margin-top:8px">${u.bio||''}</div>
        </div>
      </div>
      <div style="display:flex;gap:8px;margin-top:12px">
        <button id="edit-profile" class="btn primary">Edit profile</button>
        <button id="logout" class="btn">Logout</button>
      </div>
      <div style="margin-top:12px">
        <div><strong>Stats</strong></div>
        <div style="display:flex;gap:12px;margin-top:8px">
          <div><div style="font-weight:700">${u.postCount||0}</div><div class="muted">Posts</div></div>
          <div><div style="font-weight:700">${u.followersCount||0}</div><div class="muted">Followers</div></div>
          <div><div style="font-weight:700">${u.followingCount||0}</div><div class="muted">Following</div></div>
        </div>
      </div>
      <div style="margin-top:12px"><strong>Your posts</strong><div id="profile-posts" style="margin-top:8px"></div></div>
    `;
    modal.open(html);
    $('close-profile').addEventListener('click', ()=> modal.close());
    $('edit-profile').addEventListener('click', ()=> { modal.close(); openEditProfile(false); });
    $('logout').addEventListener('click', async ()=> {
      await signOut(auth);
      modal.close();
      alert('Signed out');
    });
    // load user posts (simple)
    const pQ = query(collection(db,'posts'), where('userId','==',currentUser.uid), orderBy('timestamp','desc'));
    const snaps = await getDocs(pQ);
    const postsEl = $('profile-posts');
    postsEl.innerHTML = '';
    snaps.forEach(s=>{
      const d = s.data();
      const div = document.createElement('div');
      div.className='post-card';
      div.innerHTML = `<div class="post-content">${renderContent(d.content)}</div><div class="muted">${new Date(d.timestamp?.seconds?d.timestamp.seconds*1000:Date.now()).toLocaleString()}</div>`;
      postsEl.appendChild(div);
    });
  }catch(e){ console.error(e); alert('Profile error: '+e.message); }
  setLoading(false);
});

/* ---------- Monetization screen (withdrawal request) ---------- */
$('nav-monet').addEventListener('click', async ()=>{
  if(!currentUser){ alert('Login first'); return; }
  setLoading(true);
  try{
    const uRef = doc(db,'users',currentUser.uid);
    const snap = await getDoc(uRef);
    const u = snap.data();
    const html = `<div class="modal-header"><strong>Monetization</strong><button id="close-monet" class="btn">‚úï</button></div>
      <div>
        <div class="muted">Total monetized views</div>
        <div style="font-weight:800;font-size:20px;margin-top:6px">${u.totalMonetizedViews||0}</div>
        <div class="muted" style="margin-top:8px">Minimum for withdrawal: 100,000</div>
        <div style="margin-top:12px">
          <label>PayPal Email or UPI ID</label>
          <input id="pay-id" type="text" placeholder="example@paypal.com or 9999999999@upi">
        </div>
        <div style="display:flex;gap:8px;margin-top:12px">
          <button id="request-withdraw" class="btn primary" ${ (u.totalMonetizedViews||0) < 100000 ? 'disabled' : '' }>Request withdrawal</button>
          <button id="close-monet-btn" class="btn">Close</button>
        </div>
      </div>`;
    modal.open(html);
    $('close-monet').addEventListener('click', ()=> modal.close());
    $('close-monet-btn').addEventListener('click', ()=> modal.close());
    $('request-withdraw')?.addEventListener('click', async ()=>{
      const payId = $('pay-id').value.trim();
      if(!payId){ alert('Enter PayPal email or UPI ID'); return; }
      setLoading(true);
      try{
        // create withdrawal request doc
        await addDoc(collection(db,'withdrawalRequests'), {
          userId: currentUser.uid,
          username: u.username || '',
          views: u.totalMonetizedViews || 0,
          paymentId: payId,
          timestamp: serverTimestamp(),
          emailStatus: 'pending'
        });
        // reset user's totalMonetizedViews to 0
        await updateDoc(doc(db,'users',currentUser.uid), { totalMonetizedViews: 0 });
        alert('Withdrawal requested. Admin will be notified.');
        modal.close();
      }catch(e){ console.error(e); alert('Withdrawal error: '+e.message); }
      setLoading(false);
    });

  }catch(e){ console.error(e); alert('Monetize error: '+e.message); }
  setLoading(false);
});

/* ---------- Refresh feed ---------- */
refreshFeedBtn.addEventListener('click', async ()=> { await loadInitialFeed(true); });

/* ---------- Minimal search (placeholder) ---------- */
$('nav-search').addEventListener('click', ()=> { alert('Search coming soon ‚Äî placeholder'); });

/* ---------- Start: show login screen initially ---------- */
hide(appScreen); show(authContainer);

</script>
</body>
</html>
