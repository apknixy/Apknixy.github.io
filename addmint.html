<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AddMint</title>
    <!-- Firebase SDKs - v9.6.1 compat for broader browser support -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <style>
        /* CSS Variables for Dark Theme */
        :root {
            --bg-color-main: #1a1a2e;
            --bg-color-lighter: #16213e;
            --bg-color-darker: #0d2a4a;
            --text-color-main: #e0e0e0;
            --text-color-light: #bbb;
            --border-color-main: #0f3460;
            --highlight-color-main: #00ffff; /* Cyan */
            --highlight-color-secondary: #ff00ff; /* Magenta */
            --button-primary-bg: #00ffff;
            --button-primary-text: #1a1a2e;
            --error-color: #ff4d4d;
        }

        /* General Body & Global Styles */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color-main);
            color: var(--text-color-main);
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align to top for scrolling */
            min-height: 100vh;
            overflow-y: scroll; /* Allow body scrolling */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Main App Container */
        #app-container {
            width: 100%;
            max-width: 420px; /* Mobile-first optimization */
            background-color: var(--bg-color-main);
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* Fixed Header */
        header {
            background-color: var(--bg-color-darker);
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color-main);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        /* AddMint Logo (CSS only) */
        .header-logo {
            font-size: 1.8em;
            font-weight: bold;
            color: var(--highlight-color-main);
            letter-spacing: 1px;
            text-shadow: 0 0 5px var(--highlight-color-main);
            position: relative;
            padding-left: 25px; /* Space for the 'A' element */
        }
        .header-logo::before {
            content: 'A';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.2em;
            color: var(--highlight-color-secondary);
            text-shadow: 0 0 8px var(--highlight-color-secondary);
        }

        .header-actions button {
            background: none;
            border: none;
            color: var(--text-color-main);
            font-size: 1.5em;
            cursor: pointer;
            padding: 5px;
            transition: color 0.3s ease;
        }

        .header-actions button:hover {
            color: var(--highlight-color-main);
        }

        /* Main Content Area */
        #main-content {
            flex-grow: 1;
            padding: 15px 0; /* Padding for horizontal, none for vertical as sections have their own */
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 70px; /* Space for fixed footer */
        }

        .screen {
            display: none; /* Hidden by default */
            padding: 0 15px;
        }

        .screen.active {
            display: block;
        }

        /* Fixed Footer (Bottom Navigation) */
        footer {
            background-color: var(--bg-color-darker);
            border-top: 1px solid var(--border-color-main);
            padding: 10px 0;
            display: flex;
            justify-content: space-around;
            position: fixed;
            bottom: 0;
            width: 100%;
            max-width: 420px;
            z-index: 1000;
        }

        .nav-button {
            background: none;
            border: none;
            color: var(--text-color-light);
            font-size: 0.8em;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: color 0.3s ease, transform 0.2s ease;
            padding: 5px;
            min-width: 60px;
        }

        .nav-button .icon {
            font-size: 1.8em;
            margin-bottom: 3px;
        }

        .nav-button.active {
            color: var(--highlight-color-main);
            transform: translateY(-2px);
        }

        .nav-button:hover {
            color: var(--highlight-color-main);
        }

        /* Professional CSS Icons */
        .icon {
            display: inline-block;
            width: 1em;
            height: 1em;
            vertical-align: middle;
            position: relative;
        }

        /* Home icon */
        .icon-home { width: 1.2em; height: 1.2em; border: 2px solid currentColor; border-radius: 3px; position: relative; top: -2px; }
        .icon-home::before { content: ''; position: absolute; top: -0.4em; left: 50%; transform: translateX(-50%) rotate(45deg); width: 0.8em; height: 0.8em; border: 2px solid currentColor; border-bottom: none; border-right: none; }
        .icon-home::after { content: ''; position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 0.4em; height: 0.4em; background-color: currentColor; }

        /* Profile icon (user silhouette) */
        .icon-profile { width: 1.4em; height: 1.4em; border-radius: 50%; border: 2px solid currentColor; position: relative; overflow: hidden; top: -2px; }
        .icon-profile::before { content: ''; position: absolute; width: 1em; height: 0.6em; border-radius: 50% 50% 0 0; background-color: currentColor; bottom: 0; left: 50%; transform: translateX(-50%); } /* Body */
        .icon-profile::after { content: ''; position: absolute; width: 0.6em; height: 0.6em; border-radius: 50%; background-color: currentColor; top: 0.15em; left: 50%; transform: translateX(-50%); } /* Head */

        /* Monetization icon (dollar sign in a circle) */
        .icon-monetize { width: 1.4em; height: 1.4em; border-radius: 50%; border: 2px solid currentColor; position: relative; top: -2px; }
        .icon-monetize::before { content: '$'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 0.8em; font-weight: bold; }

        /* Refresh icon (circular arrow) */
        .icon-refresh { width: 1.5em; height: 1.5em; position: relative; top: -2px; }
        .icon-refresh::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; border: 2px solid currentColor; border-radius: 50%; border-top-color: transparent; border-right-color: transparent; transform: rotate(-45deg); }
        .icon-refresh::after { content: ''; position: absolute; width: 0.5em; height: 0.5em; border: 2px solid currentColor; border-left-color: transparent; border-bottom-color: transparent; top: 0.1em; left: 0.7em; transform: rotate(45deg); }

        /* Logout icon (door with arrow) */
        .icon-logout { width: 1.4em; height: 1.4em; position: relative; top: -2px; }
        .icon-logout::before { content: ''; position: absolute; width: 0.8em; height: 1.2em; border: 2px solid currentColor; border-radius: 2px; left: 0; top: 0; } /* Door */
        .icon-logout::after { content: ''; position: absolute; width: 0.8em; height: 0.2em; background-color: currentColor; right: 0; top: 0.6em; } /* Arrow */
        .icon-logout .arrow-head { position: absolute; width: 0.4em; height: 0.4em; border: 2px solid currentColor; border-bottom-color: transparent; border-left-color: transparent; transform: rotate(45deg); right: 0; top: 0.4em; } /* Arrowhead */

        /* Like icon (heart) */
        .icon-like { width: 1.2em; height: 1.2em; position: relative; top: -2px; transform-origin: center; }
        .icon-like::before, .icon-like::after { content: ''; position: absolute; top: 0; width: 0.7em; height: 1.1em; background-color: currentColor; border-radius: 0.7em 0.7em 0 0; transform: rotate(-45deg); transform-origin: 0 100%; }
        .icon-like::after { left: 0.4em; transform: rotate(45deg); transform-origin: 100% 100%; }
        .icon-like.liked { color: red; }

        /* Comment icon (speech bubble) */
        .icon-comment { width: 1.4em; height: 1.2em; border: 2px solid currentColor; border-radius: 0.6em; position: relative; top: -2px; }
        .icon-comment::before { content: ''; position: absolute; bottom: -0.4em; left: 0.2em; width: 0; height: 0; border-left: 0.4em solid transparent; border-right: 0.4em solid transparent; border-top: 0.4em solid currentColor; }

        /* View icon (eye) */
        .icon-view { width: 1.6em; height: 0.8em; border: 2px solid currentColor; border-radius: 50%; position: relative; top: -2px; overflow: hidden; }
        .icon-view::before { content: ''; position: absolute; width: 0.4em; height: 0.4em; background-color: currentColor; border-radius: 50%; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .icon-view::after { content: ''; position: absolute; width: 0.15em; height: 0.15em; background-color: var(--bg-color-main); border-radius: 50%; top: 0.2em; left: 0.7em; transform: translate(-50%, -50%); }

        /* Options icon (three dots) */
        .icon-options { display: flex; justify-content: space-around; align-items: center; width: 1.5em; height: 0.3em; position: relative; top: -2px; }
        .icon-options::before, .icon-options::after, .icon-options span { content: ''; width: 0.3em; height: 0.3em; background-color: currentColor; border-radius: 50%; }
        .icon-options::before { margin-right: 0.4em; }
        .icon-options::after { margin-left: 0.4em; }

        /* Edit icon (pencil) */
        .icon-edit { width: 1.2em; height: 1.2em; position: relative; top: -2px; }
        .icon-edit::before { content: ''; position: absolute; width: 0.4em; height: 0.4em; border: 2px solid currentColor; border-top-color: transparent; border-left-color: transparent; transform: rotate(-45deg); top: 0.4em; left: 0.4em; }
        .icon-edit::after { content: ''; position: absolute; width: 1em; height: 0.2em; background-color: currentColor; transform: rotate(45deg); transform-origin: top left; top: 0.1em; left: 0.1em; }

        /* Send icon (paper plane) */
        .icon-send { width: 1.4em; height: 1.2em; position: relative; top: -2px; }
        .icon-send::before { content: ''; position: absolute; top: 0; left: 0; width: 0; height: 0; border-left: 0.8em solid currentColor; border-top: 0.6em solid transparent; border-bottom: 0.6em solid transparent; }
        .icon-send::after { content: ''; position: absolute; top: 0.4em; right: 0; width: 0; height: 0; border-right: 0.8em solid currentColor; border-top: 0.4em solid transparent; border-bottom: 0.4em solid transparent; }

        /* Back Arrow Icon */
        .icon-back { width: 1.5em; height: 1.5em; position: relative; top: -2px; }
        .icon-back::before { content: ''; position: absolute; left: 0; top: 50%; transform: translateY(-50%); width: 1em; height: 2px; background-color: currentColor; }
        .icon-back::after { content: ''; position: absolute; left: 0; top: 50%; transform: translateY(-50%) rotate(45deg); width: 0.6em; height: 2px; background-color: currentColor; transform-origin: 0% 50%; }
        .icon-back .arrow-bottom { position: absolute; left: 0; top: 50%; transform: translateY(-50%) rotate(-45deg); width: 0.6em; height: 2px; background-color: currentColor; transform-origin: 0% 50%; }

        /* Generic Elements */
        input[type="email"], input[type="password"], input[type="text"], textarea {
            width: calc(100% - 20px);
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid var(--border-color-main);
            border-radius: 8px;
            background-color: var(--bg-color-lighter);
            color: var(--text-color-main);
            font-size: 1em;
            outline: none;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        input[type="email"]:focus, input[type="password"]:focus, input[type="text"]:focus, textarea:focus {
            border-color: var(--highlight-color-main);
            box-shadow: 0 0 8px rgba(0, 255, 255, 0.3);
        }

        button {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
        }

        .btn-primary {
            background-color: var(--button-primary-bg);
            color: var(--button-primary-text);
            box-shadow: 0 4px 10px rgba(0, 255, 255, 0.4);
        }

        .btn-primary:hover {
            background-color: #00e6e6; /* Slightly darker cyan */
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 255, 255, 0.6);
        }

        .btn-secondary {
            background-color: var(--bg-color-lighter);
            color: var(--highlight-color-main);
            border: 1px solid var(--highlight-color-main);
        }

        .btn-secondary:hover {
            background-color: var(--bg-color-darker);
            color: var(--highlight-color-secondary);
            border-color: var(--highlight-color-secondary);
        }

        .text-link {
            color: var(--highlight-color-main);
            cursor: pointer;
            text-decoration: none;
            transition: color 0.3s ease;
        }

        .text-link:hover {
            color: var(--highlight-color-secondary);
        }

        .error-message {
            color: var(--error-color);
            margin-top: -10px;
            margin-bottom: 15px;
            font-size: 0.9em;
            text-align: center;
        }

        /* Loading States */
        #load-status {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            color: var(--highlight-color-main);
            font-size: 1.2em;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        #load-status.active {
            opacity: 1;
            visibility: visible;
        }

        .spinner {
            border: 4px solid rgba(0, 255, 255, 0.3);
            border-top: 4px solid var(--highlight-color-main);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loader {
            border: 2px solid rgba(0, 255, 255, 0.2);
            border-top: 2px solid var(--highlight-color-main);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            margin: 10px auto;
            display: none;
        }
        .loader.active {
            display: block;
        }

        /* Auth Screen */
        #auth-screen {
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: var(--bg-color-main);
            position: absolute;
            width: 100%;
            box-sizing: border-box;
            z-index: 2000; /* Above main app */
        }
        .auth-form {
            background-color: var(--bg-color-darker);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.6);
            width: 100%;
            max-width: 350px;
            text-align: center;
        }
        .auth-form h2 {
            color: var(--highlight-color-main);
            margin-bottom: 25px;
            font-size: 1.8em;
        }
        .auth-form p {
            font-size: 0.9em;
            color: var(--text-color-light);
            margin-top: 20px;
        }
        .auth-form button {
            width: 100%;
            margin-top: 10px;
        }

        /* Post Card Styles */
        .post-card {
            background-color: var(--bg-color-lighter);
            border-radius: 12px;
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid var(--border-color-main);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            transition: box-shadow 0.2s ease;
            position: relative;
        }
        .post-card.neon-glow {
            box-shadow: 0 0 15px var(--highlight-color-secondary), 0 0 25px rgba(255, 0, 255, 0.5); /* Neon glow */
        }

        .post-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        .post-header .avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background-color: var(--border-color-main);
            margin-right: 10px;
            object-fit: cover;
            border: 2px solid var(--highlight-color-main);
        }
        .post-header .author-info {
            flex-grow: 1;
        }
        .post-header .author-info .username {
            font-weight: bold;
            color: var(--highlight-color-main);
            cursor: pointer;
            font-size: 1.1em;
        }
        .post-header .author-info .timestamp {
            font-size: 0.8em;
            color: var(--text-color-light);
        }
        .post-options-btn {
            background: none;
            border: none;
            color: var(--text-color-light);
            font-size: 1.2em;
            cursor: pointer;
            padding: 5px;
        }
        .post-options-menu {
            position: absolute;
            top: 50px;
            right: 15px;
            background-color: var(--bg-color-darker);
            border: 1px solid var(--border-color-main);
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
            z-index: 100;
            display: none;
        }
        .post-options-menu button {
            display: block;
            width: 100%;
            padding: 10px 15px;
            text-align: left;
            background: none;
            border: none;
            color: var(--text-color-main);
            cursor: pointer;
            font-size: 0.9em;
        }
        .post-options-menu button:hover {
            background-color: var(--bg-color-lighter);
        }

        .post-content {
            margin-bottom: 15px;
            line-height: 1.6;
            word-wrap: break-word;
        }
        .post-content strong {
            color: var(--highlight-color-main);
        }
        .post-content em {
            color: var(--highlight-color-secondary);
        }
        .post-content a {
            color: var(--highlight-color-main);
            text-decoration: underline;
        }
        .post-content img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin: 10px 0;
            display: block;
        }
        .post-content .youtube-embed {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%; /* 16:9 Aspect Ratio */
            height: 0;
            overflow: hidden;
            margin: 10px 0;
        }
        .post-content .youtube-embed iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 8px;
        }
        .ad-unit {
            background-color: rgba(255, 0, 255, 0.1); /* Magenta tint for ads */
            border: 1px dashed var(--highlight-color-secondary);
            padding: 10px;
            margin: 15px 0;
            text-align: center;
            font-size: 0.9em;
            color: var(--text-color-light);
            border-radius: 8px;
        }

        .post-actions {
            display: flex;
            justify-content: space-around;
            align-items: center;
            border-top: 1px solid var(--border-color-main);
            padding-top: 10px;
            margin-top: 10px;
        }
        .post-action-btn {
            background: none;
            border: none;
            color: var(--text-color-light);
            font-size: 1.1em;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: color 0.3s ease, transform 0.2s ease;
        }
        .post-action-btn:hover {
            color: var(--highlight-color-main);
            transform: translateY(-2px);
        }
        .post-action-btn.liked {
            color: red;
            animation: bounceIn 0.3s ease;
        }

        @keyframes bounceIn {
            0%, 20%, 40%, 60%, 80%, 100% {
                transition-timing-function: cubic-bezier(0.215, 0.61, 0.355, 1);
            }
            0% { opacity: 0; transform: scale3d(0.3, 0.3, 0.3); }
            20% { transform: scale3d(1.1, 1.1, 1.1); }
            40% { transform: scale3d(0.9, 0.9, 0.9); }
            60% { opacity: 1; transform: scale3d(1.03, 1.03, 1.03); }
            80% { transform: scale3d(0.97, 0.97, 0.97); }
            100% { opacity: 1; transform: scale3d(1, 1, 1); }
        }

        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: var(--bg-color-darker);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.7);
            width: 90%;
            max-width: 400px;
            transform: scale(0.8);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
            position: relative;
        }
        .modal-overlay.active .modal-content {
            transform: scale(1);
            opacity: 1;
        }

        /* Full-screen modal for comments */
        .full-screen-modal .modal-content {
            width: 100%;
            height: 100%;
            max-width: none;
            max-height: none;
            border-radius: 0;
            padding: 15px;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .modal-header h3 {
            color: var(--highlight-color-main);
            margin: 0;
        }
        .modal-close-btn {
            background: none;
            border: none;
            color: var(--text-color-light);
            font-size: 1.8em;
            cursor: pointer;
        }

        /* Comment Modal specific */
        #comment-modal .modal-body {
            flex-grow: 1;
            overflow-y: auto;
            margin-bottom: 15px;
            padding-right: 5px; /* For scrollbar */
        }
        .comment-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 15px;
            background-color: var(--bg-color-lighter);
            padding: 10px;
            border-radius: 8px;
        }
        .comment-item .avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 10px;
            border: 1px solid var(--border-color-main);
        }
        .comment-item-content {
            flex-grow: 1;
        }
        .comment-item-content .username {
            font-weight: bold;
            color: var(--highlight-color-main);
            font-size: 0.95em;
            margin-bottom: 3px;
        }
        .comment-item-content .text {
            font-size: 0.9em;
            color: var(--text-color-main);
            word-wrap: break-word;
        }
        #comment-input-area {
            display: flex;
            gap: 10px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color-main);
        }
        #comment-input-area textarea {
            flex-grow: 1;
            margin-bottom: 0;
            min-height: 40px;
            max-height: 80px;
            resize: vertical;
        }
        #comment-input-area button {
            width: auto;
            padding: 10px 15px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Profile Screen */
        #profile-screen .profile-header {
            text-align: center;
            padding: 20px 0;
            background-color: var(--bg-color-darker);
            margin-bottom: 20px;
            border-radius: 12px;
            border: 1px solid var(--border-color-main);
        }
        #profile-screen .profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 15px;
            border: 4px solid var(--highlight-color-main);
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.4);
        }
        #profile-screen .display-name {
            font-size: 1.8em;
            font-weight: bold;
            color: var(--highlight-color-main);
            margin-bottom: 5px;
        }
        #profile-screen .username {
            font-size: 1.1em;
            color: var(--text-color-light);
            margin-bottom: 10px;
        }
        #profile-screen .bio {
            font-size: 0.95em;
            color: var(--text-color-main);
            max-width: 300px;
            margin: 0 auto 20px;
        }
        #profile-screen .profile-stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
        }
        #profile-screen .stat-item {
            text-align: center;
            cursor: pointer;
        }
        #profile-screen .stat-item strong {
            display: block;
            font-size: 1.5em;
            color: var(--highlight-color-secondary);
        }
        #profile-screen .stat-item span {
            font-size: 0.9em;
            color: var(--text-color-light);
        }
        #profile-screen .profile-actions {
            margin-top: 20px;
        }
        #profile-screen .profile-actions button {
            width: calc(100% - 30px);
            max-width: 200px;
            margin: 0 auto;
            display: block;
        }
        #profile-posts-feed {
            padding: 0 15px; /* Match screen padding */
        }

        /* Follower/Following Modal */
        #follow-list-modal .modal-body {
            flex-grow: 1;
            overflow-y: auto;
        }
        .follow-list-item {
            display: flex;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color-main);
        }
        .follow-list-item:last-child {
            border-bottom: none;
        }
        .follow-list-item .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 10px;
            border: 1px solid var(--highlight-color-main);
        }
        .follow-list-item .user-info {
            flex-grow: 1;
        }
        .follow-list-item .username {
            font-weight: bold;
            color: var(--highlight-color-main);
        }
        .follow-list-item .display-name {
            font-size: 0.85em;
            color: var(--text-color-light);
        }
        .follow-list-item .action-btn {
            padding: 8px 15px;
            font-size: 0.9em;
        }

        /* Edit Profile Modal */
        #edit-profile-modal .modal-content {
            padding: 20px;
        }
        #edit-profile-modal .modal-header {
            margin-bottom: 15px;
        }
        #edit-profile-modal form {
            display: flex;
            flex-direction: column;
        }
        #edit-profile-modal label {
            margin-bottom: 5px;
            font-size: 0.9em;
            color: var(--text-color-light);
        }
        #edit-profile-modal input, #edit-profile-modal textarea {
            margin-bottom: 15px;
        }
        #edit-profile-modal .button-group {
            display: flex;
            justify-content: space-around;
            gap: 10px;
            margin-top: 15px;
        }
        #edit-profile-modal .button-group button {
            flex-grow: 1;
        }
        .username-validation-status {
            font-size: 0.8em;
            margin-top: -10px;
            margin-bottom: 10px;
            text-align: right;
            color: var(--error-color);
        }
        .username-validation-status.available {
            color: var(--highlight-color-main);
        }

        /* Monetization Screen */
        #monetization-screen {
            padding: 20px;
            text-align: center;
        }
        #monetization-screen h2 {
            color: var(--highlight-color-main);
            margin-bottom: 25px;
            font-size: 1.8em;
        }
        #monetization-screen p {
            font-size: 1.1em;
            color: var(--text-color-main);
            margin-bottom: 15px;
        }
        #monetization-screen #current-monetized-views {
            font-size: 2.5em;
            font-weight: bold;
            color: var(--highlight-color-secondary);
            margin-bottom: 30px;
            text-shadow: 0 0 10px rgba(255, 0, 255, 0.5);
        }
        #monetization-screen #withdraw-button {
            width: calc(100% - 40px);
            max-width: 300px;
            margin: 0 auto;
        }
        #monetization-screen #withdraw-button:disabled {
            background-color: var(--bg-color-lighter);
            color: var(--text-color-light);
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        /* Withdrawal Modal */
        #withdrawal-modal .read-only-field {
            background-color: var(--bg-color-lighter);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 1em;
            color: var(--text-color-light);
            border: 1px solid var(--border-color-main);
        }
        #withdrawal-modal .button-group {
            margin-top: 20px;
        }
        #withdrawal-modal input {
            width: calc(100% - 20px); /* Adjust for padding */
        }

        /* Generic message div */
        .app-message {
            background-color: var(--highlight-color-secondary);
            color: var(--button-primary-text);
            padding: 10px 15px;
            border-radius: 8px;
            margin: 10px auto;
            text-align: center;
            max-width: 90%;
            opacity: 0;
            transform: translateY(-20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .app-message.show {
            opacity: 1;
            transform: translateY(0);
        }

    </style>
</head>
<body>
    <!-- Full-screen loading overlay -->
    <div id="load-status">
        <div class="spinner"></div>
        <span>Loading AddMint...</span>
    </div>

    <!-- Authentication Screen -->
    <div id="auth-screen">
        <div class="auth-form" id="login-form-container">
            <h2>Login to AddMint</h2>
            <input type="email" id="login-email" placeholder="Email">
            <input type="password" id="login-password" placeholder="Password">
            <p class="error-message" id="login-error-message"></p>
            <button class="btn-primary" id="login-button">Login</button>
            <p>Don't have an account? <span class="text-link" id="show-signup">Sign Up</span></p>
        </div>

        <div class="auth-form" id="signup-form-container" style="display: none;">
            <h2>Sign Up for AddMint</h2>
            <input type="email" id="signup-email" placeholder="Email">
            <input type="password" id="signup-password" placeholder="Password (min 6 chars)">
            <input type="password" id="signup-confirm-password" placeholder="Confirm Password">
            <p class="error-message" id="signup-error-message"></p>
            <button class="btn-primary" id="signup-button">Sign Up</button>
            <p>Already have an account? <span class="text-link" id="show-login">Login</span></p>
        </div>
    </div>

    <!-- Main Application Container -->
    <div id="app-container" style="display: none;">
        <header>
            <div class="header-logo">AddMint</div>
            <div class="header-actions">
                <button id="refresh-feed-button" class="icon icon-refresh" title="Refresh Feed"></button>
                <button id="logout-button" class="icon icon-logout" title="Logout"></button>
            </div>
        </header>

        <main id="main-content">
            <!-- Home Screen -->
            <section id="home-screen" class="screen">
                <div id="posts-feed">
                    <!-- Posts will be loaded here -->
                    <div class="loader" id="home-feed-loader"></div>
                </div>
            </section>

            <!-- Profile Screen -->
            <section id="profile-screen" class="screen">
                <div class="profile-header">
                    <img id="profile-avatar" src="" alt="Profile Avatar" class="profile-avatar">
                    <h1 id="profile-display-name" class="display-name"></h1>
                    <p id="profile-username" class="username"></p>
                    <p id="profile-bio" class="bio"></p>
                    <div class="profile-stats">
                        <div class="stat-item" id="stat-posts">
                            <strong id="profile-post-count">0</strong>
                            <span>Posts</span>
                        </div>
                        <div class="stat-item" id="stat-followers">
                            <strong id="profile-followers-count">0</strong>
                            <span>Followers</span>
                        </div>
                        <div class="stat-item" id="stat-following">
                            <strong id="profile-following-count">0</strong>
                            <span>Following</span>
                        </div>
                    </div>
                    <div class="profile-actions">
                        <button class="btn-primary" id="edit-profile-button" style="display: none;">
                            <span class="icon icon-edit"></span> Edit Profile
                        </button>
                        <button class="btn-primary" id="follow-button" style="display: none;">Follow</button>
                        <button class="btn-secondary" id="unfollow-button" style="display: none;">Unfollow</button>
                    </div>
                </div>
                <div id="profile-posts-feed">
                     <div class="loader" id="profile-feed-loader"></div>
                </div>
            </section>

            <!-- Monetization Screen -->
            <section id="monetization-screen" class="screen">
                <h2>Monetization & Withdrawal</h2>
                <p>Your current monetized views:</p>
                <div id="current-monetized-views">0</div>
                <button class="btn-primary" id="withdraw-button" disabled>Withdraw Earnings</button>
                <p class="app-message" id="withdrawal-message" style="display: none;"></p>
            </section>
        </main>

        <footer>
            <button class="nav-button active" data-screen="home-screen" id="nav-home">
                <span class="icon icon-home"></span> Home
            </button>
            <button class="nav-button" data-screen="profile-screen" id="nav-profile">
                <span class="icon icon-profile"></span> Profile
            </button>
            <button class="nav-button" data-screen="monetization-screen" id="nav-monetize">
                <span class="icon icon-monetize"></span> Earnings
            </button>
        </footer>
    </div>

    <!-- Modals -->

    <!-- Edit Profile Modal -->
    <div id="edit-profile-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Profile</h3>
                <button class="modal-close-btn icon icon-back" id="edit-profile-close"></button>
            </div>
            <form id="edit-profile-form">
                <label for="edit-username">Username:</label>
                <input type="text" id="edit-username" placeholder="@username" required pattern="^[a-z0-9_.]+$">
                <p class="username-validation-status" id="username-status"></p>

                <label for="edit-display-name">Display Name:</label>
                <input type="text" id="edit-display-name" placeholder="Your Display Name" required>

                <label for="edit-bio">Bio (max 150 chars):</label>
                <textarea id="edit-bio" rows="3" maxlength="150" placeholder="Tell us about yourself..."></textarea>

                <label for="edit-profile-pic-url">Profile Picture URL:</label>
                <input type="text" id="edit-profile-pic-url" placeholder="Direct image URL">

                <p class="error-message" id="edit-profile-error"></p>
                <div class="button-group">
                    <button type="button" class="btn-secondary" id="edit-profile-cancel">Cancel</button>
                    <button type="submit" class="btn-primary" id="edit-profile-save">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Comment Modal -->
    <div id="comment-modal" class="modal-overlay full-screen-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Comments</h3>
                <button class="modal-close-btn icon icon-back" id="comment-modal-close"></button>
            </div>
            <div class="modal-body" id="comments-list">
                <!-- Comments will be loaded here -->
            </div>
            <div id="comment-input-area">
                <textarea id="new-comment-text" placeholder="Add a comment... (max 100 chars)" maxlength="100"></textarea>
                <button class="btn-primary" id="post-comment-button">
                    <span class="icon icon-send"></span> Post
                </button>
            </div>
            <p class="error-message" id="comment-error-message"></p>
        </div>
    </div>

    <!-- Follower/Following List Modal -->
    <div id="follow-list-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="follow-list-title"></h3>
                <button class="modal-close-btn icon icon-back" id="follow-list-modal-close"></button>
            </div>
            <div class="modal-body" id="follow-list-content">
                <!-- User list items will be loaded here -->
            </div>
            <p class="app-message" id="follow-list-message" style="display: none;"></p>
        </div>
    </div>

    <!-- Withdrawal Confirmation Modal -->
    <div id="withdrawal-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Confirm Withdrawal</h3>
                <button class="modal-close-btn icon icon-back" id="withdrawal-modal-close"></button>
            </div>
            <form id="withdrawal-form">
                <label>Current Monetized Views:</label>
                <div class="read-only-field" id="withdrawal-views-display"></div>

                <label for="paypal-upi-id">PayPal Email or UPI ID:</label>
                <input type="text" id="paypal-upi-id" placeholder="your_email@paypal.com or your_upi_id@bank" required>

                <p class="error-message" id="withdrawal-error"></p>
                <div class="button-group">
                    <button type="button" class="btn-secondary" id="withdrawal-cancel-button">Cancel</button>
                    <button type="submit" class="btn-primary" id="withdrawal-submit-button">Request Withdrawal</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Post Template (hidden) -->
    <template id="post-card-template">
        <div class="post-card" data-post-id="">
            <div class="post-header">
                <img src="" alt="Avatar" class="avatar author-avatar">
                <div class="author-info">
                    <span class="username"></span>
                    <span class="timestamp"></span>
                </div>
                <button class="post-options-btn icon icon-options"></button>
                <div class="post-options-menu">
                    <button class="report-post-btn">Report Post</button>
                    <button class="delete-post-btn">Delete Post</button>
                    <button class="repost-btn" disabled>Repost (coming soon)</button>
                </div>
            </div>
            <div class="post-content">
                <!-- Content will be injected here -->
            </div>
            <div class="post-actions">
                <button class="post-action-btn like-btn">
                    <span class="icon icon-like"></span> <span class="like-count">0</span>
                </button>
                <button class="post-action-btn comment-btn">
                    <span class="icon icon-comment"></span> <span class="comment-count">0</span>
                </button>
                <button class="post-action-btn view-btn">
                    <span class="icon icon-view"></span> <span class="view-count">0</span>
                </button>
            </div>
        </div>
    </template>

    <!-- Comment Item Template (hidden) -->
    <template id="comment-item-template">
        <div class="comment-item">
            <img src="" alt="Avatar" class="avatar">
            <div class="comment-item-content">
                <span class="username"></span>
                <p class="text"></p>
                <span class="timestamp"></span>
            </div>
        </div>
    </template>

    <!-- Follow List Item Template (hidden) -->
    <template id="follow-list-item-template">
        <div class="follow-list-item">
            <img src="" alt="Avatar" class="avatar">
            <div class="user-info">
                <span class="username"></span>
                <span class="display-name"></span>
            </div>
            <button class="action-btn btn-secondary"></button>
        </div>
    </template>

    <script>
        // Firebase Configuration (provided by user)
        const firebaseConfig = {
            apiKey: "AIzaSyDlZA4grzF3fx95-11E4s7ASXwkIij1k1w",
            authDomain: "addmint-7ab6b.firebaseapp.com",
            databaseURL: "https://addmint-7ab6b-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "addmint-7ab6b",
            storageBucket: "addmint-7ab6b.firebasestorage.app",
            messagingSenderId: "504015450137",
            appId: "1:504015450137:web:694b176313582cce1e7a88",
            measurementId: "G-H7J7M23Z82"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- Global Variables ---
        let currentUser = null;
        let lastVisiblePost = null; // For infinite scroll pagination
        let currentProfileUserId = null; // For tracking which profile is being viewed
        let activePostIdForComments = null; // To keep track of the post for which comments are open
        const ADSENSE_PLACEHOLDER_CODE = `<div class="ad-unit">-- AdSense Ad Placeholder --</div>`; // Replace with actual AdSense code

        // --- DOM Elements ---
        const loadStatus = document.getElementById('load-status');
        const authScreen = document.getElementById('auth-screen');
        const appContainer = document.getElementById('app-container');

        // Auth elements
        const loginFormContainer = document.getElementById('login-form-container');
        const signupFormContainer = document.getElementById('signup-form-container');
        const loginEmailInput = document.getElementById('login-email');
        const loginPasswordInput = document.getElementById('login-password');
        const loginButton = document.getElementById('login-button');
        const loginErrorMessage = document.getElementById('login-error-message');
        const signupEmailInput = document.getElementById('signup-email');
        const signupPasswordInput = document.getElementById('signup-password');
        const signupConfirmPasswordInput = document.getElementById('signup-confirm-password');
        const signupButton = document.getElementById('signup-button');
        const signupErrorMessage = document.getElementById('signup-error-message');
        const showSignupLink = document.getElementById('show-signup');
        const showLoginLink = document.getElementById('show-login');

        // App Header/Footer
        const refreshFeedButton = document.getElementById('refresh-feed-button');
        const logoutButton = document.getElementById('logout-button');
        const navButtons = document.querySelectorAll('.nav-button');
        const mainContent = document.getElementById('main-content');

        // Screens
        const homeScreen = document.getElementById('home-screen');
        const profileScreen = document.getElementById('profile-screen');
        const monetizationScreen = document.getElementById('monetization-screen');

        // Home Screen elements
        const postsFeed = document.getElementById('posts-feed');
        const homeFeedLoader = document.getElementById('home-feed-loader');

        // Profile Screen elements
        const profileAvatar = document.getElementById('profile-avatar');
        const profileDisplayName = document.getElementById('profile-display-name');
        const profileUsername = document.getElementById('profile-username');
        const profileBio = document.getElementById('profile-bio');
        const profilePostCount = document.getElementById('profile-post-count');
        const profileFollowersCount = document.getElementById('profile-followers-count');
        const profileFollowingCount = document.getElementById('profile-following-count');
        const editProfileButton = document.getElementById('edit-profile-button');
        const followButton = document.getElementById('follow-button');
        const unfollowButton = document.getElementById('unfollow-button');
        const profilePostsFeed = document.getElementById('profile-posts-feed');
        const profileFeedLoader = document.getElementById('profile-feed-loader');

        // Monetization Screen elements
        const currentMonetizedViews = document.getElementById('current-monetized-views');
        const withdrawButton = document.getElementById('withdraw-button');
        const withdrawalMessage = document.getElementById('withdrawal-message');

        // Modals
        const editProfileModal = document.getElementById('edit-profile-modal');
        const editProfileCloseButton = document.getElementById('edit-profile-close');
        const editProfileCancelButton = document.getElementById('edit-profile-cancel');
        const editProfileForm = document.getElementById('edit-profile-form');
        const editUsernameInput = document.getElementById('edit-username');
        const usernameStatus = document.getElementById('username-status');
        const editDisplayNameInput = document.getElementById('edit-display-name');
        const editBioTextarea = document.getElementById('edit-bio');
        const editProfilePicUrlInput = document.getElementById('edit-profile-pic-url');
        const editProfileError = document.getElementById('edit-profile-error');

        const commentModal = document.getElementById('comment-modal');
        const commentModalCloseButton = document.getElementById('comment-modal-close');
        const commentsList = document.getElementById('comments-list');
        const newCommentTextarea = document.getElementById('new-comment-text');
        const postCommentButton = document.getElementById('post-comment-button');
        const commentErrorMessage = document.getElementById('comment-error-message');

        const followListModal = document.getElementById('follow-list-modal');
        const followListTitle = document.getElementById('follow-list-title');
        const followListContent = document.getElementById('follow-list-content');
        const followListModalClose = document.getElementById('follow-list-modal-close');
        const followListMessage = document.getElementById('follow-list-message');

        const withdrawalModal = document.getElementById('withdrawal-modal');
        const withdrawalModalCloseButton = document.getElementById('withdrawal-modal-close');
        const withdrawalViewsDisplay = document.getElementById('withdrawal-views-display');
        const paypalUpiIdInput = document.getElementById('paypal-upi-id');
        const withdrawalForm = document.getElementById('withdrawal-form');
        const withdrawalCancelButton = document.getElementById('withdrawal-cancel-button');
        const withdrawalErrorMessage = document.getElementById('withdrawal-error');


        // Templates
        const postCardTemplate = document.getElementById('post-card-template');
        const commentItemTemplate = document.getElementById('comment-item-template');
        const followListItemTemplate = document.getElementById('follow-list-item-template');

        // --- Utility Functions ---

        function showLoader(element, active = true) {
            if (active) {
                element.classList.add('active');
            } else {
                element.classList.remove('active');
            }
        }

        function showFullScreenLoader(message = "Loading...") {
            loadStatus.querySelector('span').textContent = message;
            loadStatus.classList.add('active');
        }

        function hideFullScreenLoader() {
            loadStatus.classList.remove('active');
        }

        function showMessage(element, message, type = 'error', duration = 3000) {
            element.textContent = message;
            element.classList.remove('error', 'success'); // Clear previous types
            element.classList.add(type, 'show');
            element.style.display = 'block';
            setTimeout(() => {
                element.classList.remove('show');
                setTimeout(() => element.style.display = 'none', 300); // Hide after animation
            }, duration);
        }


        function showModal(modalElement, isFullScreen = false) {
            if (isFullScreen) {
                modalElement.classList.add('full-screen-modal');
            } else {
                modalElement.classList.remove('full-screen-modal');
            }
            modalElement.classList.add('active');
        }

        function hideModal(modalElement) {
            modalElement.classList.remove('active');
        }

        // Debounce function for input validation (e.g., username check)
        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), delay);
            };
        }

        function formatTimestamp(timestamp) {
            if (!timestamp) return 'N/A';
            const date = timestamp.toDate();
            const now = new Date();
            const diffMs = now - date;
            const diffSec = Math.round(diffMs / 1000);
            const diffMin = Math.round(diffSec / 60);
            const diffHours = Math.round(diffMin / 60);
            const diffDays = Math.round(diffHours / 24);

            if (diffSec < 60) return `${diffSec}s ago`;
            if (diffMin < 60) return `${diffMin}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            return date.toLocaleDateString();
        }

        // --- Rich Text Rendering ---
        function renderRichText(content) {
            let htmlContent = content;

            // Bold: **text** -> <strong>text</strong> (basic markdown-like)
            htmlContent = htmlContent.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            // Italic: _text_ or *text* -> <em>text</em>
            htmlContent = htmlContent.replace(/(?<!\*)\*(?!\*)(.*?)(?<!\*)\*(?!\*)/g, '<em>$1</em>');
            htmlContent = htmlContent.replace(/_([^_]+)_/g, '<em>$1</em>');

            // Clickable Links: [text](url) -> <a href="url" target="_blank">text</a>
            htmlContent = htmlContent.replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>');

            // Image Embeds: Direct URL ending in common image extensions
            htmlContent = htmlContent.replace(/(https?:\/\/\S+\.(?:png|jpe?g|gif|webp|svg|bmp))(\s|$)/gi, '<img src="$1" alt="Embedded Image" loading="lazy">$2');

            // YouTube Embeds: https://www.youtube.com/watch?v=VIDEO_ID or https://youtu.be/VIDEO_ID
            htmlContent = htmlContent.replace(/https?:\/\/(?:www\.)?(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]{11})/g, (match, videoId) => {
                return `<div class="youtube-embed"><iframe src="https://www.youtube.com/embed/${videoId}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen loading="lazy"></iframe></div>`;
            });

            // AdSense Injection (simple logic: one after first paragraph, then every ~300 words, max 4)
            if (this && this.isMonetized) { // 'this' context refers to the post data
                const words = content.split(/\s+/).length;
                let adCount = 0;
                if (words >= 50) adCount++; // One after first "paragraph" (rough)
                if (words >= 350) adCount++;
                if (words >= 650) adCount++;
                if (words >= 950) adCount++; // Max 4

                const paragraphs = htmlContent.split(/(\<p\>|\<br\/\>|\<div class="youtube-embed">)/g); // Split by paragraphs or embeds
                let modifiedContent = '';
                let currentWordCount = 0;
                let insertedAds = 0;

                for (let i = 0; i < paragraphs.length; i++) {
                    modifiedContent += paragraphs[i];
                    if (paragraphs[i].startsWith('<p>') || paragraphs[i].startsWith('<br/>') || paragraphs[i].startsWith('<div class="youtube-embed">')) {
                        currentWordCount += paragraphs[i].split(/\s+/).length;
                    }

                    if (adCount > 0 && insertedAds < adCount && currentWordCount > 50 + (insertedAds * 300)) {
                        modifiedContent += ADSENSE_PLACEHOLDER_CODE;
                        insertedAds++;
                    }
                }
                htmlContent = modifiedContent;
            }

            return htmlContent;
        }


        // --- UI State Management ---
        function setActiveScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');

            navButtons.forEach(button => {
                if (button.dataset.screen === screenId) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            });
            // Scroll to top of the main content when screen changes
            mainContent.scrollTop = 0;
        }

        // --- Core Application Logic ---

        // Firebase Auth State Listener
        auth.onAuthStateChanged(async (user) => {
            showFullScreenLoader();
            if (user) {
                currentUser = user;
                // Fetch user document from Firestore
                const userDocRef = db.collection('users').doc(user.uid);
                const userDoc = await userDocRef.get();

                if (!userDoc.exists) {
                    // This should ideally not happen if user creation is tied to signup
                    console.error("User document not found for newly signed in user:", user.uid);
                    auth.signOut(); // Force re-auth
                    return;
                }

                const userData = userDoc.data();

                // Check for email verification
                if (!user.emailVerified) {
                    showMessage(loginErrorMessage, "Please verify your email before logging in. Check your inbox.", 'error', 5000);
                    auth.signOut();
                    hideFullScreenLoader();
                    return;
                }

                // First-time login: check if username is set
                if (!userData.username || userData.username === '') {
                    // Force user to edit profile
                    showModal(editProfileModal);
                    editProfileCloseButton.style.display = 'none'; // Hide cancel button
                    editProfileCancelButton.style.display = 'none';
                    editProfileError.textContent = "Please set up your profile to continue.";
                } else {
                    // User logged in and profile set
                    appContainer.style.display = 'flex';
                    authScreen.style.display = 'none';
                    await loadHomeFeed();
                    setActiveScreen('home-screen');
                }
            } else {
                currentUser = null;
                appContainer.style.display = 'none';
                authScreen.style.display = 'flex';
                loginFormContainer.style.display = 'block';
                signupFormContainer.style.display = 'none';
                loginEmailInput.value = '';
                loginPasswordInput.value = '';
                loginErrorMessage.textContent = '';
                signupEmailInput.value = '';
                signupPasswordInput.value = '';
                signupConfirmPasswordInput.value = '';
                signupErrorMessage.textContent = '';
            }
            hideFullScreenLoader();
        });

        // --- Authentication Functions ---
        async function handleSignup(e) {
            e.preventDefault();
            const email = signupEmailInput.value;
            const password = signupPasswordInput.value;
            const confirmPassword = signupConfirmPasswordInput.value;

            signupErrorMessage.textContent = '';
            if (password.length < 6) {
                showMessage(signupErrorMessage, "Password must be at least 6 characters long.", 'error');
                return;
            }
            if (password !== confirmPassword) {
                showMessage(signupErrorMessage, "Passwords do not match.", 'error');
                return;
            }

            showFullScreenLoader("Signing up...");
            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                await userCredential.user.sendEmailVerification();

                // Create user document in Firestore
                await db.collection('users').doc(userCredential.user.uid).set({
                    uid: userCredential.user.uid,
                    email: email,
                    username: '', // Initially empty, will be set in edit profile
                    name: '',
                    bio: '',
                    profilePicUrl: 'https://via.placeholder.com/150/00ffff/1a1a2e?text=AD', // Default avatar
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    postCount: 0,
                    totalMonetizedViews: 0,
                    followers: [],
                    following: [],
                    followersCount: 0,
                    followingCount: 0
                });

                showMessage(signupErrorMessage, "Account created! Please verify your email before logging in.", 'success', 5000);
                loginFormContainer.style.display = 'block';
                signupFormContainer.style.display = 'none';

            } catch (error) {
                console.error("Signup error:", error);
                showMessage(signupErrorMessage, error.message, 'error');
            } finally {
                hideFullScreenLoader();
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            const email = loginEmailInput.value;
            const password = loginPasswordInput.value;

            loginErrorMessage.textContent = '';
            showFullScreenLoader("Logging in...");
            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                if (!userCredential.user.emailVerified) {
                    showMessage(loginErrorMessage, "Please verify your email first.", 'error', 5000);
                    auth.signOut(); // Log out unverified user
                    return;
                }
                // Auth state listener will handle showing app or edit profile modal
            } catch (error) {
                console.error("Login error:", error);
                showMessage(loginErrorMessage, error.message, 'error');
            } finally {
                hideFullScreenLoader();
            }
        }

        async function handleLogout() {
            showFullScreenLoader("Logging out...");
            try {
                await auth.signOut();
                // Auth state listener will handle UI change
            } catch (error) {
                console.error("Logout error:", error);
                alert("Error logging out: " + error.message); // Simple alert for logout errors
            } finally {
                hideFullScreenLoader();
            }
        }

        // --- Post Rendering and Management ---

        function createPostElement(postData) {
            const postCard = postCardTemplate.content.cloneNode(true).querySelector('.post-card');
            postCard.dataset.postId = postData.postId;

            const authorAvatar = postCard.querySelector('.author-avatar');
            const usernameSpan = postCard.querySelector('.post-header .username');
            const timestampSpan = postCard.querySelector('.timestamp');
            const postContentDiv = postCard.querySelector('.post-content');
            const likeCountSpan = postCard.querySelector('.like-count');
            const commentCountSpan = postCard.querySelector('.comment-count');
            const viewCountSpan = postCard.querySelector('.view-count');
            const likeBtn = postCard.querySelector('.like-btn');
            const commentBtn = postCard.querySelector('.comment-btn');
            const postOptionsBtn = postCard.querySelector('.post-options-btn');
            const postOptionsMenu = postCard.querySelector('.post-options-menu');
            const deletePostBtn = postCard.querySelector('.delete-post-btn');
            const reportPostBtn = postCard.querySelector('.report-post-btn');


            authorAvatar.src = postData.authorAvatarUrl || 'https://via.placeholder.com/45/00ffff/1a1a2e?text=AD';
            usernameSpan.textContent = `@${postData.username}`;
            timestampSpan.textContent = formatTimestamp(postData.timestamp);
            postContentDiv.innerHTML = renderRichText.call(postData, postData.content); // Pass postData as 'this' context for monetization check

            likeCountSpan.textContent = postData.likesCount || 0;
            commentCountSpan.textContent = postData.commentCount || 0;
            viewCountSpan.textContent = postData.views || 0;

            // Set liked state
            if (currentUser && postData.likes && postData.likes.includes(currentUser.uid)) {
                likeBtn.classList.add('liked');
            } else {
                likeBtn.classList.remove('liked');
            }

            // Options Menu
            if (currentUser && currentUser.uid === postData.userId) {
                reportPostBtn.style.display = 'none'; // Owner cannot report their own post
            } else {
                deletePostBtn.style.display = 'none'; // Only owner can delete
            }

            postOptionsBtn.addEventListener('click', (e) => {
                e.stopPropagation(); // Prevent card double-click from firing
                postOptionsMenu.style.display = postOptionsMenu.style.display === 'block' ? 'none' : 'block';
            });

            document.addEventListener('click', (e) => {
                if (!postOptionsMenu.contains(e.target) && e.target !== postOptionsBtn) {
                    postOptionsMenu.style.display = 'none';
                }
            });

            // Event Listeners for actions
            likeBtn.addEventListener('click', (e) => handleLikePost(e, postData.postId));
            commentBtn.addEventListener('click', () => openCommentModal(postData.postId, postData.username));

            // Double click to like
            postCard.addEventListener('dblclick', (e) => {
                if (!e.target.closest('.post-actions') && !e.target.closest('.post-options-btn')) { // Exclude specific interactive areas
                    postCard.classList.add('neon-glow'); // Add glow
                    setTimeout(() => postCard.classList.remove('neon-glow'), 500); // Remove after a short delay
                    handleLikePost(e, postData.postId);
                }
            });

            // Navigate to profile on username/avatar click
            authorAvatar.addEventListener('click', () => navigateToProfile(postData.userId));
            usernameSpan.addEventListener('click', () => navigateToProfile(postData.userId));

            // Delete Post
            deletePostBtn.addEventListener('click', async () => {
                if (confirm("Are you sure you want to delete this post? This action cannot be undone.")) {
                    showFullScreenLoader("Deleting post...");
                    try {
                        // Delete post document
                        await db.collection('posts').doc(postData.postId).delete();
                        // Delete comments sub-collection (requires cloud function for full deletion)
                        // For client-side, we'll just indicate it's deleted. A CF would iterate and delete.
                        // Decrease user's post count
                        await db.collection('users').doc(currentUser.uid).update({
                            postCount: firebase.firestore.FieldValue.increment(-1)
                        });
                        postCard.remove(); // Remove from UI
                        showMessage(postsFeed, "Post deleted successfully.", 'success');
                    } catch (error) {
                        console.error("Error deleting post:", error);
                        showMessage(postsFeed, "Error deleting post: " + error.message, 'error');
                    } finally {
                        hideFullScreenLoader();
                    }
                }
            });

            // Report Post
            reportPostBtn.addEventListener('click', async () => {
                if (confirm("Are you sure you want to report this post?")) {
                    showFullScreenLoader("Reporting post...");
                    try {
                        await db.collection('reports').add({
                            reportedBy: currentUser.uid,
                            reportedPostId: postData.postId,
                            reason: 'User reported via app', // Could expand this with a reason input
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        showMessage(postsFeed, "Post reported successfully. Thank you!", 'success');
                    } catch (error) {
                        console.error("Error reporting post:", error);
                        showMessage(postsFeed, "Error reporting post: " + error.message, 'error');
                    } finally {
                        hideFullScreenLoader();
                    }
                }
            });

            // View Count (basic client-side increment with local storage guard)
            // This is a simplified approach. A more robust solution involves a Cloud Function or server-side logic
            // to prevent abuse and ensure unique views per user/session over a period.
            const viewedPosts = JSON.parse(localStorage.getItem('viewedPosts') || '{}');
            if (currentUser && !viewedPosts[currentUser.uid]?.[postData.postId]) {
                db.collection('posts').doc(postData.postId).update({
                    views: firebase.firestore.FieldValue.increment(1)
                }).then(() => {
                    viewCountSpan.textContent = parseInt(viewCountSpan.textContent) + 1;
                    if (!viewedPosts[currentUser.uid]) {
                        viewedPosts[currentUser.uid] = {};
                    }
                    viewedPosts[currentUser.uid][postData.postId] = true;
                    localStorage.setItem('viewedPosts', JSON.stringify(viewedPosts));
                }).catch(error => {
                    console.error("Error incrementing view count:", error);
                });
            }

            return postCard;
        }

        async function handleLikePost(e, postId) {
            if (!currentUser) {
                showMessage(loginErrorMessage, "Please log in to like posts.", 'error');
                return;
            }

            const postRef = db.collection('posts').doc(postId);
            const postCard = e.target.closest('.post-card');
            const likeBtn = postCard.querySelector('.like-btn');
            const likeCountSpan = postCard.querySelector('.like-count');

            try {
                await db.runTransaction(async (transaction) => {
                    const postDoc = await transaction.get(postRef);
                    if (!postDoc.exists) {
                        throw "Post does not exist!";
                    }

                    const postData = postDoc.data();
                    let likes = postData.likes || [];
                    let likesCount = postData.likesCount || 0;
                    const userId = currentUser.uid;

                    if (likes.includes(userId)) {
                        // Unlike
                        likes = likes.filter(id => id !== userId);
                        likesCount--;
                        likeBtn.classList.remove('liked');
                    } else {
                        // Like
                        likes.push(userId);
                        likesCount++;
                        likeBtn.classList.add('liked');
                    }

                    transaction.update(postRef, {
                        likes: likes,
                        likesCount: likesCount
                    });
                    likeCountSpan.textContent = likesCount; // Update UI immediately
                });
            } catch (error) {
                console.error("Error liking post:", error);
                showMessage(postCard, "Error updating like: " + error.message, 'error');
            }
        }

        async function fetchPosts(feedElement, isProfileFeed = false, userId = null, refresh = false) {
            showLoader(isProfileFeed ? profileFeedLoader : homeFeedLoader);
            let query = db.collection('posts')
                            .orderBy('timestamp', 'desc')
                            .limit(10); // Fetch 10 posts at a time

            if (isProfileFeed && userId) {
                query = query.where('userId', '==', userId);
            } else {
                // For home feed, initially fetch all posts (simplified, should be "followed + public")
                // A more robust solution would involve fetching followed users' posts + a few popular public posts.
                // For this example, we'll just fetch all posts as public.
            }

            if (!refresh && lastVisiblePost) {
                query = query.startAfter(lastVisiblePost);
            }

            try {
                const snapshot = await query.get();
                if (refresh) {
                    feedElement.innerHTML = ''; // Clear existing posts on refresh
                    lastVisiblePost = null;
                }

                if (snapshot.empty) {
                    if (!refresh && lastVisiblePost) {
                        // Loop back to beginning if no more posts and it's an infinite scroll attempt
                        lastVisiblePost = null;
                        await fetchPosts(feedElement, isProfileFeed, userId, true); // Refresh and start from beginning
                    } else {
                        feedElement.innerHTML += '<p style="text-align: center; color: var(--text-color-light);">No posts to display.</p>';
                    }
                    hideLoader(isProfileFeed ? profileFeedLoader : homeFeedLoader);
                    return;
                }

                lastVisiblePost = snapshot.docs[snapshot.docs.length - 1]; // Update last visible post for next pagination

                snapshot.docs.forEach(doc => {
                    const postData = doc.data();
                    postData.postId = doc.id; // Add postId to data
                    const postElement = createPostElement(postData);
                    feedElement.appendChild(postElement);
                });

            } catch (error) {
                console.error("Error fetching posts:", error);
                feedElement.innerHTML += '<p class="error-message">Error loading posts.</p>';
            } finally {
                hideLoader(isProfileFeed ? profileFeedLoader : homeFeedLoader);
            }
        }

        // Infinite scroll for home feed
        let homeFeedObserver = null;
        function setupHomeFeedInfiniteScroll() {
            if (homeFeedObserver) homeFeedObserver.disconnect();

            homeFeedObserver = new IntersectionObserver(async (entries) => {
                if (entries[0].isIntersecting && !homeFeedLoader.classList.contains('active')) {
                    await fetchPosts(postsFeed);
                }
            }, { threshold: 0.5 }); // Trigger when 50% of the loader is visible

            homeFeedObserver.observe(homeFeedLoader);
        }

        async function loadHomeFeed() {
            postsFeed.innerHTML = ''; // Clear previous posts
            lastVisiblePost = null;
            await fetchPosts(postsFeed);
            setupHomeFeedInfiniteScroll();
        }


        // --- Comment Modal Logic ---
        async function openCommentModal(postId, postUsername) {
            if (!currentUser) {
                showMessage(commentErrorMessage, "Please log in to view/add comments.", 'error');
                return;
            }
            activePostIdForComments = postId;
            commentsList.innerHTML = ''; // Clear previous comments
            commentErrorMessage.textContent = '';
            newCommentTextarea.value = '';

            showModal(commentModal, true);
            await fetchComments(postId);
        }

        async function fetchComments(postId) {
            showLoader(commentsList, true); // Use commentsList as the loader parent
            try {
                const commentsQuery = await db.collection('posts').doc(postId).collection('comments')
                    .orderBy('timestamp', 'asc')
                    .get();

                if (commentsQuery.empty) {
                    commentsList.innerHTML = '<p style="text-align: center; color: var(--text-color-light);">No comments yet. Be the first!</p>';
                } else {
                    commentsList.innerHTML = ''; // Clear previous content before adding
                    commentsQuery.forEach(doc => {
                        const commentData = doc.data();
                        const commentElement = commentItemTemplate.content.cloneNode(true).querySelector('.comment-item');
                        commentElement.querySelector('.avatar').src = commentData.userAvatarUrl || 'https://via.placeholder.com/35/00ffff/1a1a2e?text=AD';
                        commentElement.querySelector('.username').textContent = `@${commentData.username}`;
                        commentElement.querySelector('.text').textContent = commentData.content;
                        commentElement.querySelector('.timestamp').textContent = formatTimestamp(commentData.timestamp);
                        commentsList.appendChild(commentElement);
                    });
                }
            } catch (error) {
                console.error("Error fetching comments:", error);
                showMessage(commentErrorMessage, "Error loading comments: " + error.message, 'error');
            } finally {
                showLoader(commentsList, false);
            }
        }

        async function postComment() {
            if (!currentUser || !activePostIdForComments) return;

            const commentText = newCommentTextarea.value.trim();
            if (commentText.length === 0) {
                showMessage(commentErrorMessage, "Comment cannot be empty.", 'error');
                return;
            }
            if (commentText.length > 100) {
                showMessage(commentErrorMessage, "Comment cannot exceed 100 characters.", 'error');
                return;
            }

            postCommentButton.disabled = true;
            commentErrorMessage.textContent = '';
            showFullScreenLoader("Posting comment...");

            try {
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                const userData = userDoc.data();

                const newCommentRef = db.collection('posts').doc(activePostIdForComments).collection('comments').doc();
                await newCommentRef.set({
                    commentId: newCommentRef.id,
                    postId: activePostIdForComments,
                    userId: currentUser.uid,
                    username: userData.username,
                    userAvatarUrl: userData.profilePicUrl,
                    content: commentText,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Update comment count on the post
                const postRef = db.collection('posts').doc(activePostIdForComments);
                await postRef.update({
                    commentCount: firebase.firestore.FieldValue.increment(1)
                });

                newCommentTextarea.value = '';
                await fetchComments(activePostIdForComments); // Refresh comments
                // Also update the comment count on the displayed post card in home/profile feed
                const postCardToUpdate = document.querySelector(`.post-card[data-post-id="${activePostIdForComments}"] .comment-count`);
                if (postCardToUpdate) {
                    postCardToUpdate.textContent = parseInt(postCardToUpdate.textContent) + 1;
                }
                showMessage(commentErrorMessage, "Comment posted!", 'success');

            } catch (error) {
                console.error("Error posting comment:", error);
                showMessage(commentErrorMessage, "Error posting comment: " + error.message, 'error');
            } finally {
                postCommentButton.disabled = false;
                hideFullScreenLoader();
            }
        }

        // --- Profile Management ---
        async function navigateToProfile(userIdToView) {
            if (!currentUser) {
                showMessage(profileScreen, "Please log in to view profiles.", 'error');
                return;
            }

            currentProfileUserId = userIdToView;
            setActiveScreen('profile-screen');
            await loadProfileData(userIdToView);
            await fetchPosts(profilePostsFeed, true, userIdToView, true); // Load user's posts
        }

        async function loadProfileData(userId) {
            showFullScreenLoader("Loading profile...");
            try {
                const userDoc = await db.collection('users').doc(userId).get();
                if (!userDoc.exists) {
                    showMessage(profileScreen, "User profile not found.", 'error');
                    return;
                }
                const userData = userDoc.data();

                profileAvatar.src = userData.profilePicUrl || 'https://via.placeholder.com/100/00ffff/1a1a2e?text=AD';
                profileDisplayName.textContent = userData.name || 'No Name Set';
                profileUsername.textContent = `@${userData.username || 'unknown'}`;
                profileBio.textContent = userData.bio || 'No bio yet.';
                profilePostCount.textContent = userData.postCount || 0;
                profileFollowersCount.textContent = userData.followersCount || 0;
                profileFollowingCount.textContent = userData.followingCount || 0;

                // Show/hide edit/follow buttons
                if (currentUser.uid === userId) {
                    editProfileButton.style.display = 'block';
                    followButton.style.display = 'none';
                    unfollowButton.style.display = 'none';
                } else {
                    editProfileButton.style.display = 'none';
                    // Check if current user is following this profile
                    const currentUserDoc = await db.collection('users').doc(currentUser.uid).get();
                    const currentUserFollowing = currentUserDoc.data().following || [];

                    if (currentUserFollowing.includes(userId)) {
                        followButton.style.display = 'none';
                        unfollowButton.style.display = 'block';
                    } else {
                        followButton.style.display = 'block';
                        unfollowButton.style.display = 'none';
                    }
                }

            } catch (error) {
                console.error("Error loading profile:", error);
                showMessage(profileScreen, "Failed to load profile: " + error.message, 'error');
            } finally {
                hideFullScreenLoader();
            }
        }

        async function handleEditProfileSubmit(e) {
            e.preventDefault();
            const username = editUsernameInput.value.trim().toLowerCase();
            const displayName = editDisplayNameInput.value.trim();
            const bio = editBioTextarea.value.trim();
            const profilePicUrl = editProfilePicUrlInput.value.trim();

            editProfileError.textContent = '';
            if (!username || !displayName) {
                showMessage(editProfileError, "Username and Display Name are required.", 'error');
                return;
            }
            if (!/^[a-z0-9_.]+$/.test(username)) {
                showMessage(editProfileError, "Username can only contain lowercase letters, numbers, underscores, and periods.", 'error');
                return;
            }

            // Ensure username is available if it's being changed
            const currentUserDoc = await db.collection('users').doc(currentUser.uid).get();
            const currentUsername = currentUserDoc.data().username;

            if (username !== currentUsername) {
                const usernameExists = await db.collection('users').where('username', '==', username).get();
                if (!usernameExists.empty) {
                    showMessage(editProfileError, "Username is already taken.", 'error');
                    return;
                }
            }


            showFullScreenLoader("Saving profile...");
            try {
                await db.collection('users').doc(currentUser.uid).update({
                    username: username,
                    name: displayName,
                    bio: bio,
                    profilePicUrl: profilePicUrl || 'https://via.placeholder.com/150/00ffff/1a1a2e?text=AD' // Ensure a default if empty
                });

                // If this was a first-time setup, re-evaluate UI
                if (editProfileCloseButton.style.display === 'none') {
                    // This means they were forced into setup. After save, direct to home.
                    hideModal(editProfileModal);
                    appContainer.style.display = 'flex';
                    authScreen.style.display = 'none';
                    await loadHomeFeed();
                    setActiveScreen('home-screen');
                } else {
                    hideModal(editProfileModal);
                    if (currentProfileUserId === currentUser.uid) { // If editing own profile from profile screen
                        await loadProfileData(currentUser.uid); // Refresh profile data
                    }
                }
                showMessage(editProfileError, "Profile updated successfully!", 'success'); // Using modal error for success too
            } catch (error) {
                console.error("Error updating profile:", error);
                showMessage(editProfileError, "Error updating profile: " + error.message, 'error');
            } finally {
                hideFullScreenLoader();
            }
        }

        const checkUsernameAvailability = debounce(async () => {
            const username = editUsernameInput.value.trim().toLowerCase();
            if (username.length === 0) {
                usernameStatus.textContent = '';
                usernameStatus.classList.remove('available', 'error');
                return;
            }
            if (!/^[a-z0-9_.]+$/.test(username)) {
                usernameStatus.textContent = "Invalid characters.";
                usernameStatus.classList.add('error');
                usernameStatus.classList.remove('available');
                return;
            }

            const currentUserDoc = await db.collection('users').doc(currentUser.uid).get();
            const currentUsername = currentUserDoc.data().username;

            if (username === currentUsername) {
                usernameStatus.textContent = "Your current username.";
                usernameStatus.classList.add('available');
                usernameStatus.classList.remove('error');
                return;
            }

            try {
                const snapshot = await db.collection('users').where('username', '==', username).get();
                if (snapshot.empty) {
                    usernameStatus.textContent = "Username available!";
                    usernameStatus.classList.add('available');
                    usernameStatus.classList.remove('error');
                } else {
                    usernameStatus.textContent = "Username taken.";
                    usernameStatus.classList.add('error');
                    usernameStatus.classList.remove('available');
                }
            } catch (error) {
                console.error("Error checking username:", error);
                usernameStatus.textContent = "Error checking username.";
                usernameStatus.classList.add('error');
                usernameStatus.classList.remove('available');
            }
        }, 500); // 500ms debounce

        async function handleFollowUnfollow(action) { // 'follow' or 'unfollow'
            if (!currentUser || !currentProfileUserId || currentUser.uid === currentProfileUserId) return;

            showFullScreenLoader(`${action === 'follow' ? 'Following' : 'Unfollowing'} user...`);
            try {
                await db.runTransaction(async (transaction) => {
                    const currentUserRef = db.collection('users').doc(currentUser.uid);
                    const targetUserRef = db.collection('users').doc(currentProfileUserId);

                    const currentUserDoc = await transaction.get(currentUserRef);
                    const targetUserDoc = await transaction.get(targetUserRef);

                    if (!currentUserDoc.exists || !targetUserDoc.exists) {
                        throw "User documents not found.";
                    }

                    let currentUserFollowing = currentUserDoc.data().following || [];
                    let targetUserFollowers = targetUserDoc.data().followers || [];

                    if (action === 'follow') {
                        if (!currentUserFollowing.includes(currentProfileUserId)) {
                            currentUserFollowing.push(currentProfileUserId);
                            targetUserFollowers.push(currentUser.uid);
                        }
                    } else { // unfollow
                        currentUserFollowing = currentUserFollowing.filter(id => id !== currentProfileUserId);
                        targetUserFollowers = targetUserFollowers.filter(id => id !== currentUser.uid);
                    }

                    transaction.update(currentUserRef, {
                        following: currentUserFollowing,
                        followingCount: currentUserFollowing.length
                    });
                    transaction.update(targetUserRef, {
                        followers: targetUserFollowers,
                        followersCount: targetUserFollowers.length
                    });
                });
                await loadProfileData(currentProfileUserId); // Refresh profile to show updated counts and button
                showMessage(profileScreen, `Successfully ${action === 'follow' ? 'followed' : 'unfollowed'}!`, 'success');
            } catch (error) {
                console.error(`Error ${action}ing user:`, error);
                showMessage(profileScreen, `Failed to ${action} user: ` + error.message, 'error');
            } finally {
                hideFullScreenLoader();
            }
        }

        async function openFollowListModal(type) { // 'followers' or 'following'
            if (!currentUser || !currentProfileUserId) return;

            followListTitle.textContent = type === 'followers' ? 'Followers' : 'Following';
            followListContent.innerHTML = '<div class="loader active"></div>'; // Show loader
            hideModal(followListMessage);
            showModal(followListModal);

            try {
                const userDoc = await db.collection('users').doc(currentProfileUserId).get();
                const userData = userDoc.data();
                const userIds = type === 'followers' ? (userData.followers || []) : (userData.following || []);

                if (userIds.length === 0) {
                    followListContent.innerHTML = `<p style="text-align: center; color: var(--text-color-light);">No ${type} found.</p>`;
                    return;
                }

                followListContent.innerHTML = ''; // Clear loader
                const userPromises = userIds.map(id => db.collection('users').doc(id).get());
                const userSnapshots = await Promise.all(userPromises);

                userSnapshots.forEach(docSnapshot => {
                    if (docSnapshot.exists) {
                        const userListItem = followListItemTemplate.content.cloneNode(true).querySelector('.follow-list-item');
                        const listItemData = docSnapshot.data();

                        userListItem.querySelector('.avatar').src = listItemData.profilePicUrl || 'https://via.placeholder.com/40/00ffff/1a1a2e?text=AD';
                        userListItem.querySelector('.username').textContent = `@${listItemData.username}`;
                        userListItem.querySelector('.display-name').textContent = listItemData.name;

                        const actionButton = userListItem.querySelector('.action-btn');
                        actionButton.dataset.userId = docSnapshot.id;

                        // Logic for follow/unfollow/remove
                        if (currentProfileUserId === currentUser.uid && type === 'followers') {
                            // Viewing my own followers list: show "Remove"
                            actionButton.textContent = 'Remove';
                            actionButton.classList.add('btn-secondary');
                            actionButton.addEventListener('click', () => handleRemoveFollower(currentUser.uid, docSnapshot.id));
                        } else if (currentUser.uid !== docSnapshot.id) {
                            // Viewing someone else's list, or my following list: show Follow/Unfollow
                            const isFollowing = userData.following?.includes(docSnapshot.id) || false; // Check if the *currently logged-in user* is following THIS list item user
                            if (isFollowing) {
                                actionButton.textContent = 'Unfollow';
                                actionButton.classList.add('btn-secondary');
                                actionButton.addEventListener('click', () => handleFollowUnfollowListItem('unfollow', docSnapshot.id));
                            } else {
                                actionButton.textContent = 'Follow';
                                actionButton.classList.add('btn-primary');
                                actionButton.addEventListener('click', () => handleFollowUnfollowListItem('follow', docSnapshot.id));
                            }
                        } else {
                            // This is the current user in the list
                            actionButton.style.display = 'none';
                        }
                        userListItem.addEventListener('click', (e) => {
                            if (!e.target.closest('.action-btn')) { // Don't navigate if clicking action button
                                hideModal(followListModal);
                                navigateToProfile(docSnapshot.id);
                            }
                        });

                        followListContent.appendChild(userListItem);
                    }
                });
            } catch (error) {
                console.error("Error fetching follow list:", error);
                followListContent.innerHTML = `<p class="error-message">Error loading list: ${error.message}</p>`;
            } finally {
                showLoader(followListContent, false);
            }
        }

        async function handleFollowUnfollowListItem(action, targetUserId) {
            if (!currentUser) return;

            showFullScreenLoader(`${action === 'follow' ? 'Following' : 'Unfollowing'} user...`);
            try {
                await db.runTransaction(async (transaction) => {
                    const currentUserRef = db.collection('users').doc(currentUser.uid);
                    const targetUserRef = db.collection('users').doc(targetUserId);

                    const currentUserDoc = await transaction.get(currentUserRef);
                    const targetUserDoc = await transaction.get(targetUserRef);

                    if (!currentUserDoc.exists || !targetUserDoc.exists) {
                        throw "User documents not found.";
                    }

                    let currentUserFollowing = currentUserDoc.data().following || [];
                    let targetUserFollowers = targetUserDoc.data().followers || [];

                    if (action === 'follow') {
                        if (!currentUserFollowing.includes(targetUserId)) {
                            currentUserFollowing.push(targetUserId);
                            targetUserFollowers.push(currentUser.uid);
                        }
                    } else { // unfollow
                        currentUserFollowing = currentUserFollowing.filter(id => id !== targetUserId);
                        targetUserFollowers = targetUserFollowers.filter(id => id !== currentUser.uid);
                    }

                    transaction.update(currentUserRef, {
                        following: currentUserFollowing,
                        followingCount: currentUserFollowing.length
                    });
                    transaction.update(targetUserRef, {
                        followers: targetUserFollowers,
                        followersCount: targetUserFollowers.length
                    });
                });
                showMessage(followListMessage, `${action === 'follow' ? 'Followed' : 'Unfollowed'} user!`, 'success');
                await openFollowListModal(followListTitle.textContent === 'Followers' ? 'followers' : 'following'); // Refresh the list
            } catch (error) {
                console.error(`Error ${action}ing user from list:`, error);
                showMessage(followListMessage, `Failed to ${action} user: ` + error.message, 'error');
            } finally {
                hideFullScreenLoader();
            }
        }

        async function handleRemoveFollower(myUserId, followerId) {
            if (!currentUser || currentUser.uid !== myUserId) return; // Only I can remove my followers

            showFullScreenLoader("Removing follower...");
            try {
                await db.runTransaction(async (transaction) => {
                    const myUserRef = db.collection('users').doc(myUserId);
                    const followerUserRef = db.collection('users').doc(followerId);

                    const myUserDoc = await transaction.get(myUserRef);
                    const followerUserDoc = await transaction.get(followerUserRef);

                    if (!myUserDoc.exists || !followerUserDoc.exists) {
                        throw "User documents not found.";
                    }

                    let myFollowers = myUserDoc.data().followers || [];
                    let followerFollowing = followerUserDoc.data().following || [];

                    // Remove followerId from my followers list
                    myFollowers = myFollowers.filter(id => id !== followerId);
                    // Remove myUserId from the follower's following list
                    followerFollowing = followerFollowing.filter(id => id !== myUserId);

                    transaction.update(myUserRef, {
                        followers: myFollowers,
                        followersCount: myFollowers.length
                    });
                    transaction.update(followerUserRef, {
                        following: followerFollowing,
                        followingCount: followerFollowing.length
                    });
                });
                showMessage(followListMessage, "Follower removed.", 'success');
                await openFollowListModal('followers'); // Refresh followers list
            } catch (error) {
                console.error("Error removing follower:", error);
                showMessage(followListMessage, "Failed to remove follower: " + error.message, 'error');
            } finally {
                hideFullScreenLoader();
            }
        }

        // --- Monetization Logic ---
        async function loadMonetizationData() {
            if (!currentUser) return;
            showFullScreenLoader("Loading earnings...");
            try {
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                const userData = userDoc.data();
                const views = userData.totalMonetizedViews || 0;
                currentMonetizedViews.textContent = views.toLocaleString();
                if (views >= 100000) {
                    withdrawButton.disabled = false;
                } else {
                    withdrawButton.disabled = true;
                }
            } catch (error) {
                console.error("Error loading monetization data:", error);
                showMessage(monetizationScreen, "Error loading earnings: " + error.message, 'error');
            } finally {
                hideFullScreenLoader();
            }
        }

        async function handleWithdrawalRequest(e) {
            e.preventDefault();
            const paymentId = paypalUpiIdInput.value.trim();
            if (!paymentId) {
                showMessage(withdrawalErrorMessage, "Please enter your PayPal Email or UPI ID.", 'error');
                return;
            }

            const currentViews = parseInt(currentMonetizedViews.textContent.replace(/,/g, ''));
            if (currentViews < 100000) {
                showMessage(withdrawalErrorMessage, "Minimum 100,000 views required for withdrawal.", 'error');
                return;
            }

            showFullScreenLoader("Submitting withdrawal request...");
            try {
                // Get current user's username for the request
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                const username = userDoc.data().username || 'unknown_user';

                // Create withdrawal request document
                await db.collection('withdrawalRequests').add({
                    userId: currentUser.uid,
                    username: username,
                    views: currentViews,
                    paymentId: paymentId,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    emailStatus: 'pending'
                });

                // Reset user's totalMonetizedViews to 0
                await db.collection('users').doc(currentUser.uid).update({
                    totalMonetizedViews: 0
                });

                hideModal(withdrawalModal);
                await loadMonetizationData(); // Refresh earnings display
                showMessage(withdrawalMessage, "Withdrawal request submitted! Views reset to 0.", 'success', 7000);
            } catch (error) {
                console.error("Error submitting withdrawal request:", error);
                showMessage(withdrawalErrorMessage, "Error submitting request: " + error.message, 'error');
            } finally {
                hideFullScreenLoader();
            }
        }

        // --- Event Listeners ---

        // Auth screen toggling
        showSignupLink.addEventListener('click', () => {
            loginFormContainer.style.display = 'none';
            signupFormContainer.style.display = 'block';
            loginErrorMessage.textContent = '';
        });
        showLoginLink.addEventListener('click', () => {
            loginFormContainer.style.display = 'block';
            signupFormContainer.style.display = 'none';
            signupErrorMessage.textContent = '';
        });

        // Auth form submissions
        loginButton.addEventListener('click', handleLogin);
        signupButton.addEventListener('click', handleSignup);

        // App navigation
        navButtons.forEach(button => {
            button.addEventListener('click', async () => {
                const screenId = button.dataset.screen;
                setActiveScreen(screenId);
                if (screenId === 'home-screen') {
                    await loadHomeFeed();
                } else if (screenId === 'profile-screen') {
                    await navigateToProfile(currentUser.uid); // Load current user's profile
                } else if (screenId === 'monetization-screen') {
                    await loadMonetizationData();
                }
            });
        });

        // Header actions
        logoutButton.addEventListener('click', handleLogout);
        refreshFeedButton.addEventListener('click', () => loadHomeFeed(true)); // Pass true for refresh

        // Edit Profile Modal
        editProfileButton.addEventListener('click', () => {
            if (currentUser) {
                // Populate fields with current data
                db.collection('users').doc(currentUser.uid).get().then(doc => {
                    const data = doc.data();
                    editUsernameInput.value = data.username || '';
                    editDisplayNameInput.value = data.name || '';
                    editBioTextarea.value = data.bio || '';
                    editProfilePicUrlInput.value = data.profilePicUrl || '';
                    usernameStatus.textContent = '';
                    usernameStatus.classList.remove('available', 'error');

                    editProfileError.textContent = '';
                    editProfileCloseButton.style.display = 'block'; // Show cancel for regular edits
                    editProfileCancelButton.style.display = 'block';
                    showModal(editProfileModal);
                }).catch(error => {
                    console.error("Error loading profile for edit:", error);
                    showMessage(editProfileError, "Error loading profile data.", 'error');
                });
            }
        });
        editProfileCloseButton.addEventListener('click', () => hideModal(editProfileModal));
        editProfileCancelButton.addEventListener('click', () => hideModal(editProfileModal));
        editProfileForm.addEventListener('submit', handleEditProfileSubmit);
        editUsernameInput.addEventListener('input', checkUsernameAvailability);

        // Comment Modal
        commentModalCloseButton.addEventListener('click', () => hideModal(commentModal));
        postCommentButton.addEventListener('click', postComment);

        // Follow/Unfollow and list modals
        followButton.addEventListener('click', () => handleFollowUnfollow('follow'));
        unfollowButton.addEventListener('click', () => handleFollowUnfollow('unfollow'));
        profileFollowersCount.parentElement.addEventListener('click', () => openFollowListModal('followers'));
        profileFollowingCount.parentElement.addEventListener('click', () => openFollowListModal('following'));
        followListModalClose.addEventListener('click', () => hideModal(followListModal));

        // Withdrawal Modal
        withdrawButton.addEventListener('click', () => {
            if (parseInt(currentMonetizedViews.textContent.replace(/,/g, '')) >= 100000) {
                withdrawalViewsDisplay.textContent = currentMonetizedViews.textContent;
                paypalUpiIdInput.value = '';
                withdrawalErrorMessage.textContent = '';
                showModal(withdrawalModal);
            }
        });
        withdrawalModalCloseButton.addEventListener('click', () => hideModal(withdrawalModal));
        withdrawalCancelButton.addEventListener('click', () => hideModal(withdrawalModal));
        withdrawalForm.addEventListener('submit', handleWithdrawalRequest);

        // Initial App setup (hide everything until auth state is known)
        showFullScreenLoader("Initializing...");

        // --- Infinite Scroll Listener (outside of setupHomeFeedInfiniteScroll for general purpose) ---
        // This will trigger when the bottom of the main content is reached for the currently active feed.
        mainContent.addEventListener('scroll', () => {
            if (mainContent.scrollTop + mainContent.clientHeight >= mainContent.scrollHeight - 100) { // 100px from bottom
                const activeScreenId = document.querySelector('.screen.active').id;
                if (activeScreenId === 'home-screen' && !homeFeedLoader.classList.contains('active')) {
                    fetchPosts(postsFeed);
                }
                // If profile feed needs infinite scroll, add similar logic here
                // else if (activeScreenId === 'profile-screen' && !profileFeedLoader.classList.contains('active')) {
                //     fetchPosts(profilePostsFeed, true, currentProfileUserId);
                // }
            }
        });

    </script>
</body>
</html>
