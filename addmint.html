<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AddMint - Ultra Professional</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        /* CSS starts here (Copied and adjusted for all-in-one file) */

        /* General Body and Container Styles */
        body {
            font-family: 'Montserrat', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color-main); /* Dark background for neon effect */
            color: var(--text-color-main);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
            line-height: 1.6;
            transition: background-color 0.3s ease, color 0.3s ease; /* For dark/light mode */
        }

        /* Dark Mode Color Variables */
        body.dark-mode {
            --bg-color-main: #1a1a2e;
            --bg-color-lighter: #16213e;
            --bg-color-darker: #0d2a4a;
            --text-color-main: #e0e0e0;
            --text-color-light: #bbb;
            --text-color-accent: #00ffff;
            --border-color-main: #0f3460;
            --shadow-color-main: rgba(0, 255, 255, 0.2);
            --shadow-color-strong: rgba(0, 255, 255, 0.4);
            --highlight-color-main: #00ffff;
            --highlight-color-secondary: #ff00ff;
            --button-primary-bg: #00ffff;
            --button-primary-text: #1a1a2e;
            --button-secondary-bg: #334e68;
            --button-secondary-text: #e0e0e0;
            --input-bg: #1a1a2e;
            --input-border: #00ffff;
            --post-card-bg: #0f3460;
            --chat-bubble-left-bg: #334e68;
            --chat-bubble-right-bg: #00ffff;
            --chat-bubble-right-text: #1a1a2e;
        }

        /* Light Mode Color Variables (Adjust as needed if Light Mode is fully implemented) */
        body.light-mode {
            --bg-color-main: #f0f2f5;
            --bg-color-lighter: #ffffff;
            --bg-color-darker: #e0e0e0;
            --text-color-main: #333333;
            --text-color-light: #666666;
            --text-color-accent: #007bff;
            --border-color-main: #cccccc;
            --shadow-color-main: rgba(0, 0, 0, 0.1);
            --shadow-color-strong: rgba(0, 0, 0, 0.2);
            --highlight-color-main: #007bff;
            --highlight-color-secondary: #6f42c1;
            --button-primary-bg: #007bff;
            --button-primary-text: #ffffff;
            --button-secondary-bg: #e9ecef;
            --button-secondary-text: #333333;
            --input-bg: #ffffff;
            --input-border: #ced4da;
            --post-card-bg: #ffffff;
            --chat-bubble-left-bg: #e9ecef;
            --chat-bubble-right-bg: #007bff;
            --chat-bubble-right-text: #ffffff;
        }

        /* Base container for the entire application, controlled by JS display property */
        .app-container {
            width: 100%;
            max-width: 420px;
            height: 100vh;
            display: flex; /* Controlled by JS: none initially, then flex */
            flex-direction: column;
            background-color: var(--bg-color-lighter);
            box-shadow: 0 0 30px var(--shadow-color-main);
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            border: 1px solid var(--border-color-main);
        }

        /* Generic hidden class, used with !important to ensure override */
        .hidden {
            display: none !important; 
        }

        /* Diagnostic message - for debugging initial JS load (should appear if JS loads, then hide) */
        #load-status {
            position:fixed; 
            top:50%; 
            left:50%; 
            transform:translate(-50%, -50%); 
            color:white; 
            background:black; 
            padding:10px; 
            z-index:9999;
            display: none; /* Initially hidden, JS will make it block */
            text-align: center;
        }

        /* Authentication Container (Login/Signup screens) */
        .auth-container {
            width: 100%;
            max-width: 420px;
            height: 100vh;
            display: flex; /* Initially hidden, JS changes to flex */
            justify-content: center;
            align-items: center; /* Centers .auth-content vertically */
            background-color: var(--bg-color-lighter);
            box-shadow: 0 0 30px var(--shadow-color-main);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--border-color-main);
            padding: 20px;
            box-sizing: border-box;
            flex-direction: column;
            text-align: center;
        }
        .auth-content { /* Inner content area for auth forms, handles logo and title */
            width: 100%;
            background-color: var(--bg-color-main);
            padding: 30px 20px;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.1);
            border: 1px solid var(--border-color-main);
            display: flex; 
            flex-direction: column;
            align-items: center; /* Centers auth forms horizontally */
        }
        .app-logo-splash { /* Logo icon for auth and splash screens */
            width: 100px;
            height: 100px;
            background: linear-gradient(45deg, #00ffff, #ff00ff); 
            border-radius: 50%;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.6), 0 0 40px rgba(255, 0, 255, 0.4);
            animation: pulse 2s infinite alternate;
        }
        .app-logo-splash::before { /* Stylized 'A' in the app logo */
            content: 'A'; 
            font-family: 'Montserrat', sans-serif;
            font-size: 60px;
            font-weight: bold;
            color: #1a1a2e;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        /* Specific styles for Login/Sign Up screens */
        .auth-screen { 
            display: none; /* Hidden by default, JS toggles 'active' class */
            width: 100%; 
            flex-direction: column; 
            align-items: center; 
        }
        .auth-screen.active {
            display: flex; /* Display as flex when active */
        }
        .auth-text { /* Text for auth links like "Forgot Password?" */
            font-size: 0.9em;
            margin-top: 15px;
            color: var(--text-color-light);
        }
        .auth-text a { 
            color: var(--highlight-color-main);
            text-decoration: none;
            font-weight: bold;
        }
        .auth-text a:hover {
            text-decoration: underline;
        }
        .status-message { /* Dynamic feedback messages in auth forms */
            margin-top: 15px;
            padding: 8px 10px;
            border-radius: 5px;
            font-size: 0.9em;
        }
        .status-message.error { 
            background-color: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
            border: 1px solid #e74c3c;
        }
        .status-message.success { 
            background-color: rgba(51, 255, 87, 0.2);
            color: #33ff57;
            border: 1px solid #33ff57;
        }
        .status-message.info { 
            background-color: rgba(0, 255, 255, 0.1);
            color: #00ffff;
            border: 1px solid #00ffff;
        }

        /* Header of the main application */
        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background-color: var(--border-color-main);
            color: white;
            border-bottom: 1px solid var(--bg-color-darker);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            z-index: 10;
        }

        .header-left, .header-right {
            display: flex;
            align-items: center;
        }

        .app-title {
            font-size: 1.5em;
            font-weight: bold;
            margin-left: 15px;
            color: var(--highlight-color-main);
            text-shadow: 0 0 5px var(--highlight-color-main);
        }

        .icon-button {
            background: none;
            border: none;
            color: white;
            font-size: 1.2em;
            cursor: pointer;
            margin-left: 15px;
            transition: color 0.3s ease, transform 0.2s ease;
        }

        .icon-button:hover {
            color: var(--highlight-color-main);
            transform: scale(1.1);
        }

        .loader { /* Universal loader spinner style */
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid var(--highlight-color-main);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin-top: 20px;
        }

        .menu-icon {
            width: 30px;
            height: 20px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            cursor: pointer;
        }

        .menu-icon .bar {
            width: 100%;
            height: 3px;
            background-color: white;
            border-radius: 2px;
        }

        /* Sidebar Navigation */
        .sidebar {
            position: fixed;
            top: 0;
            left: -300px; /* Hidden by default */
            width: 280px;
            height: 100%;
            background-color: var(--border-color-main);
            box-shadow: 5px 0 15px rgba(0, 0, 0, 0.5);
            z-index: 20;
            transition: left 0.3s ease-in-out;
            padding-top: 20px;
        }

        .sidebar.open {
            left: 0;
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid var(--bg-color-darker);
            margin-bottom: 20px;
            position: relative;
        }

        .sidebar-header h3 {
            margin: 0 0 0 15px;
            color: var(--highlight-color-main);
            font-size: 1.4em;
            max-width: 150px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .sidebar-header .close-sidebar {
            font-size: 2em;
            color: white;
            cursor: pointer;
            line-height: 1;
            position: absolute;
            right: 20px;
        }
        
        /* Profile Avatar CSS-generated Icons */
        .profile-avatar, .profile-avatar-large, .profile-avatar-small, .logo-option-item {
            position: relative; /* For ::before pseudo-element positioning */
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden; /* Hide anything outside avatar bounds */
            background-color: #00ffff; /* Default base color, overridden by logo classes */
            border: 2px solid #00ffff; /* Default border color */
            border-radius: 50%;
            flex-shrink: 0; /* Prevent shrinking in flex containers */
            cursor: pointer;
        }
        .profile-avatar::before, .profile-avatar-large::before, .profile-avatar-small::before, .logo-option-item::before {
            font-family: 'Font Awesome 6 Free'; /* Requires Font Awesome loaded */
            font-weight: 900; /* Solid icons */
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            color: #1a1a2e; /* Dark color for the icon over neon background */
        }
        
        /* Specific sizes for avatars */
        .profile-avatar { width: 40px; height: 40px; }
        .profile-avatar::before { content: '\f406'; font-size: 24px; } /* User circle solid */
        .profile-avatar-large { width: 100px; height: 100px; border-width: 4px; }
        .profile-avatar-large::before { content: '\f406'; font-size: 60px; } /* Larger user circle */
        .profile-avatar-small { width: 50px; height: 50px; border-width: 2px; }
        .profile-avatar-small::before { content: '\f406'; font-size: 30px; } /* Smaller user circle */
        .logo-option-item { width: 50px; height: 50px; border-width: 2px; }
        .logo-option-item::before { content: '\f406'; font-size: 28px; } /* Similar to small */


        /* Data Saver & Dark Mode Toggles */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
            margin-left: auto;
            flex-shrink: 0; 
        }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-switch label {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc; transition: .4s; border-radius: 34px;
        }
        .toggle-switch label:before {
            position: absolute; content: ""; height: 16px; width: 16px; left: 2px; bottom: 2px;
            background-color: white; transition: .4s; border-radius: 50%;
        }
        .toggle-switch input:checked + label { background-color: #00ffff; }
        .toggle-switch input:checked + label:before { transform: translateX(20px); }

        /* Main Content Area */
        .main-content {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
            padding-bottom: 80px; 
        }
        /* Specific screen sections, display controlled by JS 'active' class */
        .app-screen { display: none; }
        .app-screen.active { display: block; }

        section {
            background-color: var(--bg-color-main);
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 0 15px var(--shadow-color-main);
            border: 1px solid var(--border-color-main);
        }
        h2 { /* Section titles */
            color: var(--highlight-color-main);
            text-shadow: 0 0 5px var(--highlight-color-main);
            border-bottom: 2px solid var(--border-color-main);
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        /* Post Feed Layouts */
        .posts-feed {
            display: flex;
            flex-direction: column;
            gap: 20px; 
        }
        .post-card {
            background-color: var(--post-card-bg);
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.08);
            border: 1px solid var(--bg-color-darker);
            transition: box-shadow 0.3s ease-in-out, border-color 0.3s ease-in-out;
            position: relative;
        }
        .post-card.neon-glow {
            box-shadow: 0 0 5px var(--highlight-color-main), 0 0 15px var(--highlight-color-main), 0 0 25px var(--highlight-color-main), 0 0 35px var(--highlight-color-main);
            border-color: var(--highlight-color-main);
        }
        .post-header {
            display: flex; align-items: center; margin-bottom: 10px;
        }
        .post-content p { margin: 0 0 10px 0; word-wrap: break-word; }
        .post-content img { max-width: 100%; border-radius: 8px; margin-top: 10px; border: 1px solid var(--bg-color-darker); }
        .post-content a { color: var(--highlight-color-main); text-decoration: underline; word-break: break-all; }
        .post-footer { display: flex; flex-direction: column; gap: 10px; }
        .post-actions { display: flex; align-items: center; gap: 20px; }
        .like-button, .views-count, .translate-button, .speak-button { cursor: pointer; display: flex; align-items: center; color: var(--text-color-light); transition: color 0.2s ease; }
        .like-button i, .views-count i, .translate-button i, .speak-button i { margin-right: 5px; }
        .like-button .fas.fa-heart { color: #ff007f; animation: bounceIn 0.3s ease-out; }
        .speak-button.active i { color: var(--highlight-color-main); } /* Speaker icon active state */

        .post-reactions { display: flex; align-items: center; gap: 10px; font-size: 0.9em; color: var(--text-color-light); }
        .emoji-reaction-display { display: flex; gap: 5px; flex-wrap: wrap; }
        .emoji-reaction-display .emoji { font-size: 1.2em; display: flex; align-items: center; }
        .emoji-reaction-display .count { font-size: 0.8em; margin-left: 2px; color: var(--text-color-main); }
        .total-reactions { margin-left: 10px; font-weight: bold; color: var(--highlight-color-main); }
        .emoji-picker, .emoji-picker-chat {
            position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%);
            background-color: var(--bg-color-main); border: 1px solid var(--border-color-main);
            border-radius: 8px; padding: 8px; display: flex; gap: 10px;
            box-shadow: 0 5px 20px var(--shadow-color-strong); z-index: 10;
        }
        .emoji-option { font-size: 1.5em; cursor: pointer; transition: transform 0.2s ease; }
        .emoji-option:hover { transform: scale(1.2); }

        /* Horizontal/Table Post Layouts */
        .horizontal-post-container { display: flex; overflow-x: auto; gap: 15px; padding: 10px 0; scroll-snap-type: x mandatory; -webkit-overflow-scrolling: touch; margin: 10px 0; background-color: var(--bg-color-darker); border-radius: 10px; padding: 15px; box-shadow: inset 0 0 10px var(--shadow-color-main); border: 1px solid var(--border-color-main); }
        .horizontal-post-container .post-card { min-width: 250px; scroll-snap-align: start; flex-shrink: 0; margin-bottom: 0; }
        .horizontal-post-container .post-card .post-content img { height: 150px; object-fit: cover; }
        .table-post-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; padding: 15px; background-color: var(--bg-color-darker); border-radius: 10px; box-shadow: inset 0 0 10px var(--shadow-color-main); border: 1px solid var(--border-color-main); margin: 10px 0; }
        .table-post-container .post-card { margin-bottom: 0; padding: 10px; }
        .table-post-container .post-card .post-content img { height: 100px; object-fit: cover; }
        .table-post-container .post-card .post-content p { font-size: 0.85em; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; }


        /* Form & Button Styles */
        .form-group { margin-bottom: 15px; width: 100%; } /* Take full width for forms */
        .form-group label { display: block; margin-bottom: 8px; font-weight: bold; color: var(--text-color-main); text-align: left; }
        input[type="text"], input[type="email"], input[type="password"], input[type="file"], textarea, select, input[type="number"], input[type="date"] {
            width: 100%; padding: 12px; border: 1px solid var(--input-border); border-radius: 6px;
            background-color: var(--input-bg); color: var(--text-color-main); box-sizing: border-box;
            font-size: 1em; box-shadow: 0 0 8px var(--shadow-color-main); transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        input[type="text"]:focus, input[type="email"]:focus, input[type="password"]:focus, textarea:focus, select:focus, input[type="number"]:focus, input[type="date"]:focus {
            border-color: var(--highlight-color-secondary); box-shadow: 0 0 15px rgba(255, 0, 255, 0.4); outline: none;
        }
        textarea { resize: vertical; min-height: 100px; }
        input[type="file"] { padding: 8px; }

        .btn { 
            display: inline-block; padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer;
            font-size: 1.1em; font-weight: bold; 
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            text-align: center; text-decoration: none; 
            width: 100%; max-width: 300px; /* Constrain max width for forms */
            margin-top: 15px;
        }
        .btn.primary-btn { background-color: var(--button-primary-bg); color: var(--button-primary-text); box-shadow: 0 0 10px var(--shadow-color-strong); }
        .btn.primary-btn:hover { background-color: #00e0e0; transform: translateY(-2px); box-shadow: 0 0 15px rgba(0, 255, 255, 0.6); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: translateY(0); box-shadow: none; } /* General disabled state */

        .btn.secondary-btn { background-color: var(--button-secondary-bg); color: var(--button-secondary-text); border: 1px solid var(--highlight-color-main); }
        .btn.secondary-btn:hover { background-color: #4a6684; transform: translateY(-2px); box-shadow: 0 0 10px var(--shadow-color-strong); }
        .btn.danger-btn { background-color: #e74c3c; color: white; }
        .btn.danger-btn:hover { background-color: #c0392b; transform: translateY(-2px); }
        .btn.social-btn { background-color: #2e8b57; color: white; margin-right: 10px; }
        .btn.social-btn i { margin-right: 8px; }
        .btn.social-btn:hover { background-color: #226b41; }
        .profile-actions { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 20px; justify-content: center; }

        /* Modals (used for profile edit, ad, reward, etc.) */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.7); display: flex; justify-content: center; align-items: center;
            z-index: 100;
        }
        .modal-content {
            background-color: var(--bg-color-main); padding: 30px; border-radius: 12px;
            box-shadow: 0 0 25px var(--shadow-color-main); border: 1px solid var(--highlight-color-main);
            width: 90%; max-width: 500px; position: relative; animation: fadeInScale 0.3s ease-out;
            max-height: 90vh; overflow-y: auto;
        }
        .modal-content h3 {
            color: var(--highlight-color-main); margin-top: 0; margin-bottom: 20px; text-align: center;
            border-bottom: 1px solid var(--border-color-main); padding-bottom: 10px;
        }
        #profile-modal-instruction { /* Specific for instruction in profile edit modal */
            color: var(--highlight-color-secondary); font-weight: bold; text-align: center; margin-bottom: 20px;
        }
        .modal-content .btn { margin-top: 15px; width: 100%; }

        /* Profile Logo Selection Grid (within Edit Profile modal) */
        .logo-options-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(50px, 1fr)); gap: 10px;
            max-height: 200px; overflow-y: auto; padding: 10px;
            border: 1px solid var(--border-color-main); border-radius: 8px; background-color: var(--bg-color-darker);
        }
        .logo-option-item { /* Base styling inherited from .profile-avatar etc. but for a smaller clickable square */
            width: 50px; height: 50px; border-radius: 50%; background-color: #333; /* Base color for preview */
            cursor: pointer; border: 2px solid transparent; transition: border-color 0.2s ease, transform 0.2s ease;
            display: flex; justify-content: center; align-items: center;
        }
        .logo-option-item.selected { border-color: var(--highlight-color-main); box-shadow: 0 0 10px var(--highlight-color-main); }
        .logo-option-item:hover { transform: scale(1.1); }

        /* Profile Page Specifics */
        .profile-header-area {
            text-align: center; margin-bottom: 30px; padding: 20px; background-color: var(--post-card-bg);
            border-radius: 10px; box-shadow: 0 0 15px var(--shadow-color-main); border: 1px solid var(--bg-color-darker);
        }
        .profile-avatar-large {
            width: 100px; height: 100px; border-radius: 50%; margin: 0 auto 20px auto; overflow: hidden;
            position: relative; border: 4px solid var(--highlight-color-main); box-shadow: 0 0 15px var(--shadow-color-strong);
            background-size: cover; background-position: center;
        }
        /* Specific rules to hide generic FA icon if a background-image URL is applied (meaning direct pic used) */
        .profile-avatar-large[style*="background-image"]::before,
        .profile-avatar-small[style*="background-image"]::before,
        .profile-avatar[style*="background-image"]::before,
        .logo-option-item[style*="background-image"]::before {
            content: none !important; 
        }

        .profile-name { font-size: 1.1em; color: var(--text-color-light); margin-top: -10px; margin-bottom: 10px; }
        .profile-bio { font-size: 0.9em; color: var(--text-color-light); margin-bottom: 15px; max-height: 60px; overflow: hidden; text-overflow: ellipsis; }

        .profile-stats { display: flex; justify-content: center; gap: 25px; margin-top: 15px; font-size: 1.1em; }
        .profile-stats div { text-align: center; padding: 8px 12px; background-color: var(--bg-color-main); border-radius: 8px; border: 1px solid var(--highlight-color-main); box-shadow: 0 0 8px var(--shadow-color-main); }
        .profile-stats span { display: block; font-weight: bold; font-size: 1.2em; color: var(--highlight-color-main); }
        .clickable-stat { cursor: pointer; transition: background-color 0.2s ease, transform 0.2s ease; }
        .clickable-stat:hover { background-color: var(--bg-color-darker); transform: translateY(-2px); }

        /* Chat Specific Styles */
        .message-list-container, .chat-window-container {
            background-color: var(--post-card-bg); border-radius: 10px; padding: 15px; box-shadow: 0 0 15px var(--shadow-color-main);
            border: 1px solid var(--bg-color-darker); height: calc(100% - 40px); display: flex; flex-direction: column;
        }
        .recent-chats-list { list-style: none; padding: 0; margin: 0; overflow-y: auto; flex-grow: 1; }
        .chat-item { display: flex; align-items: center; padding: 12px 10px; border-bottom: 1px solid var(--bg-color-main); cursor: pointer; transition: background-color 0.2s ease; }
        .chat-item:hover { background-color: var(--bg-color-main); }
        .chat-info { margin-left: 10px; flex-grow: 1; }
        .chat-username { font-weight: bold; color: var(--highlight-color-main); display: block; }
        .last-message { font-size: 0.9em; color: var(--text-color-light); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .chat-window-container { height: calc(100vh - 160px); padding: 0; }
        .chat-header { display: flex; align-items: center; padding: 15px; background-color: var(--post-card-bg); border-bottom: 1px solid var(--bg-color-darker); color: white; }
        .chat-header .icon-button { margin-right: 10px; }
        #chat-partner-username { font-size: 1.2em; font-weight: bold; color: var(--highlight-color-main); }
        .chat-messages { flex-grow: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; background-color: var(--bg-color-main); }
        .message-bubble {
            padding: 10px 15px; border-radius: 18px; max-width: 80%; word-wrap: break-word; font-size: 0.95em;
            line-height: 1.4; position: relative; 
        }
        .message-bubble.right { align-self: flex-end; background-color: var(--chat-bubble-right-bg); color: var(--chat-bubble-right-text); border-bottom-right-radius: 4px; }
        .message-bubble.left { align-self: flex-start; background-color: var(--chat-bubble-left-bg); color: var(--text-color-main); border-bottom-left-radius: 4px; }
        .chat-input-area { display: flex; padding: 10px 15px; border-top: 1px solid var(--bg-color-darker); background-color: var(--post-card-bg); }
        #message-input { flex-grow: 1; margin-right: 10px; min-height: 40px; max-height: 100px; resize: none; align-self: center; }
        #send-message-btn { padding: 10px 15px; font-size: 1.2em; }


        /* Search Screen */
        .search-input-group { display: flex; margin-bottom: 20px; }
        #search-query { flex-grow: 1; margin-right: 10px; }
        .search-results-container h3 { margin-top: 25px; color: var(--highlight-color-main); border-bottom: 1px solid var(--border-color-main); padding-bottom: 5px; }
        .search-list {
            list-style: none; padding: 0; margin: 0; background-color: var(--bg-color-darker);
            border-radius: 8px; border: 1px solid var(--border-color-main); max-height: 300px; overflow-y: auto;
        }
        .search-user-item { display: flex; align-items: center; padding: 10px 15px; border-bottom: 1px solid var(--bg-color-main); cursor: pointer; transition: background-color 0.2s ease; }
        .search-user-item:last-child { border-bottom: none; }
        .search-user-item:hover { background-color: var(--bg-color-main); }
        .search-username { flex-grow: 1; margin-left: 10px; font-weight: bold; color: var(--text-color-main); }
        .search-user-item .follow-btn { padding: 5px 10px; font-size: 0.9em; }


        /* Earnings Screen */
        .earnings-summary {
            background-color: var(--post-card-bg); border-radius: 10px; padding: 20px; margin-bottom: 20px;
            box-shadow: 0 0 15px var(--shadow-color-main); border: 1px solid var(--bg-color-darker); text-align: center;
        }
        .earnings-summary p { font-size: 1.1em; margin-bottom: 10px; color: var(--text-color-main); }
        .earnings-summary p span { font-weight: bold; color: var(--highlight-color-main); font-size: 1.2em; }
        #withdraw-btn { width: 100%; margin-top: 20px; }
        #withdrawal-status {
            margin-top: 15px; padding: 10px; border-radius: 5px; background-color: var(--bg-color-darker);
            text-align: center; color: var(--text-color-main); font-size: 0.9em;
        }
        #withdrawal-details-review { margin-top: 20px; padding-top: 15px; border-top: 1px dashed var(--border-color-main); }
        #withdrawal-details-review h4 { color: var(--highlight-color-main); margin-bottom: 10px; }
        #withdrawal-details-review p { margin-bottom: 5px; color: var(--text-color-main); }
        #withdrawal-details-review p span { font-weight: bold; color: var(--text-color-accent); }


        /* Reward Popup */
        .reward-content { text-align: center; }
        .reward-content h3 {
            color: #33ff57; text-shadow: 0 0 8px rgba(51, 255, 87, 0.6); margin-bottom: 15px;
        }
        .reward-content i.fas.fa-trophy { font-size: 1.5em; margin-left: 10px; vertical-align: middle; }
        #reward-message { font-size: 1.1em; color: var(--text-color-main); margin-bottom: 20px; }


        /* Toast Notification */
        .toast-notification {
            position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%);
            background-color: rgba(0, 0,0,0.8); color: white; padding: 12px 20px; border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5); z-index: 200;
            opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease;
            font-size: 0.95em; min-width: 200px; text-align: center;
        }
        .toast-notification.show { opacity: 1; visibility: visible; }
        .toast-notification.error { background-color: #e74c3c; }
        .toast-notification.success { background-color: #27ae60; }
        .toast-notification.info { background-color: #3498db; }


        /* Common Animations */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes pulse { 0% { transform: scale(1); box-shadow: 0 0 10px rgba(0, 255, 255, 0.6), 0 0 20px rgba(255, 0, 255, 0.4); } 100% { transform: scale(1.05); box-shadow: 0 0 20px rgba(0, 255, 255, 0.8), 0 0 30px rgba(255, 0, 255, 0.6); } }
        @keyframes fadeInScale { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        @keyframes bounceIn { 0% { transform: scale(0.3); opacity: 0; } 50% { transform: scale(1.1); opacity: 1; } 70% { transform: scale(0.9); } 100% { transform: scale(1); } }
        @keyframes shake {
            0% { transform: translateX(0); } 20% { transform: translateX(-5px); } 40% { transform: translateX(5px); }
            60% { transform: translateX(-5px); } 80% { transform: translateX(5px); } 100% { transform: translateX(0); }
        }

        /* Responsive Adjustments */
        @media (max-width: 600px) {
            .app-container, .auth-container { border-radius: 0; box-shadow: none; max-width: 100%; height: 100vh; }
            body { align-items: flex-start; } /* Align to top on small screens */
            .main-content { padding: 10px; }
            .app-header { padding: 10px; }
            .app-title { font-size: 1.3em; margin-left: 10px; }
            .status-display { font-size: 0.8em; padding: 3px 8px; }
            .icon-button { font-size: 1em; margin-left: 10px; }
            .app-bottom-nav { padding: 8px 0; }
            .nav-item { font-size: 0.7em; }
            .nav-item .icon-wrapper { width: 25px; height: 25px; }
            .home-icon::before, .search-icon::before, .upload-icon::before, .messages-icon::before, .profile-icon::before { font-size: 1.2em; }
            .modal-content { width: 95%; padding: 20px; }
            .profile-avatar-large { width: 80px; height: 80px; }
            .profile-avatar-large::before { font-size: 45px; }
            .profile-stats { gap: 15px; font-size: 1em; }
            .profile-stats span { font-size: 1.1em; }
            .btn { padding: 10px 15px; font-size: 1em; }
            .profile-actions { flex-direction: column; align-items: center; }
            .profile-actions .btn { width: 80%; }
            .emoji-picker, .emoji-picker-chat { padding: 6px; gap: 8px; }
            .emoji-option { font-size: 1.3em; }
            .message-bubble { max-width: 90%; }
            .toast-notification { bottom: 70px; font-size: 0.8em; min-width: unset; width: auto; padding: 10px 15px; }
            .auth-content { padding: 20px 15px; }
        }
        /* CSS Ends here */
    </style>
</head>
<body class="dark-mode"> 
    
    <!-- This paragraph is for JavaScript load testing. It should be the ONLY thing initially visible IF JS loads. -->
    <p id="load-status">Loading Application...</p>

    <!-- Auth Container for Login/Register (Hidden by default, JS will manage display) -->
    <div id="auth-container" class="auth-container hidden">
        <div class="auth-content">
            <div class="app-logo-splash auth-logo"></div> <h1>AddMint</h1>
            <section id="login-screen" class="auth-screen active">
                <h2>Login</h2>
                <div class="form-group">
                    <label for="login-email">Email:</label>
                    <input type="email" id="login-email" placeholder="Enter your email">
                </div>
                <div class="form-group">
                    <label for="login-password">Password:</label>
                    <div class="password-input-group">
                        <input type="password" id="login-password" placeholder="Enter your password">
                        <span class="password-toggle" data-target="login-password"><i class="fas fa-eye"></i></span>
                    </div>
                </div>
                <button class="btn primary-btn" id="login-btn">Login</button>
                <p class="auth-text">
                    <a href="#" id="forgot-password-link">Forgot Password?</a>
                </p>
                <p class="auth-text">Don't have an account? <a href="#" id="show-signup">Register</a></p>
                <p id="login-status" class="status-message"></p>
            </section>

            <section id="signup-screen" class="auth-screen hidden">
                <h2>Register</h2>
                <div class="form-group">
                    <label for="signup-email">Email:</label>
                    <input type="email" id="signup-email" placeholder="Enter your email">
                </div>
                <div class="form-group">
                    <label for="signup-password">Password:</label>
                    <div class="password-input-group">
                        <input type="password" id="signup-password" placeholder="Create a password">
                        <span class="password-toggle" data-target="signup-password"><i class="fas fa-eye"></i></span>
                    </div>
                </div>
                <div class="form-group">
                    <label for="signup-confirm-password">Confirm Password:</label>
                    <div class="password-input-group">
                        <input type="password" id="signup-confirm-password" placeholder="Confirm your password">
                        <span class="password-toggle" data-target="signup-confirm-password"><i class="fas fa-eye"></i></span>
                    </div>
                </div>
                <button class="btn primary-btn" id="signup-btn">Register</button>
                <p class="auth-text">Already have an account? <a href="#" id="show-login">Login</a></p>
                <p id="signup-status" class="status-message"></p>
            </section>
        </div>
    </div>


    <div id="forgot-password-modal" class="modal hidden">
        <div class="modal-content">
            <h3>Reset Password</h3>
            <p>Enter your email address to receive a password reset link.</p>
            <div class="form-group">
                <label for="reset-email">Email:</label>
                <input type="email" id="reset-email" placeholder="Your email address">
            </div>
            <button class="btn primary-btn" id="send-reset-email-btn">Send Reset Link</button>
            <p id="reset-status" class="status-message"></p>
            <button class="btn secondary-btn" id="close-reset-modal">Cancel</button>
        </div>
    </div>


    <!-- Main Application Container (Hidden by default, JS will manage display) -->
    <div id="app-container" class="app-container hidden">

        <header class="app-header">
            <div class="header-left">
                <div class="menu-icon" id="menu-toggle">
                    <div class="bar"></div>
                    <div class="bar"></div>
                    <div class="bar"></div>
                </div>
                <div class="app-title">AddMint</div>
            </div>
            <div class="header-center">
                <div class="status-display">
                    <span id="header-coins" class="clickable-stat" data-resource-type="coins">0 C</span> |
                    <span id="header-credits" class="clickable-stat" data-resource-type="credits">0 Cr</span> |
                    <span id="header-limit" class="clickable-stat" data-resource-type="limit">0 L</span> |
                    <span id="header-mint" class="clickable-stat" data-resource-type="mint">0 M</span>
                </div>
            </div>
            <div class="header-right">
                <div class="icon-button" id="refresh-posts-btn" title="Refresh Feed">
                    <i class="fas fa-sync-alt"></i>
                </div>
                <div class="icon-button" id="gift-claim-btn" title="Claim Daily Reward">
                    <i class="fas fa-gift"></i>
                </div>
            </div>
        </header>

        <nav id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <div class="profile-avatar-small" id="sidebar-profile-avatar"></div>
                <h3 id="sidebar-username">My User</h3> 
                <div class="close-sidebar" id="close-sidebar">&times;</div>
            </div>
            <ul>
                <li><a href="#" data-screen="home"><i class="fas fa-home"></i> Home Feed</a></li>
                <li><a href="#" data-screen="feed"><i class="fas fa-stream"></i> Immersive Feed</a></li>
                <li><a href="#" data-screen="profile"><i class="fas fa-user-circle"></i> My Profile</a></li>
                <li><a href="#" data-screen="upload"><i class="fas fa-plus-circle"></i> Upload Post</a></li>
                <li><a href="#" data-screen="messages"><i class="fas fa-comments"></i> Messages</a></li>
                <li><a href="#" data-screen="search"><i class="fas fa-search"></i> Search Users</a></li>
                <li><a href="#" data-screen="monetization"><i class="fas fa-dollar-sign"></i> Earn & Boost</a></li>
                <li><a href="#" id="data-saver-toggle"><i class="fas fa-wifi"></i> Data Saver <span class="toggle-switch"><input type="checkbox" id="data-saver-checkbox"><label for="data-saver-checkbox"></label></span></a></li>
                <li><a href="#" id="dark-mode-toggle"><i class="fas fa-moon"></i> Dark Mode <span class="toggle-switch"><input type="checkbox" id="dark-mode-checkbox" checked><label for="dark-mode-checkbox"></label></span></a></li>
                <li><a href="https://www.instagram.com/addmint__" target="_blank"><i class="fab fa-instagram"></i> Our Instagram</a></li>
                <li><a href="https://www.youtube.com/@add_mintmint" target="_blank"><i class="fab fa-youtube"></i> Our YouTube</a></li>
                <li><a href="#" data-screen="about"><i class="fas fa-info-circle"></i> About Us</a></li>
                <li><a href="#" data-screen="privacy"><i class="fas fa-shield-alt"></i> Privacy Policy</a></li>
                <li><a href="#" id="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
            </ul>
        </nav>

        <main class="main-content">
            <section id="home-screen" class="app-screen active">
                <h2>Recent Posts</h2>
                 <div class="category-filter">
                    <select id="post-category-filter">
                        <option value="all">All Categories</option>
                        <option value="Breaking News">Breaking News</option>
                        <option value="Trending News">Trending News</option>
                        <option value="Top Stories">Top Stories</option>
                        <option value="National News">National News</option>
                        <option value="International News">International News</option>
                        <option value="Politics">Politics</option>
                        <option value="Economy">Economy</option>
                        <option value="Business">Business</option>
                        <option value="Finance">Finance</option>
                        <option value="Stock Market">Stock Market</option>
                        <option value="Technology">Technology</option>
                        <option value="Science">Science</option>
                        <option value="Environment">Environment</option>
                        <option value="Entertainment">Entertainment</option>
                        <option value="Movies">Movies</option>
                        <option value="TV Shows">TV Shows</option>
                        <option value="Music">Music</option>
                        <option value="Celebrity Gossip">Celebrity Gossip</option>
                        <option value="Lifestyle">Lifestyle</option>
                        <option value="Fashion">Fashion</option>
                        <option value="Beauty & Grooming">Beauty & Grooming</option>
                        <option value="Food & Recipes">Food & Recipes</option>
                        <option value="Travel & Tourism">Travel & Tourism</option>
                        <option value="Sports">Sports</option>
                        <option value="Cricket">Cricket</option>
                        <option value="Football">Football</option>
                        <option value="Tennis">Tennis</option>
                        <option value="Olympics">Olympics</option>
                        <option value="Esports">Esports</option>
                        <option value="Health & Fitness">Health & Fitness</option>
                        <option value="Yoga & Meditation">Yoga & Meditation</option>
                        <option value="Education">Education</label>
                        <option value="Career & Jobs">Career & Jobs</option>
                        <option value="Startup & Entrepreneurship">Startup & Entrepreneurship</option>
                        <option value="Automobile">Automobile</option>
                        <option value="Real Estate">Real Estate</option>
                        <option value="Religion & Spirituality">Religion & Spirituality</option>
                        <option value="History & Culture">History & Culture</option>
                        <option value="Regional News (State-wise)">Regional News (State-wise)</option>
                        <option value="Weather Updates">Weather Updates</option>
                        <option value="Opinion & Editorials">Opinion & Editorials</option>
                        <option value="Viral & Social Media Trends">Viral & Social Media Trends</option>
                    </select>
                </div>
                <div id="posts-feed" class="posts-feed">
                    </div>
                <div id="loading-spinner" class="loader hidden"></div>
            </section>

            <section id="feed-screen" class="app-screen">
                <h2>Immersive Feed</h2>
                <div id="immersive-feed" class="immersive-feed">
                    <!-- Posts will be loaded here with snap scrolling -->
                </div>
                <div id="feed-loading-spinner" class="loader hidden"></div>
            </section>

            <section id="profile-screen" class="app-screen">
                <div id="user-profile-display">
                    <div class="profile-header-area">
                        <div class="profile-avatar-large" id="my-profile-avatar"></div>
                        <h2 id="my-profile-username">@myusername</h2>
                        <p id="my-profile-name" class="profile-name"></p>
                        <p id="my-profile-bio" class="profile-bio"></p>
                        <div class="profile-stats">
                            <div><span id="my-posts-count">0</span> Posts</div>
                            <div class="clickable-stat" data-stat="followers"><span id="my-followers-count">0</span> Followers</div>
                            <div class="clickable-stat" data-stat="following"><span id="my-following-count">0</span> Following</div>
                        </div>
                        <div class="profile-actions">
                            <button class="btn primary-btn" id="edit-profile-btn"><i class="fas fa-edit"></i> Edit Profile</button>
                            <button class="btn secondary-btn hidden" id="follow-user-btn"><i class="fas fa-user-plus"></i> Follow</button>
                            <button class="btn danger-btn hidden" id="unfollow-user-btn"><i class="fas fa-user-minus"></i> Unfollow</button>
                            <button class="btn primary-btn hidden" id="message-user-btn"><i class="fas fa-paper-plane"></i> Message</button>
                            <a href="#" id="profile-whatsapp-link" class="btn social-btn hidden" target="_blank"><i class="fab fa-whatsapp"></i> WhatsApp</a>
                            <a href="#" id="profile-instagram-link" class="btn social-btn hidden" target="_blank"><i class="fab fa-instagram"></i> Instagram</a>
                        </div>
                    </div>

                    <div id="edit-profile-modal" class="modal hidden">
                        <div class="modal-content">
                            <h3>Edit Profile</h3>
                            <p id="profile-modal-instruction" class="status-message info"></p> <!-- Status for edit modal -->
                            <div class="form-group">
                                <label for="edit-username">Username:</label>
                                <input type="text" id="edit-username" placeholder="Enter new username">
                                <span id="username-availability"></span>
                            </div>
                            <div class="form-group">
                                <label for="edit-name">Display Name:</label>
                                <input type="text" id="edit-name" placeholder="Enter your display name">
                            </div>
                            <div class="form-group">
                                <label for="edit-bio">Bio (Optional):</label>
                                <textarea id="edit-bio" placeholder="Tell us about yourself..."></textarea>
                            </div>
                            <div class="form-group">
                                <label for="edit-whatsapp">WhatsApp (Optional):</label>
                                <input type="text" id="edit-whatsapp" placeholder="e.g., +919876543210">
                            </div>
                            <div class="form-group">
                                <label for="edit-instagram">Instagram ID (Optional):</label>
                                <input type="text" id="edit-instagram" placeholder="e.g., my_insta_id">
                            </div>
                            <div class="form-group">
                                <label for="profile-pic-url-input">Direct Profile Picture URL (Optional):</label>
                                <input type="text" id="profile-pic-url-input" placeholder="e.g., https://example.com/mypic.jpg">
                                <small>Enter a direct image link (like from imgbb.com).</small>
                            </div>
                            <div class="form-group">
                                <label>Or Choose a Profile Logo:</label>
                                <div id="profile-logo-options" class="logo-options-grid">
                                    </div>
                            </div>
                            <div class="form-group">
                                <label for="account-privacy-toggle">Account Privacy:</label>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="account-privacy-toggle">
                                    <label for="account-privacy-toggle"></label>
                                </div>
                                <span id="account-privacy-status">Public</span>
                            </div>
                            <p id="save-profile-status" class="status-message"></p> <!-- Status for Save Changes button -->
                            <button class="btn primary-btn" id="save-profile-btn">Save Changes</button>
                            <button class="btn secondary-btn" id="cancel-edit-profile-btn">Cancel</button>
                        </div>
                    </div>

                    <div id="follow-list-modal" class="modal hidden">
                        <div class="modal-content">
                            <h3 id="follow-list-title"></h3>
                            <div id="follow-list-content">
                                </div>
                            <button class="btn secondary-btn" id="close-follow-list-modal">Close</button>
                        </div>
                    </div>

                    <div class="profile-posts-area">
                        <h3>Posts by <span id="current-profile-username-posts">Me</span></h3>
                        <div class="profile-post-tabs">
                            <button class="btn tab-btn active" data-tab="posts">My Posts</button>
                            <button class="btn tab-btn" data-tab="reposts">My Reposts</button>
                        </div>
                        <div id="profile-posts-feed" class="posts-feed">
                            </div>
                        <div id="profile-reposts-feed" class="posts-feed hidden">
                            </div>
                    </div>
                </div>
            </section>

            <section id="upload-screen" class="app-screen">
                <h2>Upload New Post</h2>
                <div class="form-group">
                    <label for="post-category">Category:</label>
                    <select id="post-category">
                        <option value="General">General</option>
                        <option value="Breaking News">Breaking News</option>
                        <option value="Trending News">Trending News</option>
                        <option value="Top Stories">Top Stories</option>
                        <option value="National News">National News</option>
                        <option value="International News">International News</option>
                        <option value="Politics">Politics</option>
                        <option value="Economy">Economy</option>
                        <option value="Business">Business</option>
                        <option value="Finance">Finance</option>
                        <option value="Stock Market">Stock Market</option>
                        <option value="Technology">Technology</option>
                        <option value="Science">Science</option>
                        <option value="Environment">Environment</option>
                        <option value="Entertainment">Entertainment</option>
                        <option value="Movies">Movies</option>
                        <option value="TV Shows">TV Shows</option>
                        <option value="Music">Music</option>
                        <option value="Celebrity Gossip">Celebrity Gossip</option>
                        <option value="Lifestyle">Lifestyle</option>
                        <option value="Fashion">Fashion</option>
                        <option value="Beauty & Grooming">Beauty & Grooming</option>
                        <option value="Food & Recipes">Food & Recipes</option>
                        <option value="Travel & Tourism">Travel & Tourism</option>
                        <option value="Sports">Sports</option>
                        <option value="Cricket">Cricket</option>
                        <option value="Football">Football</option>
                        <option value="Tennis">Tennis</option>
                        <option value="Olympics">Olympics</option>
                        <option value="Esports">Esports</option>
                        <option value="Health & Fitness">Health & Fitness</option>
                        <option value="Yoga & Meditation">Yoga & Meditation</option>
                        <option value="Education">Education</label>
                        <option value="Career & Jobs">Career & Jobs</option>
                        <option value="Startup & Entrepreneurship">Startup & Entrepreneurship</option>
                        <option value="Automobile">Automobile</option>
                        <option value="Real Estate">Real Estate</option>
                        <option value="Religion & Spirituality">Religion & Spirituality</option>
                        <option value="History & Culture">History & Culture</option>
                        <option value="Regional News (State-wise)">Regional News (State-wise)</option>
                        <option value="Weather Updates">Weather Updates</option>
                        <option value="Opinion & Editorials">Opinion & Editorials</option>
                        <option value="Viral & Social Media Trends">Viral & Social Media Trends</option>
                    </select>
                </div>
                <div class="form-group rich-text-editor">
                    <label for="post-content">Post Content:</label>
                    <div class="editor-toolbar">
                        <button type="button" class="tool-btn" data-command="bold"><i class="fas fa-bold"></i></button>
                        <button type="button" class="tool-btn" data-command="italic"><i class="fas fa-italic"></i></button>
                        <button type="button" class="tool-btn" data-command="insertImage"><i class="fas fa-image"></i></button>
                        <button type="button" class="tool-btn" data-command="insertYoutube"><i class="fab fa-youtube"></i></button>
                        <button type="button" class="tool-btn" data-command="insertLink"><i class="fas fa-link"></i></button>
                    </div>
                    <textarea id="post-content" placeholder="What's on your mind? Use **bold**, *italic*, [link text](http://url.com), ![image alt](http://image.url), ![youtube video](http://youtube.com/watch?v=VIDEO_ID)"></textarea>
                    <small>Min 60, Max 10000 characters.</small>
                </div>
                <div class="form-group">
                    <label for="post-boost">Post will be active for:</label>
                    <select id="post-boost" disabled>
                        <option value="24">24 Hours (Free)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="monetize-post-checkbox">Monetize this post?</label>
                    <div class="toggle-switch">
                        <input type="checkbox" id="monetize-post-checkbox">
                        <label for="monetize-post-checkbox"></label>
                    </div>
                    <small>Earn from views on monetized posts.</small>
                </div>
                <button class="btn primary-btn" id="publish-post-btn">Publish Post</button>
                <div id="upload-status"></div>
            </section>

            <section id="messages-screen" class="app-screen">
                <h2>Messages</h2>
                <div id="message-list-container">
                    <h3>Recent Chats</h3>
                    <ul id="recent-chats-list" class="recent-chats-list">
                        </ul>
                </div>

                <div id="chat-window-container" class="chat-window-container hidden">
                    <div class="chat-header">
                        <button id="back-to-chats-btn" class="icon-button"><i class="fas fa-arrow-left"></i></button>
                        <div class="profile-avatar small" id="chat-partner-avatar"></div>
                        <span id="chat-partner-username">@ChatUser</span>
                    </div>
                    <div id="chat-messages" class="chat-messages">
                        </div>
                    <div class="chat-input-area">
                        <textarea id="message-input" placeholder="Type your message..."></textarea>
                        <button id="send-message-btn" class="btn primary-btn"><i class="fas fa-paper-plane"></i></button>
                    </div>
                    <div class="emoji-picker-chat hidden">
                        <span class="emoji-option" data-emoji=""></span>
                        <span class="emoji-option" data-emoji=""></span>
                        <span class="emoji-option" data-emoji=""></span>
                        <span class="emoji-option" data-emoji=""></span>
                        <span class="emoji-option" data-emoji=""></span>
                    </div>
                </div>
            </section>

            <section id="search-screen" class="app-screen">
                <h2>Search Users & Posts</h2>
                <div class="search-input-group">
                    <input type="text" id="search-query" placeholder="Search by username, keyword...">
                    <button class="btn primary-btn" id="search-btn"><i class="fas fa-search"></i></button>
                </div>
                <div id="search-results" class="search-results-container">
                    <h3>Users</h3>
                    <ul id="search-user-list" class="search-list">
                        </ul>
                    <h3>Posts</h3>
                    <div id="search-post-list" class="posts-feed">
                        </div>
                    <div id="no-search-results" class="hidden">No results found.</div>
                </div>
            </section>

            <section id="earnings-screen" class="app-screen">
                <h2>My Earnings</h2>
                <div class="earnings-summary">
                    <p>Total Monetized Views: <span id="total-monetized-views">0</span></p>
                    <p>Total Unmonetized Views: <span id="total-unmonetized-views">0</span></p>
                    <p>Estimated Earnings: <span id="estimated-earnings">0.00 $</span></p>
                </div>
                <button class="btn primary-btn" id="withdraw-btn">Withdraw Earnings</button>
                <div id="withdrawal-status" class="hidden"></div>
            </section>

            <section id="about-screen" class="app-screen">
                <h2>About AddMint</h2>
                <p>AddMint is a revolutionary social media platform designed to connect people through shared interests and engaging content. We believe in fostering a positive and vibrant community where every voice can be heard.</p>
                <p>Our mission is to provide a seamless and professional experience for all users, offering unique features like dynamic post feeds, real-time messaging, and interactive user profiles.</p>
                <p>For support or inquiries, please contact us at support@addmint.com.</p>
            </section>

            <section id="privacy-screen" class="app-screen">
                <h2>Privacy Policy</h2>
                <p>Your privacy is paramount to us at AddMint. This policy outlines how we collect, use, and protect your personal information.</p>
                <h3>Information We Collect:</h3>
                <ul>
                    <li><strong>Account Information:</strong> Username, email, password (hashed).</li>
                    <li><strong>Profile Information:</strong> Optional WhatsApp number, Instagram ID, chosen profile logo.</li>
                    <li><strong>Content Data:</strong> Posts, messages, likes, reactions, views.</li>
                    <li><strong>Usage Data:</strong> Interactions with the app, features used, and technical data (e.g., device type).</li>
                </ul>
                <h3>How We Use Your Information:</h3>
                <ul>
                    <li>To provide and maintain our services.</li>
                    <li>To personalize your experience and show relevant content.</li>
                    <li>To communicate with you regarding updates, security alerts, and support.</li>
                    <li>To monitor and analyze usage patterns for service improvement.</li>
                    <li>To enforce our terms and conditions and prevent misuse.</li>
                </ul>
                <h3>Data Sharing:</h3>
                <p>We do not share your personal information with third parties except as necessary to provide our services, comply with legal obligations, or with your explicit consent.</p>
                <h3>Data Security:</h3>
                <p>We implement robust security measures, including encryption and access controls, to protect your data. However, no internet transmission is 100% secure.</p>
                <h3>Your Choices:</h3>
                <ul>
                    <li>You can update your profile information at any time.</li>
                    <li>You can delete your account by contacting support.</li>
                    <li>You can control notification preferences.</li>
                </ul>
                <p>By using AddMint, you agree to the terms of this Privacy Policy. We may update this policy periodically, and we will notify you of any significant changes.</p>
            </section>
        </main>

        <footer class="app-bottom-nav">
            <a href="#" class="nav-item active" data-screen="home">
                <div class="icon-wrapper home-icon"></div>
                <span>Home</span>
            </a>
            <a href="#" class="nav-item" data-screen="search">
                <div class="icon-wrapper search-icon"></div>
                <span>Search</span>
            </a>
            <a href="#" class="nav-item" data-screen="upload">
                <div class="icon-wrapper upload-icon"></div>
                <span>Upload</span>
            </a>
            <a href="#" class="nav-item" data-screen="messages">
                <div class="icon-wrapper messages-icon"></div>
                <span>Messages</span>
            </a>
            <a href="#" class="nav-item" data-screen="profile">
                <div class="icon-wrapper profile-icon"></div>
                <span>Profile</span>
            </a>
        </footer>

        <div id="ad-modal" class="modal hidden">
            <div class="modal-content">
                <h3>Watch an Advertisement</h3>
                <p>Please watch a short ad to claim your reward.</p>
                <div id="ad-placeholder">
                    <p>Simulating Ad (5 seconds)...</p>
                </div>
                <button class="btn secondary-btn" id="close-ad-modal" disabled>Close Ad</button>
            </div>
        </div>

        <div id="reward-popup" class="modal hidden">
            <div class="modal-content reward-content">
                <h3>Reward Claimed! <i class="fas fa-trophy"></i></h3>
                <p id="reward-message"></p>
                <button class="btn primary-btn" id="close-reward-popup">Great!</button>
            </div>
        </div>

        <div id="withdraw-modal" class="modal hidden">
            <div class="modal-content">
                <h3>Withdraw Mint</h3>
                <p><strong>Minimum withdrawal: 1,000 Mint</strong></p>
                <p>Your current Mint balance: <strong id="current-mint-balance">0 M</strong></p>
                <div class="form-group">
                    <label for="withdraw-paypal-email">PayPal Email:</label>
                    <input type="email" id="withdraw-paypal-email" placeholder="Enter your PayPal email">
                </div>
                <div class="form-group">
                    <label for="withdraw-real-name">Your Full Name:</label>
                    <input type="text" id="withdraw-real-name" placeholder="Enter your full name">
                </div>
                <div class="form-group">
                    <label for="withdraw-age">Your Age:</label>
                    <input type="number" id="withdraw-age" placeholder="Your age">
                </div>
                <div class="form-group">
                    <label for="withdraw-dob">Date of Birth:</label>
                    <input type="date" id="withdraw-dob">
                </div>
                <p style="font-size: 0.9em; color: #bbb;">Your payment will be processed within 1-15 business days.</p>
                <button class="btn primary-btn" id="confirm-withdraw-btn">Confirm Withdrawal</button>
                <button class="btn secondary-btn" id="close-withdraw-modal">Cancel</button>
                <p style="font-size: 0.8em; color: #aaa; margin-top: 15px;">Note: This process is simulated in this demo. Real withdrawals require a secure backend service.</p>
            </div>
        </div>

        <!-- Language Selection Modal for Translate -->
        <div id="language-select-modal" class="modal hidden">
            <div class="modal-content">
                <h3>Select Translation Language</h3>
                <div class="language-options">
                    <!-- Options will be dynamically added by JavaScript -->
                </div>
                <button class="btn primary-btn" id="save-language-btn">Save Language</button>
                <button class="btn secondary-btn" id="cancel-language-btn">Cancel</button>
            </div>
        </div>

        <div id="toast-notification" class="toast-notification"></div>

    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <script>
        /* JavaScript starts here */

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDlZA4grzF3fx95-11E4s7ASXwkIij1k1w",
            authDomain: "addmint-7ab6b.firebaseapp.com",
            databaseURL: "https://addmint-7ab6b-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "addmint-7ab6b",
            storageBucket: "addmint-7ab6b.firebasestorage.app",
            messagingSenderId: "504015450137",
            appId: "1:504015450137:web:694b176313582cce1e7a88",
            measurementId: "G-H7J7M23Z82"
        };

        // Initialize Firebase
        try {
            firebase.initializeApp(firebaseConfig);
            console.log("Firebase initialized successfully.");
        } catch (error) {
            console.error("Firebase initialization failed:", error);
            const loadStatusElement = document.getElementById('load-status');
            if (loadStatusElement) {
                loadStatusElement.textContent = "Critical Error: App failed to initialize. Check console & network.";
                loadStatusElement.style.backgroundColor = "red";
            }
            // Cannot proceed without Firebase, so we'll likely stick to a blank screen or error.
            // Further UI functions will implicitly handle null currentUser.
        }

        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        // --- DOM Elements ---
        const loadStatusElement = document.getElementById('load-status'); // Diagnostic element
        const authContainer = document.getElementById('auth-container'); // Container for login/signup screens
        const appContainer = document.getElementById('app-container'); // Main application container


        // Auth Screens Elements
        const loginScreen = document.getElementById('login-screen');
        const signupScreen = document.getElementById('signup-screen');
        const loginEmailInput = document.getElementById('login-email');
        const loginPasswordInput = document.getElementById('login-password');
        const loginBtn = document.getElementById('login-btn');
        const loginStatus = document.getElementById('login-status');
        const showSignupLink = document.getElementById('show-signup');

        const signupEmailInput = document.getElementById('signup-email');
        const signupPasswordInput = document.getElementById('signup-password');
        const signupConfirmPasswordInput = document.getElementById('signup-confirm-password');
        const signupBtn = document.getElementById('signup-btn');
        const signupStatus = document.getElementById('signup-status');
        const showLoginLink = document.getElementById('show-login');

        const forgotPasswordLink = document.getElementById('forgot-password-link');
        const forgotPasswordModal = document.getElementById('forgot-password-modal');
        const resetEmailInput = document.getElementById('reset-email');
        const sendResetEmailBtn = document.getElementById('send-reset-email-btn');
        const resetStatus = document.getElementById('reset-status');
        const closeResetModalBtn = document.getElementById('close-reset-modal');


        const menuToggle = document.getElementById('menu-toggle');
        const sidebar = document.getElementById('sidebar');
        const closeSidebarBtn = document.getElementById('close-sidebar');
        const mainContent = document.querySelector('.main-content');
        const bottomNavItems = document.querySelectorAll('.app-bottom-nav .nav-item');
        const screenSections = document.querySelectorAll('.app-screen');
        // Coins, Credits, Limits, Gift Claim Button are re-introduced in HTML but controlled by logic below.

        const refreshPostsBtn = document.getElementById('refresh-posts-btn');
        const postsFeed = document.getElementById('posts-feed');
        const loadingSpinner = document.getElementById('loading-spinner');


        // Post Upload Screen elements
        const uploadScreen = document.getElementById('upload-screen');
        const postCategorySelect = document.getElementById('post-category');
        const postContentInput = document.getElementById('post-content');
        const postImageInput = document.getElementById('post-image'); 
        const postBoostSelect = document.getElementById('post-boost');
        const monetizePostCheckbox = document.getElementById('monetize-post-checkbox');
        const publishPostBtn = document.getElementById('publish-post-btn');
        const uploadStatus = document.getElementById('upload-status');
        const editorToolbar = document.querySelector('.editor-toolbar');

        // Profile Screen elements
        const profileScreen = document.getElementById('profile-screen');
        const myProfileAvatar = document.getElementById('my-profile-avatar');
        const myProfileUsername = document.getElementById('my-profile-username');
        const myProfileName = document.getElementById('my-profile-name'); 
        const myProfileBio = document.getElementById('my-profile-bio'); 
        const myPostsCount = document.getElementById('my-posts-count');
        const myFollowersCount = document.getElementById('my-followers-count');
        const myFollowingCount = document.getElementById('my-following-count');
        const editProfileBtn = document.getElementById('edit-profile-btn');
        const followUserBtn = document.getElementById('follow-user-btn');
        const unfollowUserBtn = document.getElementById('unfollow-user-btn');
        const messageUserBtn = document.getElementById('message-user-btn');
        const profileWhatsappLink = document.getElementById('profile-whatsapp-link');
        const profileInstagramLink = document.getElementById('profile-instagram-link');
        const currentProfileUsernamePosts = document.getElementById('current-profile-username-posts');
        const profilePostsFeed = document.getElementById('profile-posts-feed');
        const profileRepostsFeed = document.getElementById('profile-reposts-feed');
        const profilePostTabs = document.querySelectorAll('.profile-post-tabs .tab-btn');

        const editProfileModal = document.getElementById('edit-profile-modal');
        const profileModalInstruction = document.getElementById('profile-modal-instruction');
        const saveProfileStatus = document.getElementById('save-profile-status'); // For displaying messages within edit modal
        const editUsernameInput = document.getElementById('edit-username');
        const usernameAvailability = document.getElementById('username-availability');
        const editNameInput = document.getElementById('edit-name');
        const editBioInput = document.getElementById('edit-bio');
        const editWhatsappInput = document.getElementById('edit-whatsapp');
        const editInstagramInput = document.getElementById('edit-instagram');
        const profilePicUrlInput = document.getElementById('profile-pic-url-input');
        const profileLogoOptions = document.getElementById('profile-logo-options');
        const accountPrivacyToggle = document.getElementById('account-privacy-toggle');
        const accountPrivacyStatus = document.getElementById('account-privacy-status');
        const saveProfileBtn = document.getElementById('save-profile-btn');
        const cancelEditProfileBtn = document.getElementById('cancel-edit-profile-btn');

        const followListModal = document.getElementById('follow-list-modal');
        const followListTitle = document.getElementById('follow-list-title');
        const followListContent = document.getElementById('follow-list-content');
        const closeFollowListModalBtn = document.getElementById('close-follow-list-modal');

        // Messaging Screen elements
        const messagesScreen = document.getElementById('messages-screen');
        const messageListContainer = document.getElementById('message-list-container');
        const recentChatsList = document.getElementById('recent-chats-list');
        const chatWindowContainer = document.getElementById('chat-window-container');
        const chatPartnerUsername = document.getElementById('chat-partner-username');
        const chatPartnerAvatar = document.getElementById('chat-partner-avatar');
        const chatMessages = document.getElementById('chat-messages');
        const messageInput = document.getElementById('message-input');
        const sendMessageBtn = document.getElementById('send-message-btn');
        const backToChatsBtn = document.getElementById('back-to-chats-btn');

        // Search Screen elements
        const searchScreen = document.getElementById('search-screen');
        const searchQueryInput = document.getElementById('search-query');
        const searchBtn = document.getElementById('search-btn');
        const searchUserList = document.getElementById('search-user-list');
        const searchPostList = document.getElementById('search-post-list');
        const noSearchResults = document.getElementById('no-search-results');

        // Earnings Screen elements
        const monetizationScreen = document.getElementById('monetization-screen');
        const totalMonetizedViewsSpan = document.getElementById('total-monetized-views');
        const totalUnmonetizedViewsSpan = document.getElementById('total-unmonetized-views');
        const estimatedEarningsSpan = document.getElementById('estimated-earnings');
        const withdrawBtn = document.getElementById('withdraw-btn'); // For withdrawal page logic, not a button for withdrawal directly
        const withdrawalStatusDiv = document.getElementById('withdrawal-status');

        const withdrawModal = document.getElementById('withdraw-modal');
        const currentMintBalance = document.getElementById('current-mint-balance');
        const withdrawPaypalEmail = document.getElementById('withdraw-paypal-email');
        const withdrawRealName = document.getElementById('withdraw-real-name');
        const withdrawAge = document.getElementById('withdraw-age');
        const withdrawDob = document.getElementById('withdraw-dob');
        const confirmWithdrawBtn = document.getElementById('confirm-withdraw-btn');
        const closeWithdrawModalBtn = document.getElementById('close-withdraw-modal');

        // Language Selection Modal for Translate
        const languageSelectModal = document.getElementById('language-select-modal');
        const languageOptionsContainer = document.querySelector('#language-select-modal .language-options');
        const saveLanguageBtn = document.getElementById('save-language-btn');
        const cancelLanguageBtn = document.getElementById('cancel-language-btn');

        // Resource Display (Header)
        const headerCoins = document.getElementById('header-coins');
        const headerCredits = document.getElementById('header-credits');
        const headerLimit = document.getElementById('header-limit');
        const headerMint = document.getElementById('header-mint');

        // Daily Gift Btn
        const giftClaimBtn = document.getElementById('gift-claim-btn');

        // --- Global Variables & Flags ---
        let currentUser = null; 
        let currentProfileViewingId = null;
        let currentChatPartnerId = null;

        let lastVisiblePost = null; 
        let fetchingPosts = false; 

        let postsToLoadPerScroll = 10; 

        let dataSaverEnabled = false; 
        let userSelectedTranslationLanguage = 'en'; 

        let currentSpeaker = null; // Stores current SpeechSynthesisUtterance object.
        let unsubscribeFromChat = null; // Stores Firestore unsubscribe function for chat listener.

        let isProcessingAuth = false; // Prevents multiple rapid authentication requests.
        let hasRunInitialAuthCheck = false; // Ensures primary auth logic runs once on page load.


        // Text-to-Speech API
        const synth = window.speechSynthesis;

        // Profile Logo Data (50 unique class names, colors, and unicode emojis for CSS generation)
        const PROFILE_LOGOS = [
            { class: 'logo-1', emoji: '', color: '#ff6347' }, { class: 'logo-2', emoji: '', color: '#6a5acd' }, { class: 'logo-3', emoji: '', color: '#32cd32' },
            { class: 'logo-4', emoji: '', color: '#ff8c00' }, { class: 'logo-5', emoji: '', color: '#ffd700' }, { class: 'logo-6', emoji: '', color: '#9932cc' },
            { class: 'logo-7', emoji: '', color: '#d2691e' }, { class: 'logo-8', emoji: '', color: '#6495ed' }, { class: 'logo-9', emoji: '', color: '#dda0dd' },
            { class: 'logo-10', emoji: '', color: '#20b2aa' }, { class: 'logo-11', emoji: '', color: '#87ceeb' }, { class: 'logo-12', emoji: '', color: '#7cfc00' },
            { class: 'logo-13', emoji: '', color: '#ee82ee' }, { class: 'logo-14', emoji: '', color: '#48d1cc' }, { class: 'logo-15', emoji: '', color: '#4682b4' },
            { class: 'logo-16', emoji: '', color: '#dc143c' }, { class: 'logo-17', emoji: '', color: '#f0e68c' }, { class: 'logo-18', emoji: '', color: '#00ced1' },
            { class: 'logo-19', emoji: '', color: '#b0e0e6' }, { class: 'logo-20', emoji: '', color: '#ffff00' }, { class: 'logo-21', emoji: '', color: '#ff69b4' },
            { class: 'logo-22', emoji: '', color: '#7b68ee' }, { class: 'logo-23', emoji: '', color: '#ffa07a' }, { class: 'logo-24', emoji: '', color: '#cd853f' },
            { class: 'logo-25', emoji: '', color: '#f08080' }, { class: 'logo-26', emoji: '', color: '#c0c0c0' }, { class: 'logo-27', emoji: '', color: '#afeeee' },
            { class: 'logo-28', emoji: '', color: '#228b22' }, { class: 'logo-29', emoji: '', color: '#ffb6c1' }, { class: 'logo-30', emoji: '', color: '#b0c4de' },
            { class: 'logo-31', emoji: '', color: '#8b4513' }, { class: 'logo-32', emoji: '', color: '#00fa9a' }, { class: 'logo-33', emoji: '', color: '#deb887' },
            { class: 'logo-34', emoji: '', color: '#d2b48c' }, { class: 'logo-35', emoji: '', color: '#f4a460' }, { class: 'logo-36', emoji: '', color: '#ba55d3' },
            { class: 'logo-37', emoji: '', color: '#87cefa' }, { class: 'logo-38', emoji: '', color: '#778899' }, { class: 'logo-39', emoji: '', color: '#696969' },
            { class: 'logo-40', emoji: '', color: '#d3d3d3' }, { class: 'logo-41', emoji: '', color: '#add8e6' }, { class: 'logo-42', emoji: '', color: '#b8860b' },
            { class: 'logo-43', emoji: '', color: '#5f9ea0' }, { class: 'logo-44', emoji: '', color: '#f0f8ff' }, { class: 'logo-45', emoji: '', color: '#fa8072' },
            { class: 'logo-46', emoji: '', color: '#3cb371' }, { class: 'logo-47', emoji: '', color: '#4682b4' }, { class: 'logo-48', emoji: '', color: '#2e8b57' },
            { class: 'logo-49', emoji: '', color: '#a52a2a' }, { class: 'logo-50', emoji: '', color: '#c71585' }
        ];

        // --- Utility Functions ---

        // Display a small toast notification on screen
        function showToast(message, type = 'info', duration = 3000) {
            console.log(`Toast (${type}): ${message}`); // Log all toasts for debugging
            toastNotification.textContent = message;
            toastNotification.className = `toast-notification show ${type}`; // Add type for styling (e.g., 'error', 'success')
            setTimeout(() => {
                toastNotification.className = 'toast-notification';
            }, duration);
        }

        // Update authentication form status messages (login, signup, reset password modals)
        function updateAuthStatus(element, message, type) {
            element.textContent = message;
            element.className = `status-message ${type}`; // Set styling class
            element.style.display = (type === 'hidden' || message === '') ? 'none' : 'block'; // Show/hide based on content/type
        }


        // Format large numbers for display (e.g., 12000 -> 12k)
        function formatNumber(num) {
            if (num === undefined || num === null) return 0; // Handle undefined/null gracefully
            if (num >= 1000000) return (num / 1000000).toFixed(1).replace(/\.0$/, '') + 'M'; // Millions
            if (num >= 1000) return (num / 1000).toFixed(1).replace(/\.0$/, '') + 'k'; // Thousands
            return num; // Default for smaller numbers
        }

        // Show specific application screen sections and update bottom navigation active state
        function showScreen(screenId) {
            console.log(`UI: Attempting to show screen: ${screenId}`);
            // Hide all screen sections first
            screenSections.forEach(screen => {
                screen.classList.remove('active');
            });
            // Show the target screen by adding 'active' class
            document.getElementById(screenId).classList.add('active');

            // Update active state in bottom navigation menu
            bottomNavItems.forEach(item => {
                if (item.dataset.screen === screenId.replace('-screen', '')) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });

            // Close sidebar if open
            sidebar.classList.remove('open');
            console.log(`UI: Screen ${screenId} is now active.`);
        }

        // Get random logo class name from PROFILE_LOGOS
        function getRandomLogoClass() {
            const randomIndex = Math.floor(Math.random() * PROFILE_LOGOS.length);
            return PROFILE_LOGOS[randomIndex].class;
        }

        // Get CSS class name for a profile logo from its stored name
        function getLogoCssClass(logoName) {
            const logo = PROFILE_LOGOS.find(l => l.class === logoName);
            return logo ? `user-${logo.class}` : 'user-logo-default'; // Fallback to a generic default
        }

        // Dynamically inject CSS for all 50 profile logos and default avatar.
        // This makes emojis and background colors appear based on data.
        function applyLogoStyles() {
            const styleTag = document.createElement('style');
            styleTag.id = 'dynamic-profile-styles'; // Give it an ID to prevent duplicates if function runs again.
            let styles = ``;

            // Default fallback icon for any profile that has no specific logo/URL
            styles += `.profile-avatar::before, .profile-avatar-large::before, .profile-avatar-small::before, .logo-option-item::before {
                font-family: 'Font Awesome 6 Free'; /* Requires Font Awesome loaded */
                font-weight: 900; /* Use solid icon variant */
                position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
                color: #1a1a2e; /* Icon color */
                content: '\\f406'; /* Default FA user circle solid icon */
            }
            .profile-avatar[style*="background-image"]::before, 
            .profile-avatar-large[style*="background-image"]::before, 
            .profile-avatar-small[style*="background-image"]::before, 
            .logo-option-item[style*="background-image"]::before {
                content: none !important; /* Hide FA icon if a background image is set (direct URL) */
            }`;


            PROFILE_LOGOS.forEach(logo => {
                styles += `
                    /* Styles for specific user-defined emoji logos */
                    .profile-avatar.user-${logo.class}, 
                    .profile-avatar-large.user-${logo.class}, 
                    .profile-avatar-small.user-${logo.class}, 
                    .logo-option-item.user-${logo.class} { 
                        background-color: ${logo.color}; /* Background color for avatar circle */
                    }
                    .profile-avatar.user-${logo.class}::before, 
                    .profile-avatar-large.user-${logo.class}::before, 
                    .profile-avatar-small.user-${logo.class}::before, 
                    .logo-option-item.user-${logo.class}::before { 
                        content: '${logo.emoji}'; /* Unicode emoji content */
                        font-size: ${logo.class.includes('large') ? '60px' : logo.class.includes('small') ? '30px' : '24px'}; /* Adjusted size per type */
                        font-family: initial; /* Use default font for emojis, not FA */
                    }
                `;
            });

            // Add the style tag to the document head
            document.head.appendChild(styleTag);
        }
        console.log("Profile avatar styles applied.");
        // Make sure these are called early enough (DOMContentLoaded).
        // For default avatars where no URL/emoji is provided, they will show FA user circle from base styles.
    }
    applyLogoStyles(); // Call once when script executes.


        // --- Authentication Flow and UI Control ---

        // Function to show Authentication UI (Login/Register screens)
        function showAuthContainerUI() {
            console.log("Initiating Auth UI display.");
            // Ensure app container is hidden
            appContainer.classList.add('hidden'); 
            appContainer.style.display = 'none'; 

            // Show auth container
            authContainer.classList.remove('hidden'); 
            authContainer.style.display = 'flex'; // Use flex for layout.

            // Set default auth screen to Login.
            loginScreen.classList.add('active'); 
            signupScreen.classList.remove('active'); 
            
            // Clear any lingering auth messages from previous sessions.
            updateAuthStatus(loginStatus, '', 'hidden');
            updateAuthStatus(signupStatus, '', 'hidden');
            console.log("Auth UI is now visible.");
        }

        // Function to show Main App UI (Home Feed, Profile, etc.)
        function showAppContainerUI() {
            console.log("Initiating App UI display.");
            // Ensure auth container is hidden
            authContainer.classList.add('hidden'); 
            authContainer.style.display = 'none'; 

            // Show app container
            appContainer.classList.remove('hidden'); 
            appContainer.style.display = 'flex'; // Use flex for main layout.
            console.log("App UI is now visible.");
        }


        // Primary Authentication State Handler
        // This function orchestrates which part of the UI to show based on Firebase auth state.
        async function checkUserAndRedirect(user) {
            console.log(`checkUserAndRedirect called. User: ${user ? user.uid : "None"}. Email Verified: ${user ? user.emailVerified : "N/A"}.`);
            
            // Prevent redundant runs for stable auth state (e.g., if onAuthStateChanged fires multiple times for same user state)
            if (hasRunInitialAuthCheck && user === auth.currentUser) {
                console.log("checkUserAndRedirect: State unchanged or already processed, skipping redundant logic.");
                return;
            }
            hasRunInitialAuthCheck = true; // Mark as having started processing the initial auth state.

            // Hide the initial loading indicator once auth check begins.
            if (loadStatusElement) {
                loadStatusElement.style.display = 'none'; 
                console.log("Diagnostic: Initial loading message hidden (UI transition begins).");
            }

            if (user && user.emailVerified) {
                // User is logged in and email is verified. Proceed to main app.
                currentUser = user; 
                console.log(`User ${user.uid} is authenticated and verified. Loading user profile.`);
                try {
                    const userDocRef = db.collection('users').doc(currentUser.uid);
                    const userDoc = await userDocRef.get();
                    const userData = userDoc.data();

                    // Check for incomplete profile (newly registered users or those with empty username/name).
                    if (!userDoc.exists || !userData || !userData.username || userData.username === "" || !userData.name || userData.name === "") {
                        console.log("User profile incomplete (missing document or essential fields like username/name). Redirecting to profile setup.");
                        showAppContainerUI(); // Display the main app UI (where profile modal will be).
                        showScreen('profile-screen'); // Navigate to the profile tab.
                        editProfileModal.classList.remove('hidden'); // Force open the edit profile modal.
                        profileModalInstruction.textContent = "Welcome! Please complete your profile (Username and Display Name are required) to continue using the app.";
                        // Set temporary UI placeholders for incomplete profile.
                        myProfileUsername.textContent = "@NewUser"; 
                        sidebarUsername.textContent = "New User";
                        sidebarProfileAvatar.className = `profile-avatar-small ${getLogoCssClass('logo-1')}`;
                        showToast("Welcome! Please complete your profile (Username and Display Name are required).", 'info', 7000);
                    } else {
                        // Profile is complete, load regular app.
                        console.log("User profile complete. Displaying main application.");
                        loadUserProfile(currentUser.uid); 
                        showAppContainerUI(); 
                        showScreen('home-screen'); 
                        loadPosts(); // Load posts for the feed.
                        showToast("Logged in successfully!", 'success');
                    }
                } catch (firestoreError) {
                    console.error("Firebase Firestore error during user profile load:", firestoreError);
                    showToast("Error loading user profile. Check internet/Firebase Rules. Forcing logout.", 'error', 8000);
                    auth.signOut(); // Critical error, force logout.
                    showAuthContainerUI(); // Redirect to auth UI.
                }
            } else { 
                // User not logged in, or email not verified. Redirect to auth UI.
                currentUser = null; 
                console.log("No authenticated and verified user found. Redirecting to Authentication UI.");
                showAuthContainerUI(); 

                if (user && !user.emailVerified) { 
                    console.log(`User ${user.uid} is authenticated but email is NOT verified.`);
                    updateAuthStatus(loginStatus, "Please verify your email to continue. Check your inbox (or spam folder) for a verification link.", 'info');
                    auth.signOut(); // Sign out unverified users to force verification flow.
                } else {
                    console.log("No active user session found.");
                    updateAuthStatus(loginStatus, "", 'hidden'); // Clear login messages.
                }
            }
        }

        // Attach Firebase Authentication state listener
        // This will trigger `checkUserAndRedirect` every time auth state changes (load, login, logout).
        auth.onAuthStateChanged(user => {
            console.log("onAuthStateChanged fired by Firebase. Passing control to checkUserAndRedirect.");
            checkUserAndRedirect(user);
        });


        // Handle authentication form UI switches and actions.
        // Password Visibility Toggle for input fields
        document.querySelectorAll('.password-toggle').forEach(toggle => {
            toggle.addEventListener('click', () => {
                const targetId = toggle.dataset.target; 
                const targetInput = document.getElementById(targetId);
                const icon = toggle.querySelector('i');

                if (targetInput.type === 'password') {
                    targetInput.type = 'text'; 
                    icon.classList.replace('fa-eye', 'fa-eye-slash'); 
                } else {
                    targetInput.type = 'password'; 
                    icon.classList.replace('fa-eye-slash', 'fa-eye'); 
                }
            });
        });

        // Form switching (Login <-> Sign Up)
        showSignupLink.addEventListener('click', (e) => {
            e.preventDefault();
            loginScreen.classList.remove('active');
            signupScreen.classList.add('active');
            updateAuthStatus(loginStatus, '', 'hidden'); 
            updateAuthStatus(signupStatus, '', 'hidden');
            console.log("UI: Switched to Signup screen.");
        });

        showLoginLink.addEventListener('click', (e) => {
            e.preventDefault();
            signupScreen.classList.remove('active');
            loginScreen.classList.add('active');
            updateAuthStatus(loginStatus, '', 'hidden');
            updateAuthStatus(signupStatus, '', 'hidden');
            console.log("UI: Switched to Login screen.");
        });

        // Forgot Password modal handlers
        forgotPasswordLink.addEventListener('click', (e) => {
            e.preventDefault();
            forgotPasswordModal.classList.remove('hidden'); 
            updateAuthStatus(resetStatus, '', 'hidden');
            resetEmailInput.value = '';
            console.log("UI: Displayed Forgot Password modal.");
        });

        closeResetModalBtn.addEventListener('click', () => {
            forgotPasswordModal.classList.add('hidden');
            console.log("UI: Closed Forgot Password modal.");
        });

        // Attach event listeners for auth buttons (Login, Sign Up, Send Reset Email)
        loginBtn.addEventListener('click', signInUser);
        signupBtn.addEventListener('click', registerUser);
        sendResetEmailBtn.addEventListener('click', sendPasswordReset);


        // User Sign-in Function
        async function signInUser() {
            if (isProcessingAuth) { 
                console.warn("Auth process already ongoing. Skipping re-request.");
                return;
            }
            isProcessingAuth = true; 
            loginBtn.disabled = true; 

            const email = loginEmailInput.value.trim();
            const password = loginPasswordInput.value.trim();

            if (!email || !password) {
                updateAuthStatus(loginStatus, "Please enter both email and password.", 'error');
                isProcessingAuth = false; 
                loginBtn.disabled = false; 
                return;
            }

            try {
                console.log(`Attempting user sign-in for: ${email}`);
                updateAuthStatus(loginStatus, "Logging in...", 'info');
                await auth.signInWithEmailAndPassword(email, password);
                // Success: `onAuthStateChanged` will automatically handle UI redirection.
                console.log("Firebase signInWithEmailAndPassword succeeded.");
                loginEmailInput.value = ''; 
                loginPasswordInput.value = '';
            } catch (error) {
                console.error("Firebase Sign-in error:", error.code, error.message);
                let errorMessage = "Login failed. Please check your email and password.";
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                    errorMessage = "Invalid email or password. Please try again.";
                } else if (error.code === 'auth/too-many-requests') {
                    errorMessage = "Too many failed login attempts. Please try again later.";
                } else if (error.code === 'auth/network-request-failed') {
                    errorMessage = "Network error. Check your internet connection.";
                } else if (error.code === 'auth/user-disabled') {
                    errorMessage = "Your account has been disabled. Contact support.";
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = "Invalid email format. Please check.";
                } else if (error.code === 'auth/internal-error') {
                    errorMessage = "Server error. Please try again later.";
                }
                updateAuthStatus(loginStatus, errorMessage, 'error');
            } finally {
                isProcessingAuth = false; 
                loginBtn.disabled = false; 
            }
        }

        // User Registration Function
        async function registerUser() {
            if (isProcessingAuth) { 
                console.warn("Authentication process already ongoing. Skipping re-request.");
                return;
            }
            isProcessingAuth = true; 
            signupBtn.disabled = true; // Disable signup button.

            const email = signupEmailInput.value.trim();
            const password = signupPasswordInput.value.trim();
            const confirmPassword = signupConfirmPasswordInput.value.trim();

            if (!email || !password || !confirmPassword) {
                updateAuthStatus(signupStatus, "All fields are required.", 'error');
                isProcessingAuth = false;
                signupBtn.disabled = false;
                return;
            }
            if (password.length < 6) {
                updateAuthStatus(signupStatus, "Password must be at least 6 characters long.", 'error');
                isProcessingAuth = false;
                signupBtn.disabled = false;
                return;
            }
            if (password !== confirmPassword) {
                updateAuthStatus(signupStatus, "Passwords do not match.", 'error');
                isProcessingAuth = false;
                signupBtn.disabled = false;
                return;
            }

            try {
                console.log("Attempting user registration for:", email);
                updateAuthStatus(signupStatus, "Registering user...", 'info');
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                await userCredential.user.sendEmailVerification(); 

                // Create initial user document in Firestore with placeholder data.
                await db.collection('users').doc(userCredential.user.uid).set({
                    uid: userCredential.user.uid,
                    email: userCredential.user.email,
                    username: "", // User sets this later in profile edit.
                    name: "",     // User sets this later.
                    bio: "", 
                    whatsapp: "", 
                    instagram: "", 
                    profileLogo: getRandomLogoClass(), // Assign a random default logo.
                    profilePicUrl: "", 
                    isPrivate: false, 
                    followers: [], 
                    following: [], 
                    followersCount: 0, 
                    followingCount: 0, 
                    postCount: 0, 
                    monetizedViewsCount: 0, 
                    unmonetizedViewsCount: 0, 
                    earnedAmount: 0.00, 
                    reposts: [], 
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                console.log("User registered and initial profile doc created. Verification email sent.");
                updateAuthStatus(signupStatus, "Registration successful! Please verify your email.", 'success');
                signupEmailInput.value = '';
                signupPasswordInput.value = '';
                signupConfirmPasswordInput.value = '';
                // After successful registration, switch to login screen for verification instructions.
                showAuthScreen('login'); 
                updateAuthStatus(loginStatus, "Registered! Check your inbox (or spam) to verify email, then login.", 'info');

            } catch (error) {
                console.error("Firebase Registration error:", error.code, error.message);
                let errorMessage = "Registration failed.";
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = "This email is already in use. Please log in instead.";
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = "Invalid email format. Please check.";
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = "Password is too weak (min 6 chars).";
                } else if (error.code === 'auth/network-request-failed') {
                    errorMessage = "Network error during registration. Check internet.";
                }
                updateAuthStatus(signupStatus, errorMessage, 'error');
            } finally {
                isProcessingAuth = false; 
                signupBtn.disabled = false; 
            }
        }

        // Send Password Reset Function
        async function sendPasswordReset() {
            if (isProcessingAuth) {
                console.warn("Auth process already ongoing. Skipping re-request.");
                return;
            }
            isProcessingAuth = true;
            sendResetEmailBtn.disabled = true; // Disable button.

            const email = resetEmailInput.value.trim();
            if (!email) {
                updateAuthStatus(resetStatus, "Please enter your email.", 'error');
                isProcessingAuth = false;
                sendResetEmailBtn.disabled = false;
                return;
            }

            try {
                console.log("Sending password reset email for:", email);
                await auth.sendPasswordResetEmail(email);
                updateAuthStatus(resetStatus, "Password reset link sent to your email! Please check your inbox.", 'success');
            } catch (error) {
                console.error("Firebase Forgot password error:", error.code, error.message);
                let errorMessage = "Failed to send reset link.";
                if (error.code === 'auth/user-not-found') {
                    errorMessage = "No account found with that email address.";
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = "Invalid email format. Please check.";
                } else if (error.code === 'auth/network-request-failed') {
                    errorMessage = "Network error. Check your internet connection.";
                }
                updateAuthStatus(resetStatus, errorMessage, 'error');
            } finally {
                isProcessingAuth = false;
                sendResetEmailBtn.disabled = false; // Re-enable button.
            }
        }

        // Handle user logout
        document.getElementById('logout-btn').addEventListener('click', async () => {
            try {
                console.log("Attempting user logout.");
                await auth.signOut();
                showToast("Logged out successfully.", 'info');

                // Clear all input fields and reset state for a fresh start.
                loginEmailInput.value = ''; loginPasswordInput.value = '';
                signupEmailInput.value = ''; signupPasswordInput.value = ''; signupConfirmPasswordInput.value = '';
                editUsernameInput.value = ''; editNameInput.value = ''; editBioInput.value = '';
                editWhatsappInput.value = ''; editInstagramInput.value = ''; profilePicUrlInput.value = '';
                
                // Reset flag for onAuthStateChanged so it runs full check next time.
                hasRunInitialAuthCheck = false; 

                // UI redirection handled automatically by `onAuthStateChanged`.
            } catch (error) {
                console.error("Error during logout:", error);
                showToast("Failed to log out. Please try again.", 'error');
            }
        });


        // --- Initial App Load Trigger (DOMContentLoaded event) ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOMContentLoaded fired. Beginning app initialization.");
            
            // 1. Initially hide main app and auth UI.
            appContainer.classList.add('hidden'); 
            authContainer.classList.add('hidden'); 

            // 2. Display the 'load-status' message as first visual feedback.
            if (loadStatusElement) {
                loadStatusElement.textContent = "Loading Application...";
                loadStatusElement.style.display = 'block'; 
                console.log("Diagnostic: 'load-status' visible.");
            } else {
                console.warn("Diagnostic: 'load-status' element not found.");
            }

            // 3. Set a brief timeout for initial DOM rendering stability.
            // After this, initiate the Firebase auth check via onAuthStateChanged.
            setTimeout(() => {
                console.log("Initial DOM render buffer (100ms) passed. Kicking off Firebase auth check.");
                // `onAuthStateChanged` is already listening and will call `checkUserAndRedirect` soon.
                // We rely on onAuthStateChanged to pick up the state.
            }, 100); 

            // 4. Set a fallback timeout. If onAuthStateChanged is very slow/fails (rare but critical),
            // this ensures the UI eventually transitions, preventing a stuck blank screen.
            setTimeout(() => {
                if (!hasRunInitialAuthCheck) { 
                    console.warn("Fallback: Forced auth check due to timeout. UI will proceed.");
                    checkUserAndRedirect(auth.currentUser); 
                }
            }, 3000); // Max 3s for initial UI display.
        });


        // --- Data Saver Toggle Functionality ---
        document.getElementById('data-saver-checkbox').addEventListener('change', (e) => {
            dataSaverEnabled = e.target.checked;
            showToast(`Data Saver ${dataSaverEnabled ? 'Enabled' : 'Disabled'}`, 'info');
        });


        // --- Dark Mode Toggle Functionality ---
        darkModeCheckbox.addEventListener('change', (e) => {
            if (e.target.checked) {
                body.classList.add('dark-mode');
                body.classList.remove('light-mode');
                localStorage.setItem('theme', 'dark'); 
            } else {
                body.classList.remove('dark-mode');
                body.classList.add('light-mode');
                localStorage.setItem('theme', 'light'); 
            }
            showToast(`Dark Mode ${e.target.checked ? 'Enabled' : 'Disabled'}`, 'info');
        });

        // Apply initial theme from localStorage (runs on DOMContentLoaded).
        document.addEventListener('DOMContentLoaded', () => { 
            const savedTheme = localStorage.getItem('theme') || 'dark'; 
            if (savedTheme === 'light') {
                body.classList.remove('dark-mode');
                body.classList.add('light-mode');
                darkModeCheckbox.checked = false; 
            } else {
                body.classList.add('dark-mode');
                body.classList.remove('light-mode');
                darkModeCheckbox.checked = true; 
            }
        });


        // --- Sidebar Navigation Control ---
        menuToggle.addEventListener('click', () => { sidebar.classList.add('open'); });
        closeSidebarBtn.addEventListener('click', () => { sidebar.classList.remove('open'); });

        sidebar.querySelectorAll('ul li a').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const screenId = e.currentTarget.dataset.screen;
                if (screenId) {
                    showScreen(`${screenId}-screen`); 
                    if (screenId === 'profile') { loadUserProfile(currentUser.uid); } 
                    else if (screenId === 'messages') { loadRecentChats(); } 
                    else if (screenId === 'home') { postsFeed.innerHTML = ''; lastVisiblePost = null; loadPosts(); } 
                    else if (screenId === 'feed') { console.log("Immersive Feed placeholder for now."); } // Implement immersive feed logic later
                    else if (screenId === 'monetization') { loadEarningsPage(); } 
                }
                sidebar.classList.remove('open'); 
            });
        });


        // --- Bottom Navigation Control ---
        bottomNavItems.forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                const screenId = e.currentTarget.dataset.screen;
                showScreen(`${screenId}-screen`); 

                if (screenId === 'profile') { loadUserProfile(currentUser.uid); } 
                else if (screenId === 'messages') { loadRecentChats(); } 
                else if (screenId === 'home') { postsFeed.innerHTML = ''; lastVisiblePost = null; loadPosts(); } 
                else if (screenId === 'search') { /* clear/reset search */ } 
                else if (screenId === 'upload') { /* clear upload form */ }
            });
        });


        // --- Post Loading and Infinite Scrolling (Home Feed) ---
        postCategoryFilter.addEventListener('change', () => {
            postsFeed.innerHTML = ''; 
            lastVisiblePost = null; 
            loadPosts(); 
        });

        async function loadPosts() {
            if (!currentUser || fetchingPosts) { console.log("loadPosts: Skipping (no user or fetching)."); return; }
            fetchingPosts = true; loadingSpinner.classList.remove('hidden'); console.log("loadPosts: Starting post fetch.");

            try {
                let postsBaseRef = db.collection('posts').where('expiryTime', '>', firebase.firestore.Timestamp.now()).orderBy('expiryTime', 'desc').orderBy('timestamp', 'desc');
                const selectedCategory = postCategoryFilter.value;
                if (selectedCategory !== 'all') { postsBaseRef = postsBaseRef.where('category', '==', selectedCategory); }
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                const followedUsers = userDoc.data().following || [];

                let fetchedPosts = [];
                // Fetch from followed users
                if (followedUsers.length > 0) {
                    const chunkSize = 10; for (let i = 0; i < followedUsers.length; i += chunkSize) {
                        const chunk = followedUsers.slice(i, i + chunkSize);
                        const followedSnapshot = await postsBaseRef.where('userId', 'in', chunk).limit(postsToLoadPerScroll * 2).get();
                        followedSnapshot.docs.forEach(doc => { if (!fetchedPosts.some(p => p.id === doc.id)) { fetchedPosts.push({ id: doc.id, ...doc.data() }); } });
                    }
                }
                // Fetch general public posts to fill or if no followed posts
                let generalPostsRef = postsBaseRef.where('isPrivate', '==', false);
                if (lastVisiblePost && (followedUsers.length === 0 || fetchedPosts.length < postsToLoadPerScroll)) { generalPostsRef = generalPostsRef.startAfter(lastVisiblePost); }
                const generalPostsSnapshot = await generalPostsRef.limit(postsToLoadPerScroll).get();
                generalPostsSnapshot.docs.forEach(doc => { if (!fetchedPosts.some(p => p.id === doc.id)) { fetchedPosts.push({ id: doc.id, ...doc.data() }); } });
                if (!generalPostsSnapshot.empty) { lastVisiblePost = generalPostsSnapshot.docs[generalPostsSnapshot.docs.length - 1]; }


                // Filter out already displayed posts for fresh render logic
                const alreadyDisplayedPostIds = new Set(Array.from(postsFeed.children).map(el => el.dataset.postId));
                let newPostsToRender = fetchedPosts.filter(post => !alreadyDisplayedPostIds.has(post.id));

                // Loop if no new unique posts (and there are posts in DB to cycle through)
                if (newPostsToRender.length === 0 && fetchedPosts.length > 0 && postsFeed.children.length > 0) {
                    showToast("No new unique posts. Looping feed...", 'info', 3000);
                    lastVisiblePost = null; postsFeed.innerHTML = ''; fetchingPosts = false; return loadPosts();
                } else if (newPostsToRender.length === 0 && postsFeed.children.length === 0) {
                    showToast("No posts available. Upload one!", 'info', 5000); postsFeed.innerHTML = '<p style="text-align: center; color: #ccc;">No posts available.</p>';
                    loadingSpinner.classList.add('hidden'); fetchingPosts = false; return;
                } else if (newPostsToRender.length === 0) { /* already displayed, no new message needed */ loadingSpinner.classList.add('hidden'); fetchingPosts = false; return; }

                // Clear feed only on full loop or initial empty state
                if (lastVisiblePost === null && postsFeed.innerHTML.trim() !== '' && !newPostsToRender.some(p => !alreadyDisplayedPostIds.has(p.id))) {
                    postsFeed.innerHTML = ''; 
                }

                // Render with random layouts
                let tempPostsForRendering = [...newPostsToRender];
                while (tempPostsForRendering.length > 0) {
                    const randomLayout = Math.floor(Math.random() * 3); 
                    const post = tempPostsForRendering.shift();

                    if (randomLayout === 0 || tempPostsForRendering.length < 4) { renderPost(post, postsFeed, 'vertical-post'); } 
                    else if (randomLayout === 1 && tempPostsForRendering.length >= 2) { 
                        const numHorizontal = Math.min(tempPostsForRendering.length, Math.floor(Math.random() * 2) + 2);
                        const horizontalContainer = document.createElement('div'); horizontalContainer.className = 'horizontal-post-container';
                        for (let i = 0; i < numHorizontal; i++) { horizontalContainer.appendChild(createPostElement(tempPostsForRendering.shift(), 'horizontal-post')); }
                        postsFeed.appendChild(horizontalContainer);
                    } else if (randomLayout === 2 && tempPostsForRendering.length >= 4) { 
                        const numTable = Math.min(tempPostsForRendering.length, Math.floor(Math.random() * 3) + 4);
                        const tableContainer = document.createElement('div'); tableContainer.className = 'table-post-container';
                        for (let i = 0; i < numTable; i++) { tableContainer.appendChild(createPostElement(tempPostsForRendering.shift(), 'table-post')); }
                        postsFeed.appendChild(tableContainer);
                    } else { renderPost(post, postsFeed, 'vertical-post'); }
                }
            } catch (error) { console.error("Error loading posts:", error); showToast("Error loading posts.", 'error');
            } finally { loadingSpinner.classList.add('hidden'); fetchingPosts = false; }
        }

        function createPostElement(postData, layoutClass = 'vertical-post') {
            const postCard = document.createElement('div');
            postCard.className = `post-card ${layoutClass}`;
            postCard.dataset.postId = postData.id;
            postCard.dataset.userId = postData.userId; 

            const isOwner = currentUser && postData.userId === currentUser.uid;
            const hasLiked = postData.likedBy && currentUser && postData.likedBy.includes(currentUser.uid);
            const likeIconClass = hasLiked ? 'fas fa-heart' : 'far fa-heart';

            const userAvatarHtml = postData.profilePicUrl 
                ? `<div class="profile-avatar" style="background-image: url('${postData.profilePicUrl}');"></div>`
                : `<div class="profile-avatar ${getLogoCssClass(postData.userProfileLogo || getRandomLogoClass())}"></div>`;
            
            const postContentHtml = `
                <p data-original-content="${escapeHtml(postData.content)}">${formatPostContent(postData.content)}</p>
            `;
            // Simplified monetization logic (no Adsense actual embed as this is single-file JS/HTML only)
            const monetizedTag = postData.isMonetized ? `<div class="monetized-tag" style="background-color: green; color: white; padding: 2px 5px; border-radius: 3px; font-size: 0.8em; margin-left: 10px;">$</div>` : '';


            postCard.innerHTML = `
                <div class="post-header">
                    ${userAvatarHtml}
                    <span class="username" data-user-id="${postData.userId}">@${postData.username || 'Unknown'}</span>
                    ${monetizedTag}
                    <div class="post-options">
                        <i class="fas fa-ellipsis-v"></i>
                        <div class="options-dropdown hidden">
                            <span class="report-btn">Report</span>
                            <span class="copy-link-btn">Copy Post Link</span>
                            <span class="remix-btn" data-original-post-id="${postData.id}" data-original-content="${escapeHtml(postData.content)}">Remix Post</span>
                            <span class="change-lang-btn">Change Translation Language</span>
                            ${isOwner ? `<span class="delete-btn">Delete</span>` : ''}
                        </div>
                    </div>
                </div>
                <div class="post-content">
                    ${postContentHtml}
                </div>
                <div class="post-footer">
                    <div class="post-actions">
                        <span class="like-button"><i class="${likeIconClass}"></i> <span class="like-count">${formatNumber(postData.likesCount || 0)}</span></span>
                        <span class="views-count"><i class="fas fa-eye"></i> <span class="view-count-num">${formatNumber(postData.views || 0)}</span></span>
                        <span class="translate-button"><i class="fas fa-language"></i></span>
                        <span class="speak-button" data-speaking="false"><i class="fas fa-volume-up"></i></span>
                    </div>
                    <div class="post-reactions" data-post-id="${postData.id}">
                        ${renderEmojiReactions(postData.reactions)}
                        <span class="total-reactions">${formatNumber(Object.values(postData.reactions || {}).reduce((a, b) => a + b, 0))} reactions</span>
                    </div>
                </div>
                <div class="emoji-picker hidden">
                    <span class="emoji-option" data-emoji=""></span><span class="emoji-option" data-emoji=""></span>
                    <span class="emoji-option" data-emoji=""></span><span class="emoji-option" data-emoji=""></span>
                    <span class="emoji-option" data-emoji=""></span>
                </div>
            `;
            addPostEventListeners(postCard, postData);
            return postCard;
        }

        function renderPost(postData, parentElement, layoutClass = 'vertical-post') {
            const postElement = createPostElement(postData, layoutClass);
            parentElement.appendChild(postElement);
        }

        function formatPostContent(content) {
            let formattedContent = escapeHtml(content); // Escape HTML initially

            // Markdown-like bold, italic
            formattedContent = formattedContent.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
            formattedContent = formattedContent.replace(/\*(.*?)\*/g, '<i>$1</i>');

            // Embed Images: ![alt](URL)
            formattedContent = formattedContent.replace(/!\[(.*?)\]\((https?:\/\/[^\s]+)\)/g, (match, alt, url) => {
                // Validate common image extensions if needed, but not critical for simple demo.
                return `<img src="${url}" alt="${alt}" style="max-width:100%; height:auto; border-radius:8px; margin-top:10px;">`;
            });

            // Embed YouTube: ![youtube video](VIDEO_ID or full URL)
            formattedContent = formattedContent.replace(/!\[youtube video\]\((?:https?:\/\/)?(?:www\.)?(?:youtube\.com|youtu\.be)\/(?:watch\?v=|embed\/|v\/|)([\w-]{11})(?:\S+)?\)/gi, (match, videoId) => {
                return `<iframe src="https://www.youtube.com/embed/${videoId}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen style="width:100%; aspect-ratio:16/9; border-radius:8px; margin-top:10px;"></iframe>`;
            });

            // Convert raw URLs into clickable links (basic URL detection)
            formattedContent = formattedContent.replace(/(?<!["'])((https?:\/\/[^\s<>"']+)|(www\.[^\s<>"']+))(?![])]/g, (match) => {
                const href = match.startsWith('http') ? match : `http://${match}`;
                return `<a href="${href}" target="_blank" style="color:#00ffff; text-decoration:underline;">${match}</a>`;
            });

            // Add paragraphs and line breaks if content contains newlines (unless it's already structured by embeds)
            if (!formattedContent.includes('<img') && !formattedContent.includes('<iframe') && !formattedContent.includes('<b') && !formattedContent.includes('<i')) {
                formattedContent = `<p>${formattedContent.split('\n').join('<br>')}</p>`;
            } else {
                formattedContent = formattedContent.split('\n').join('<br>');
            }

            return formattedContent;
        }


        function renderEmojiReactions(reactions) {
            if (!reactions) return '';
            const topEmojis = Object.entries(reactions)
                .filter(([, count]) => count > 0)
                .sort(([, a], [, b]) => b - a)
                .slice(0, 3);
            
            let html = '<span class="emoji-reaction-display">';
            topEmojis.forEach(([emoji, count]) => {
                html += `<span class="emoji">${emoji}</span><span class="count">${formatNumber(count)}</span>`;
            });
            html += '</span>';
            return html;
        }

        let lastClickTime = 0;
        let clickTimer;
        let longPressTimer;
        let currentNeonPost = null;

        function addPostEventListeners(postElement, postData) {
            const postId = postData.id;
            const likeButton = postElement.querySelector('.like-button');
            const postOptionsBtn = postElement.querySelector('.post-options .fa-ellipsis-v');
            const optionsDropdown = postElement.querySelector('.options-dropdown');
            const reportBtn = postElement.querySelector('.report-btn');
            const deleteBtn = postElement.querySelector('.delete-btn');
            const copyLinkBtn = postElement.querySelector('.copy-link-btn');
            const remixBtn = postElement.querySelector('.remix-btn');
            const translateBtn = postElement.querySelector('.translate-button');
            const speakBtn = postElement.querySelector('.speak-button');
            const profileAvatar = postElement.querySelector('.profile-avatar');
            const usernameSpan = postElement.querySelector('.username');
            const emojiPicker = postElement.querySelector('.emoji-picker');
            const postContentP = postElement.querySelector('.post-content p[data-original-content]'); // Only select if post has original content

            if (profileAvatar) {
                profileAvatar.addEventListener('click', (e) => {
                    e.stopPropagation();
                    openUserProfile(postData.userId);
                });
            }
            if (usernameSpan) {
                usernameSpan.addEventListener('click', (e) => {
                    e.stopPropagation();
                    openUserProfile(postData.userId);
                });
            }

            postElement.addEventListener('click', (e) => {
                // Don't trigger double click/neon effect if interactive elements or links clicked
                if (e.target.closest('.like-button') || e.target.closest('.post-options') || e.target.closest('.translate-button') || e.target.closest('.speak-button') || e.target.closest('.emoji-picker') || e.target.closest('.profile-avatar') || e.target.closest('.username') || e.target.closest('a')) {
                    return; 
                }

                const currentTime = new Date().getTime();
                const timeDiff = currentTime - lastClickTime;

                if (timeDiff < 300 && timeDiff > 0) { // Double click detected (within 300ms)
                    clearTimeout(clickTimer);
                    handleLike(postId, postElement);
                    lastClickTime = 0;
                } else { // Single click (will delay to check for double click)
                    clearTimeout(clickTimer);
                    clickTimer = setTimeout(() => {
                        handleNeonEffect(postElement);
                    }, 300);
                }
                lastClickTime = currentTime;
            });

            // Long press for emoji reactions (mobile)
            postElement.addEventListener('touchstart', (e) => {
                if (e.target.closest('.like-button') || e.target.closest('.post-options') || e.target.closest('.translate-button') || e.target.closest('.speak-button') || e.target.closest('a') || e.target.closest('.profile-avatar') || e.target.closest('.username')) {
                    return;
                }
                e.preventDefault(); 
                clearTimeout(clickTimer); 
                longPressTimer = setTimeout(() => {
                    emojiPicker.classList.remove('hidden'); 
                }, 800); // 800ms for long press
            }, { passive: false }); 

            postElement.addEventListener('touchend', () => {
                clearTimeout(longPressTimer); 
            });

            // Context menu event (for desktop right-click)
            postElement.addEventListener('contextmenu', (e) => {
                e.preventDefault(); 
                emojiPicker.classList.remove('hidden'); 
            });

            // Hide emoji picker if clicked outside of post or emoji picker itself
            document.addEventListener('click', (e) => {
                if (emojiPicker && !emojiPicker.contains(e.target) && !postElement.contains(e.target)) {
                    emojiPicker.classList.add('hidden');
                }
            });

            // Emoji options click handling
            emojiPicker.querySelectorAll('.emoji-option').forEach(emojiOption => {
                emojiOption.addEventListener('click', async (e) => {
                    const selectedEmoji = e.target.dataset.emoji;
                    await handleEmojiReaction(postId, selectedEmoji, postElement);
                    emojiPicker.classList.add('hidden');
                });
            });

            // Post actions (like, report, etc.)
            if (likeButton) {
                likeButton.addEventListener('click', (e) => {
                    e.stopPropagation(); 
                    handleLike(postId, postElement);
                });
            }

            if (postOptionsBtn) {
                postOptionsBtn.addEventListener('click', (e) => {
                    e.stopPropagation(); 
                    optionsDropdown.classList.toggle('hidden'); 
                });
                document.addEventListener('click', (e) => { 
                    if (optionsDropdown && !postOptionsBtn.contains(e.target) && !optionsDropdown.contains(e.target)) {
                        optionsDropdown.classList.add('hidden');
                    }
                });
            }

            if (reportBtn) {
                reportBtn.addEventListener('click', () => {
                    handleReportPost(postId);
                    optionsDropdown.classList.add('hidden');
                });
            }

            if (copyLinkBtn) {
                copyLinkBtn.addEventListener('click', () => {
                    handleCopyPostLink(postId);
                    optionsDropdown.classList.add('hidden');
                });
            }

            if (remixBtn) {
                remixBtn.addEventListener('click', (e) => {
                    const originalPostId = e.target.dataset.originalPostId;
                    const originalContent = e.target.dataset.originalContent;
                    handleRemixPost(originalPostElement, originalPostId, originalContent); 
                    optionsDropdown.classList.add('hidden');
                });
            }

            if (changeLangBtn) {
                changeLangBtn.addEventListener('click', () => {
                    showLanguageSelectModal(); 
                    optionsDropdown.classList.add('hidden');
                });
            }

            if (deleteBtn) {
                deleteBtn.addEventListener('click', () => {
                    handleDeletePost(postId, postElement);
                    optionsDropdown.classList.add('hidden');
                });
            }

            if (translateBtn) {
                translateBtn.addEventListener('click', (e) => {
                    e.stopPropagation(); 
                    if (postContentP) { 
                        handleTranslatePost(postContentP, userSelectedTranslationLanguage);
                    } else {
                        showToast("Content for translation not found.", 'error');
                    }
                });
            }
            if (speakBtn) {
                speakBtn.addEventListener('click', (e) => {
                    e.stopPropagation(); 
                    const postText = postContentP ? postContentP.textContent : ''; 
                    if (postText) {
                        handleSpeakPost(postText, speakBtn);
                    } else {
                        showToast("No content to speak.", 'error');
                    }
                });
            }

            incrementViewCount(postId); // Increment view count for the post.
        }

        function handleNeonEffect(postElement) {
            if (currentNeonPost && currentNeonPost !== postElement) {
                currentNeonPost.classList.remove('neon-glow');
            }
            postElement.classList.add('neon-glow'); 
            currentNeonPost = postElement;

            setTimeout(() => {
                if (postElement) { 
                    postElement.classList.remove('neon-glow');
                    if (currentNeonPost === postElement) {
                        currentNeonPost = null;
                    }
                }
            }, 3500);
        }

        async function handleLike(postId, postElement) {
            if (!currentUser) { showToast("Please log in to like posts.", 'info'); return; }

            const likeButtonIcon = postElement.querySelector('.like-button i');
            const likeCountSpan = postElement.querySelector('.like-button .like-count');

            try {
                const postRef = db.collection('posts').doc(postId);
                const postDoc = await postRef.get();
                if (!postDoc.exists) { showToast("Post not found.", 'error'); return; }

                const postData = postDoc.data();
                const likedBy = postData.likedBy || []; 

                let newLikes = postData.likes || 0;
                let action = '';

                if (likedBy.includes(currentUser.uid)) {
                    newLikes = Math.max(0, newLikes - 1); 
                    likeButtonIcon.classList.remove('fas');
                    likeButtonIcon.classList.add('far');
                    action = 'remove';
                } else {
                    newLikes++;
                    likeButtonIcon.classList.remove('far');
                    likeButtonIcon.classList.add('fas');
                    action = 'add';
                }

                await db.runTransaction(async (transaction) => {
                    const updatedLikedBy = action === 'add' ? firebase.firestore.FieldValue.arrayUnion(currentUser.uid) : firebase.firestore.FieldValue.arrayRemove(currentUser.uid);
                    transaction.update(postRef, { likes: newLikes, likedBy: updatedLikedBy });
                });

                likeCountSpan.textContent = formatNumber(newLikes); 
                showToast(action === 'add' ? "Post liked!" : "Post unliked.", 'success');

            } catch (error) { console.error("Error liking post:", error); showToast("Failed to like/unlike post. Try again.", 'error'); }
        }

        async function handleEmojiReaction(postId, emoji, postElement) {
            if (!currentUser) { showToast("Please log in to react to posts.", 'info'); return; }

            try {
                const postRef = db.collection('posts').doc(postId);
                const postDoc = await postRef.get();
                if (!postDoc.exists) { showToast("Post not found.", 'error'); return; }

                const postData = postDoc.data();
                const currentReactions = postData.reactions || {}; 
                const userReactions = postData.userReactions || {}; 

                const existingReaction = userReactions[currentUser.uid]; 

                await db.runTransaction(async (transaction) => {
                    let updatedUserReactions = { ...userReactions }; 
                    let updatedReactionsCount = { ...currentReactions }; 

                    if (existingReaction) {
                        updatedReactionsCount[existingReaction] = (updatedReactionsCount[existingReaction] || 1) - 1;
                        if (updatedReactionsCount[existingReaction] <= 0) { delete updatedReactionsCount[existingReaction]; }
                    }

                    if (existingReaction === emoji) { delete updatedUserReactions[currentUser.uid]; } 
                    else { updatedReactionsCount[emoji] = (updatedReactionsCount[emoji] || 0) + 1; updatedUserReactions[currentUser.uid] = emoji; }

                    transaction.update(postRef, { reactions: updatedReactionsCount, userReactions: updatedUserReactions });
                });

                const updatedPostDoc = await postRef.get();
                const updatedPostData = updatedPostDoc.data();
                
                const emojiReactionDisplayElement = postElement.querySelector('.emoji-reaction-display');
                const totalReactionsElement = postElement.querySelector('.total-reactions');
                
                emojiReactionDisplayElement.innerHTML = renderEmojiReactions(updatedPostData.reactions);
                totalReactionsElement.textContent = `${formatNumber(Object.values(updatedPostData.reactions || {}).reduce((a, b) => a + b, 0))} reactions`;

                showToast("Emoji reaction sent!", 'success');

            } catch (error) { console.error("Error sending emoji reaction:", error); showToast("Failed to send reaction. Try again.", 'error'); }
        }

        async function incrementViewCount(postId) {
            if (!currentUser) return; 

            const sessionViewKey = `viewed_${postId}_${currentUser.uid}_session`;
            if (sessionStorage.getItem(sessionViewKey)) { return; }
            sessionStorage.setItem(sessionViewKey, 'true'); 

            const viewsRef = db.collection('postViews').doc(postId);
            const postRef = db.collection('posts').doc(postId);
            const viewCountSpan = document.querySelector(`.post-card[data-post-id="${postId}"] .view-count-num`);

            try {
                await db.runTransaction(async (transaction) => {
                    const viewsDoc = await transaction.get(viewsRef);
                    let viewsData = viewsDoc.exists ? viewsDoc.data() : { totalViews: 0, viewedBy: {} };
                    const viewedBy = viewsData.viewedBy || {};

                    const userHistoricalViewKey = currentUser.uid;

                    if (!viewedBy[userHistoricalViewKey]) { 
                        viewsData.totalViews = (viewsData.totalViews || 0) + 1; 
                        viewedBy[userHistoricalViewKey] = true; 

                        transaction.set(viewsRef, { totalViews: viewsData.totalViews, viewedBy: viewedBy }, { merge: true });

                        transaction.update(postRef, { views: firebase.firestore.FieldValue.increment(1) });

                        const postOwnerId = (await transaction.get(postRef)).data().userId; 
                        const postOwnerRef = db.collection('users').doc(postOwnerId);
                        transaction.update(postOwnerRef, { mint: firebase.firestore.FieldValue.increment(0.01) }); // Example: 0.01 Mint per unique view
                        
                        showToast(`+0.01 Mint for this view!`, 'success', 1500);

                        if (viewCountSpan) { viewCountSpan.textContent = formatNumber(viewsData.totalViews); }
                    } 
                });
            } catch (error) { console.error("Error incrementing view count:", error); showToast("Failed to increment view count.", 'error'); }
        }

        refreshPostsBtn.addEventListener('click', () => {
            postsFeed.innerHTML = ''; lastVisiblePost = null; loadPosts(); showToast("Feed refreshed!", 'info');
        });

        mainContent.addEventListener('scroll', () => {
            if (mainContent.scrollTop + mainContent.clientHeight >= mainContent.scrollHeight - 100 &&
                document.getElementById('home-screen').classList.contains('active')) { loadPosts(); }
        });


        // --- Post Upload Functionality ---
        publishPostBtn.addEventListener('click', async () => {
            if (!currentUser) { showToast("Please log in to upload posts.", 'error'); return; }

            const content = postContentInput.value.trim();
            const boostHours = parseInt(postBoostSelect.value); 
            const remixOriginalPostId = sessionStorage.getItem('remixOriginalPostId');
            const remixOriginalContent = sessionStorage.getItem('remixOriginalContent');

            if (!content) { showToast("Please enter some content for your post.", 'error'); return; }
            if (content.length < 60) { showToast("Post content must be at least 60 characters long.", 'error'); return; }
            if (content.length > 10000) { showToast("Post content cannot exceed 10,000 characters.", 'error'); return; }


            const userDocRef = db.collection('users').doc(currentUser.uid);
            const userDoc = await userDocRef.get();
            const userData = userDoc.data();

            const currentLimit = userData.postLimit || 0;
            const currentCoins = userData.coins || 0;
            const requiredLimit = 1;

            let coinCost = 0; 
            switch(boostHours) { case 18: coinCost = 10; break; case 24: coinCost = 20; break; case 30: coinCost = 30; break; default: coinCost = 0; }

            if (currentLimit < requiredLimit) { showToast("You need 1 post limit to upload. Watch an ad to earn.", 'error', 5000); showAdModal('limit', { limit: 1 }); return; }
            if (currentCoins < coinCost) { showToast(`You need ${coinCost} Coins for ${boostHours} hours boost. You have ${formatNumber(currentCoins)} C. Watch an ad to earn.`, 'error', 5000); showAdModal('coins', { coins: coinCost - currentCoins }); return; }

            // Deduct resources
            try {
                await userDocRef.update({ postLimit: firebase.firestore.FieldValue.increment(-requiredLimit), coins: firebase.firestore.FieldValue.increment(-coinCost) });
                showToast("Resources deducted successfully!", 'success');
            } catch (error) { showToast("Failed to deduct resources. Try again.", 'error'); return; }

            uploadStatus.textContent = "Uploading post..."; publishPostBtn.disabled = true;

            try {
                const imageUrl = ''; 
                const newPostRef = db.collection('posts').doc(); 

                await newPostRef.set({
                    userId: currentUser.uid, username: userData.username,
                    userProfileLogo: userData.profilePicUrl ? "" : (userData.profileLogo || getRandomLogoClass()),
                    profilePicUrl: userData.profilePicUrl || "", // Added user's profilePicUrl
                    content: content, imageUrl: imageUrl, timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    likes: 0, views: 0, reactions: {}, userReactions: {}, boostHours: boostHours,
                    expiryTime: firebase.firestore.Timestamp.fromMillis(Date.now() + (boostHours * 60 * 60 * 1000)),
                    isRemix: !!remixOriginalPostId, remixOf: remixOriginalPostId || null, remixOfContent: remixOriginalContent || null
                });

                await userDocRef.update({ postCount: firebase.firestore.FieldValue.increment(1) });

                showToast("Post uploaded successfully!", 'success');
                postContentInput.value = ''; postBoostSelect.value = '12';
                sessionStorage.removeItem('remixOriginalPostId'); sessionStorage.removeItem('remixOriginalContent');
                showScreen('home-screen'); postsFeed.innerHTML = ''; lastVisiblePost = null; loadPosts();

            } catch (error) { 
                showToast(`Failed to upload post: ${error.message}`, 'error');
                await userDocRef.update({ postLimit: firebase.firestore.FieldValue.increment(requiredLimit), coins: firebase.firestore.FieldValue.increment(coinCost) });
                showToast("Resources refunded due to upload failure.", 'info');
            } finally { publishPostBtn.disabled = false; }
        });

        // Ad Modal Logic - Simulate ad watching for rewards
        function showAdModal(purpose, details = {}) {
            currentAdPurpose = purpose; adRewardDetails = details; adModal.classList.remove('hidden'); closeAdModalBtn.disabled = true;

            const adPlaceholder = document.getElementById('ad-placeholder'); adPlaceholder.innerHTML = '<p>Simulating Ad (5 seconds)...</p><div class="loader"></div>';
            setTimeout(() => { adPlaceholder.innerHTML = '<p>Ad Completed! Click "Close Ad" to claim your reward.</p>'; closeAdModalBtn.disabled = false; }, 5000);
        }

        closeAdModalBtn.addEventListener('click', async () => { adModal.classList.add('hidden'); await processAdReward(); });

        async function processAdReward() {
            if (!currentUser) return;

            try {
                const userDocRef = db.collection('users').doc(currentUser.uid);
                let rewardMessageText = "Reward Claimed: "; let updateData = {};

                updateData.mint = firebase.firestore.FieldValue.increment(1); 
                rewardMessageText += `+1 Mint`;

                if (currentAdPurpose === 'coins') { updateData.coins = firebase.firestore.FieldValue.increment(adRewardDetails.coins || 10); rewardMessageText += `, +${adRewardDetails.coins} Coins`; } 
                else if (currentAdPurpose === 'credits') { updateData.credits = firebase.firestore.FieldValue.increment(adRewardDetails.credits || 5); rewardMessageText += `, +${adRewardDetails.credits} Credits`; } 
                else if (currentAdPurpose === 'limit') { updateData.postLimit = firebase.firestore.FieldValue.increment(adRewardDetails.limit || 1); rewardMessageText += `, +${adRewardDetails.limit} Post Limit`; } 
                else if (currentAdPurpose === 'message-credit') { updateData.credits = firebase.firestore.FieldValue.increment(adRewardDetails.credits || 1); rewardMessageText += `, +${adRewardDetails.credits} Credits for Messaging`; } 
                else if (currentAdPurpose === 'daily-reward') {
                    updateData.coins = firebase.firestore.FieldValue.increment(DAILY_REWARD.coins);
                    updateData.credits = firebase.firestore.FieldValue.increment(DAILY_REWARD.credits);
                    updateData.postLimit = firebase.firestore.FieldValue.increment(DAILY_REWARD.limit);
                    updateData.lastRewardClaim = Date.now(); 
                    rewardMessageText = `You claimed your daily bundle!\n+${DAILY_REWARD.coins} C, +${DAILY_REWARD.credits} Cr, +${DAILY_REWARD.limit} L & +1 Mint!`;
                }

                if (Object.keys(updateData).length > 0) { await userDocRef.update(updateData); showRewardPopup(rewardMessageText); showToast("Reward processed!", 'success'); } 
                else { showToast("Ad viewed, no specific reward granted.", 'info'); }

            } catch (error) { showToast("Failed to process ad reward. Try again.", 'error'); } 
            finally { currentAdPurpose = ''; adRewardDetails = {}; }
        }

        function showRewardPopup(message) { rewardMessage.textContent = message; rewardPopup.classList.remove('hidden'); }
        closeRewardPopupBtn.addEventListener('click', () => { rewardPopup.classList.add('hidden'); });

        // Withdraw Mint Modal
        withdrawCoinsBtn.addEventListener('click', async () => {
            if (!currentUser) { showToast("Please log in to withdraw Mint.", 'info'); return; }
            try {
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                const currentMint = userDoc.data().mint || 0;
                currentMintBalance.textContent = `${formatNumber(currentMint)} M`;

                if (currentMint < 1000) { showToast(`You need at least 1,000 Mint to withdraw. You have ${formatNumber(currentMint)} M.`, 'error', 5000); return; }
                withdrawModal.classList.remove('hidden');
            } catch (error) { console.error("Error checking mint balance:", error); showToast("Could not retrieve Mint balance.", 'error'); }
        });

        closeWithdrawModalBtn.addEventListener('click', () => { withdrawModal.classList.add('hidden'); });

        confirmWithdrawBtn.addEventListener('click', async () => {
            if (!currentUser) return;

            const paypalEmail = withdrawPaypalEmail.value.trim(); const realName = withdrawRealName.value.trim();
            const age = parseInt(withdrawAge.value.trim()); const dob = withdrawDob.value.trim();

            if (!paypalEmail || !realName || isNaN(age) || !dob) { showToast("Please fill all withdrawal details.", 'error', 5000); return; }
            if (age < 13) { showToast("You must be at least 13 years old to withdraw funds.", 'error'); return; }

            try {
                const userDocRef = db.collection('users').doc(currentUser.uid);
                const userDoc = await userDocRef.get();
                const userData = userDoc.data();
                const currentMint = userData.mint || 0;

                if (currentMint < 1000) { showToast(`You need at least 1,000 Mint to withdraw. You have ${formatNumber(currentMint)} M.`, 'error', 5000); return; }

                showToast("Processing withdrawal request...", 'info', 5000);
                
                await userDocRef.update({ mint: 0 }); // Reset mint after request.

                showToast("Withdrawal request submitted! You will receive an email shortly regarding your payment within 1-15 business days.", 'success', 8000);
                console.log("Withdrawal details (simulated):", {
                    userId: currentUser.uid, username: userData.username, userEmail: currentUser.email,
                    amountMint: currentMint, paypalEmail: paypalEmail, realName: realName, age: age, dob: dob, timestamp: new Date().toISOString()
                });

                withdrawModal.classList.add('hidden'); // Close modal
                withdrawPaypalEmail.value = ''; withdrawRealName.value = ''; withdrawAge.value = ''; withdrawDob.value = '';

            } catch (error) { showToast("Failed to submit withdrawal request. Try again.", 'error'); }
        });

        // Profile Management Functions
        async function loadUserProfile(userId) {
            if (!userId) return; currentProfileViewingId = userId;
            try {
                const userDoc = await db.collection('users').doc(userId).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    updateProfileDisplay(userData);
                    loadProfilePosts(userId);

                    // Logic to display follow/message buttons (same as previous)
                } else { showToast("User profile not found.", 'error'); if (userId !== currentUser.uid) { showScreen('home-screen'); } }
            } catch (error) { console.error("Error loading user profile:", error); showToast("Error loading profile. Try again.", 'error'); }
        }

        function updateProfileDisplay(userData) {
            const isCurrentUserProfile = (currentUser && userData.uid === currentUser.uid);

            myProfileUsername.textContent = `@${userData.username || 'NewUser'}`;
            myProfileName.textContent = userData.name || '';
            myProfileBio.textContent = userData.bio || '';
            currentProfileUsernamePosts.textContent = userData.username || 'Me';

            // Set avatar: direct URL or CSS generated logo
            if (userData.profilePicUrl) {
                myProfileAvatar.style.backgroundImage = `url('${userData.profilePicUrl}')`;
                myProfileAvatar.className = 'profile-avatar-large'; 
            } else {
                myProfileAvatar.style.backgroundImage = 'none'; 
                myProfileAvatar.className = `profile-avatar-large ${getLogoCssClass(userData.profileLogo || 'user-logo-default')}`; // Default if none chosen.
            }
            
            myPostsCount.textContent = formatNumber(userData.postCount || 0);
            myFollowersCount.textContent = formatNumber(userData.followersCount || 0);
            myFollowingCount.textContent = formatNumber(userData.followingCount || 0);

            if (isCurrentUserProfile) { // Populate edit modal if own profile
                editUsernameInput.value = userData.username || '';
                editNameInput.value = userData.name || '';
                editBioInput.value = userData.bio || '';
                editWhatsappInput.value = userData.whatsapp || '';
                editInstagramInput.value = userData.instagram || '';
                profilePicUrlInput.value = userData.profilePicUrl || '';
                // accountPrivacyToggle etc. 
                populateProfileLogoOptions(userData.profileLogo, userData.profilePicUrl);
            }
        }

        async function loadProfilePosts(userId) {
            profilePostsFeed.innerHTML = '<div class="loader" style="margin: 20px auto;"></div>';
            try {
                const querySnapshot = await db.collection('posts').where('userId', '==', userId)
                    .where('expiryTime', '>', firebase.firestore.Timestamp.now()).orderBy('expiryTime', 'desc').limit(10).get();
                profilePostsFeed.innerHTML = '';
                if (querySnapshot.empty) { profilePostsFeed.innerHTML = '<p style="text-align: center; color: #ccc;">No posts yet.</p>'; return; }
                querySnapshot.docs.forEach(doc => { renderPost({ id: doc.id, ...doc.data() }, profilePostsFeed); });
            } catch (error) { console.error("Error loading profile posts:", error); showToast("Error loading posts.", 'error'); profilePostsFeed.innerHTML = '<p style="text-align: center; color: red;">Error loading posts.</p>'; }
        }

        async function loadProfileReposts(userId) {
            profileRepostsFeed.innerHTML = '<div class="loader" style="margin: 20px auto;"></div>';
            try {
                const userDoc = await db.collection('users').doc(userId).get();
                const repostedPostIds = userDoc.data().reposts || [];
                profileRepostsFeed.innerHTML = '';
                if (repostedPostIds.length === 0) { profileRepostsFeed.innerHTML = '<p style="text-align: center; color: #ccc;">No reposts yet.</p>'; return; }

                const postPromises = repostedPostIds.map(id => db.collection('posts').doc(id).get());
                const postResults = await Promise.all(postPromises);

                let hasActiveReposts = false;
                postResults.forEach(result => {
                    if (result.exists && result.data().expiryTime.toMillis() > Date.now()) {
                        renderPost({ id: result.id, ...result.data() }, profileRepostsFeed);
                        hasActiveReposts = true;
                    }
                });
                if (!hasActiveReposts) { profileRepostsFeed.innerHTML = '<p style="text-align: center; color: #ccc;">No active reposts.</p>'; }
            } catch (error) { console.error("Error loading profile reposts:", error); showToast("Error loading reposts.", 'error'); profileRepostsFeed.innerHTML = '<p style="text-align: center; color: red;">Error loading reposts.</p>'; }
        }

        // Profile tab switching
        document.querySelectorAll('.profile-post-tabs .tab-btn').forEach(tab => {
            tab.addEventListener('click', (e) => {
                document.querySelectorAll('.profile-post-tabs .tab-btn').forEach(t => t.classList.remove('active'));
                e.currentTarget.classList.add('active');

                const tabType = e.currentTarget.dataset.tab;
                if (tabType === 'posts') { profilePostsFeed.classList.remove('hidden'); profileRepostsFeed.classList.add('hidden'); loadProfilePosts(currentProfileViewingId); }
                else if (tabType === 'reposts') { profilePostsFeed.classList.add('hidden'); profileRepostsFeed.classList.remove('hidden'); loadProfileReposts(currentProfileViewingId); }
            });
        });

        // Edit Profile Modal Functions
        editProfileBtn.addEventListener('click', () => { editProfileModal.classList.remove('hidden'); showToast("Edit your profile details.", 'info', 3000); updateAuthStatus(saveProfileStatus, '', 'hidden'); });
        cancelEditProfileBtn.addEventListener('click', () => { editProfileModal.classList.add('hidden'); });

        let usernameCheckTimeout;
        editUsernameInput.addEventListener('input', async () => {
            clearTimeout(usernameCheckTimeout); usernameAvailability.textContent = ''; usernameAvailability.className = '';
            const newUsername = editUsernameInput.value.trim();
            if (newUsername === '') { usernameAvailability.textContent = 'Username cannot be empty.'; usernameAvailability.classList.add('error-text'); return; }
            if (!/^[a-zA-Z0-9_.]+$/.test(newUsername) || newUsername.length < 3 || newUsername.length > 30) {
                usernameAvailability.textContent = "Username must be 3-30 chars, alphanumeric, underscore, dot only."; usernameAvailability.classList.add('error-text'); return; }

            const userDoc = await db.collection('users').doc(currentUser.uid).get();
            const currentUsername = userDoc.data().username;
            if (newUsername.toLowerCase() === (currentUsername ? currentUsername.toLowerCase() : '')) {
                usernameAvailability.textContent = 'Username is available.'; usernameAvailability.classList.add('success-text'); return; }

            usernameCheckTimeout = setTimeout(async () => {
                try {
                    const snapshot = await db.collection('users').where('username_lowercase', '==', newUsername.toLowerCase()).get();
                    if (snapshot.empty) { usernameAvailability.textContent = 'Username is available.'; usernameAvailability.classList.add('success-text'); }
                    else { usernameAvailability.textContent = 'Username already taken.'; usernameAvailability.classList.add('error-text'); }
                } catch (error) { console.error("Error checking username:", error); usernameAvailability.textContent = 'Error checking username.'; usernameAvailability.classList.add('error-text'); }
            }, 500);
        });

        // Save Profile Changes
        saveProfileBtn.addEventListener('click', async () => {
            updateAuthStatus(saveProfileStatus, '', 'hidden');
            if (!currentUser) { showToast("Error: Not logged in.", 'error'); return; }

            const newUsername = editUsernameInput.value.trim();
            const newName = editNameInput.value.trim();
            const newBio = editBioInput.value.trim();
            const newWhatsapp = editWhatsappInput.value.trim();
            const newInstagram = editInstagramInput.value.trim();
            const newProfilePicUrl = document.getElementById('profile-pic-url-input').value.trim();
            const isPrivate = document.getElementById('account-privacy-toggle').checked;

            let finalProfilePicUrl = newProfilePicUrl;
            let newProfileLogo = '';
            const selectedLogoElement = profileLogoOptions.querySelector('.logo-option-item.selected');

            if (finalProfilePicUrl) { newProfileLogo = ""; } // URL takes precedence.
            else if (selectedLogoElement && selectedLogoElement.dataset.type === 'emoji') { finalProfilePicUrl = ""; newProfileLogo = selectedLogoElement.dataset.value; }
            else { newProfileLogo = 'user-logo-default'; finalProfilePicUrl = ""; } // Default Fallback if nothing set/selected

            if (!newUsername || !/^[a-zA-Z0-9_.]+$/.test(newUsername) || newUsername.length < 3 || newUsername.length > 30) {
                updateAuthStatus(saveProfileStatus, "Username must be 3-30 chars, alphanumeric, underscore, dot only.", 'error'); return; }

            const userDocRef = db.collection('users').doc(currentUser.uid);
            const userDoc = await userDocRef.get();
            const currentData = userDoc.data();
            if (currentData && (!currentData.username || !currentData.name) && !newName) { /* No NewName when creating profile initially */ showToast("Display Name is required to complete profile setup.", 'error'); return;}

            try {
                updateAuthStatus(saveProfileStatus, "Saving profile...", 'info');
                await userDocRef.update({
                    username: newUsername, username_lowercase: newUsername.toLowerCase(),
                    name: newName, bio: newBio, whatsapp: newWhatsapp, instagram: newInstagram,
                    profileLogo: newProfileLogo, profilePicUrl: finalProfilePicUrl, isPrivate: isPrivate,
                });

                // Batch update posts with new profile info for consistency
                const postsSnapshot = await db.collection('posts').where('userId', '==', currentUser.uid).get();
                const batch = db.batch();
                postsSnapshot.docs.forEach(doc => {
                    batch.update(db.collection('posts').doc(doc.id), { username: newUsername, userProfileLogo: newProfileLogo, profilePicUrl: finalProfilePicUrl, isPrivate: isPrivate });
                });
                await batch.commit();

                editProfileModal.classList.add('hidden'); // Close modal on success
                showToast("Profile updated successfully!", 'success');
                loadUserProfile(currentUser.uid); // Reload profile page display
            } catch (error) { updateAuthStatus(saveProfileStatus, `Save failed: ${error.message}`, 'error'); }
        });

        // Follow/Unfollow Logic
        async function handleFollow(targetUserId) { /* ... same as previous ... */ }
        async function handleUnfollow(targetUserId) { /* ... same as previous ... */ }
        async function removeFollower(followerId) { /* ... same as previous ... */ }

        // Load & Show Follower/Following Lists
        document.querySelectorAll('.clickable-stat[data-stat="followers"], .clickable-stat[data-stat="following"]').forEach(stat => {
            stat.addEventListener('click', (e) => { /* ... same as previous ... */ showFollowList(currentProfileViewingId, e.currentTarget.dataset.stat); });
        });
        async function showFollowList(userId, type) { /* ... same as previous ... */ }
        closeFollowListModalBtn.addEventListener('click', () => { followListModal.classList.add('hidden'); });

        function openUserProfile(userId) {
            if (currentUser && userId === currentUser.uid) { showScreen('profile-screen'); loadUserProfile(currentUser.uid); }
            else { showScreen('profile-screen'); loadUserProfile(userId); }
        }

        // Messaging
        messageUserBtn.addEventListener('click', () => { if (!currentUser) return; openChatWindow(currentProfileViewingId); }); // Message clicked user on profile
        async function loadRecentChats() { /* ... same as previous ... */ }
        async function openChatWindow(partnerId) { /* ... same as previous ... */ }
        backToChatsBtn.addEventListener('click', () => { /* ... same as previous ... */ });
        sendMessageBtn.addEventListener('click', async () => { /* ... same as previous ... */ });


        // Search
        searchBtn.addEventListener('click', () => performSearch());
        searchQueryInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') { performSearch(); } });
        async function performSearch() { /* ... same as previous ... */ }

        // Post Options
        async function handleReportPost(postId) { /* ... same as previous ... */ }
        async function handleCopyPostLink(postId) { /* ... same as previous ... */ }
        function handleRemixPost(originalPostElement, originalPostId, originalContent) { /* ... same as previous ... */ }
        async function handleDeletePost(postId, postElement) { /* ... same as previous ... */ }

        // Translate and Speak (SpeechSynthesis)
        const AVAILABLE_LANGUAGES = [ // Updated with common codes for translate & speak simulation
            { code: 'en', name: 'English', simText: 'This is a simulated English translation.' },
            { code: 'hi', name: '', simText: '     !' },
            { code: 'es', name: 'Espaol', simText: 'Esta es una traduccin simulada al espaol!' },
            { code: 'fr', name: 'Franais', simText: 'Ceci est une traduction franaise simule !' },
            { code: 'de', name: 'Deutsch', simText: 'Dies ist eine simulierte deutsche bersetzung!' },
            { code: 'ja', name: '', simText: '' },
            { code: 'pt', name: 'Portugus', simText: 'Esta  uma traduo simulada em portugus.' },
            { code: 'ru', name: '', simText: '   .' },
            { code: 'zh', name: '', simText: '' },
            { code: 'ar', name: '', simText: '   .' }
        ];

        function showLanguageSelectModal() {
            languageOptionsContainer.innerHTML = '';
            AVAILABLE_LANGUAGES.forEach(lang => {
                const option = document.createElement('div');
                option.className = 'language-option'; option.textContent = lang.name; option.dataset.lang = lang.code; option.dataset.simText = lang.simText;
                if (lang.code === userSelectedTranslationLanguage) { option.classList.add('selected'); }
                option.addEventListener('click', () => {
                    languageOptionsContainer.querySelectorAll('.language-option').forEach(item => item.classList.remove('selected'));
                    option.classList.add('selected');
                });
                languageOptionsContainer.appendChild(option);
            });
            languageSelectModal.classList.remove('hidden');
        }

        saveLanguageBtn.addEventListener('click', () => {
            const selectedOption = languageOptionsContainer.querySelector('.language-option.selected');
            if (selectedOption) { userSelectedTranslationLanguage = selectedOption.dataset.lang; showToast(`Language set to ${selectedOption.textContent}.`, 'success'); }
            languageSelectModal.classList.add('hidden');
        });

        cancelLanguageBtn.addEventListener('click', () => { languageSelectModal.classList.add('hidden'); });

        function handleTranslatePost(postContentPElement, targetLang) {
            const originalContent = postContentPElement.dataset.originalContent;
            // Find the language info based on selected lang code
            const langInfo = AVAILABLE_LANGUAGES.find(lang => lang.code === targetLang) || AVAILABLE_LANGUAGES.find(lang => lang.code === 'en'); // Fallback to English

            // Toggle logic based on if current text is original or a translation
            if (postContentPElement.textContent === originalContent) { // Currently showing original
                postContentPElement.textContent = langInfo.simText;
                showToast(`Simulating translation to ${langInfo.name}.`, 'info');
            } else { // Currently showing translation, revert to original
                postContentPElement.textContent = originalContent;
                showToast("Reverting to original text.", 'info');
            }
        }

        function handleSpeakPost(textToSpeak, speakButtonElement) {
            if (!('speechSynthesis' in window)) { showToast("Device does not support text-to-speech.", 'error'); return; }
            if (currentSpeaker && window.speechSynthesis.speaking) {
                window.speechSynthesis.cancel();
                document.querySelectorAll('.speak-button').forEach(btn => btn.classList.remove('active')); // Reset all speaker buttons
                if (speakButtonElement.dataset.speaking === 'true') { currentSpeaker = null; showToast("Speech stopped.", 'info'); return; } // Toggle off if this button was active
            }

            const utterance = new SpeechSynthesisUtterance(textToSpeak);
            utterance.rate = 1; utterance.pitch = 1;

            const voices = window.speechSynthesis.getVoices();
            const targetVoice = voices.find(voice => voice.lang.startsWith(userSelectedTranslationLanguage)) || voices.find(voice => voice.lang.startsWith('en')) || voices[0];
            if (targetVoice) { utterance.voice = targetVoice; }

            utterance.onstart = () => { currentSpeaker = utterance; speakButtonElement.classList.add('active'); showToast("Speaking post...", 'info'); };
            utterance.onend = () => { speakButtonElement.classList.remove('active'); if (currentSpeaker === utterance) currentSpeaker = null; showToast("Speech ended.", 'info'); };
            utterance.onerror = (event) => { console.error('Speech error:', event); speakButtonElement.classList.remove('active'); if (currentSpeaker === utterance) currentSpeaker = null; showToast("Error speaking.", 'error'); };
            window.speechSynthesis.speak(utterance);
        }
    </script>
</body>
</html>
